{"componentChunkName":"component---src-templates-blog-template-js","path":"/woowacourse/level4/check_client_ip/","result":{"data":{"cur":{"id":"3a9088fb-6964-5011-97d6-18839cb91de7","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>팀원의 코드를 리뷰하고 있었는데, 아래와 같은 코드가 있었습니다.</p>\n<blockquote>\n<p>실제 코드와 다르며 내용 파악을 위해 일부 수정하였습니다.</p>\n<p>내용은 중요하지 않긴 하지만.. 간단하게만 말씀드리면 ELB에서의 헬스체크를 의도적으로 실패하도록 하는 API 입니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/terminate\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> remoteHost <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"0:0:0:0:0:0:0:1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        isTerminated<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FORBIDDEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>이 코드에서의 핵심은 <strong>클라이언트의 IP(=remoteHost)가 로컬호스트인 경우에만 OK 응답</strong>을 주겠다는 건데, 여기서 의문이 들었던 것은 “<strong>Nginx 설정과 무관하게 getRemoteHost()가 항상 실제 클라이언트의 IP를 반환할 것을 보장하는지?</strong>” 였는데요, 의문이 들었던 내용부터 실제 테스트를 하며 확인한 결과를 하나하나 작성해 보겠습니다.</p>\n<br/>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABK0lEQVQoz2WRz0oDMRCH9yW9+ga+gu8gguhFFEE8CF6ECp7EgwgelKKIKLSHCi1qt62bTJLJfpLs9o868MtMAvnyy0xR1zVzkQTLfa5jzmbYY3y5Sx0EjTUxKjHGLG3rdKegjV/g1bPYAMuXO/rb6+AM4gLWWqxIls97QUQoErmqKlZDzYQoszk2r5WxlOWMTzvlb1R+ll0maDEuS3b29jPdmApNbq4PkPuzBh48QUPmdkdvrHU2OXy6WLz1OnrkvHvEt0xx4inKcsLxySlRtemNt9RfPerJOyoGKy5/iwjPH302rrbo9G5JLzsXGE4GPAxusN4g4ihUlQRdNi4mW6B+MaQU4hzRK751Ox9IqsVbfPC5r/+H0nZtoRaqGjHW4lzjWFbknM85BOUH/K0b96vhphoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인프라_구조\"\n        title=\"인프라_구조\"\n        src=\"/static/17bf5285cfa1dbc61cd59005efc0946d/37523/architecture.png\"\n        srcset=\"/static/17bf5285cfa1dbc61cd59005efc0946d/e9ff0/architecture.png 180w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/f21e7/architecture.png 360w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/37523/architecture.png 720w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/302a4/architecture.png 1080w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/37048/architecture.png 1352w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>시작하기 전에, 이번 글에서 사용하는 인프라 구조입니다!</p>\n<br/>\n<h2 id=\"질문\" style=\"position:relative;\"><a href=\"#%EC%A7%88%EB%AC%B8\" aria-label=\"질문 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>질문</h2>\n<p>이전 문단에 나왔던 코드의 getRemoteHost() 부분에 아래와 같은 질문을 남겼었습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhElEQVQI12VOTQ/CIBTj//8/NzN4ymbCYR7G18ExoOahmCU2adrXQ/sEkYQxBuv6hLUOPgTknHEcR9PmvzczpYRaKxhdQ4zYNotSCsS+v6DnBcN4hVSEaZIgukFK1bxShHl54DKMuGsN5/xfIQ/2IcGB87Gt8wLz81n5fdmzXnAuO2eMNyZO58ERVEn+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"코드리뷰_질문\"\n        title=\"코드리뷰_질문\"\n        src=\"/static/f6e51f5433612ecbad74d64cf501da57/37523/question.png\"\n        srcset=\"/static/f6e51f5433612ecbad74d64cf501da57/e9ff0/question.png 180w,\n/static/f6e51f5433612ecbad74d64cf501da57/f21e7/question.png 360w,\n/static/f6e51f5433612ecbad74d64cf501da57/37523/question.png 720w,\n/static/f6e51f5433612ecbad74d64cf501da57/302a4/question.png 1080w,\n/static/f6e51f5433612ecbad74d64cf501da57/07a9c/question.png 1440w,\n/static/f6e51f5433612ecbad74d64cf501da57/d3b46/question.png 1690w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>찝찝했던 이유는 이전에 ELB를 사용하기 전 EC2로 직접 요청을 보냈을 때 클라이언트 정보를 읽어오지 못해 문제가 발생했던 경험이 있었기 때문인데요, 이번에 ELB를 도입하며 비슷한 문제가 발생할 수도 있겠다는 우려가 있었던 것 같습니다 ㅎㅎ</p>\n<blockquote>\n<p>당시 발생했던 문제는 getRemotePort()를 호출했을 때 실제 요청 포트(443)을 읽지 못해 Swagger-UI에서 CORS가 발생했던 것인데요, <a href=\"https://github.com/woowacourse-teams/2024-mouda/pull/506\">PR 링크</a>에서 확인하실 수 있습니다.</p>\n</blockquote>\n<br/>\n<p>시작하기 전에, 우선 <code class=\"language-text\">getRemoteHost()</code>에 어떤 값이 들어가는지부터 확인해야 할 것 같습니다. 아래 코드는 HttpServletRequets의 구현 클래스 중 하나인 Request 클래스의 메서드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Request</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">HttpServletRequest</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connector<span class=\"token punctuation\">.</span><span class=\"token function\">getEnableLookups</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n    \n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드를 보면, getRemoteHost()도 <code class=\"language-text\">getRemoteAddr()</code> (=클라이언트의 IP)를 값으로 가지는데요, 이 메서드를 호출했을 때 실제 클라이언트의 IP를 기록하려면 아래의 설정이 필요합니다.</p>\n<br/>\n<ul>\n<li><strong>필수</strong>:  Nginx 설정파일에 <code class=\"language-text\">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> 를 추가하여 X-Forwarded-For 헤더를 springboot에 전달하도록 해야 합니다d.</li>\n</ul>\n<ol>\n<li>application.yml에 <code class=\"language-text\">server.forward-headers-strategy=native</code> 과 같은 Forward 헤더를 읽는 설정을 추가한다.</li>\n<li>설정을 추가하지 않았다면, getRemoteHost()가 아니라 <code class=\"language-text\">getHeader(”X-Forwarded-For”).split(”, “)[0]</code> 으로 값을 읽어와야 한다.</li>\n</ol>\n<p>위 과정 또는 비슷한 과정을 거치지 않았다면 인스턴스 외부에서의 요청에도 getRemoteHost()를 호출했을 때의 결과가 Localhost가 될 수 있습니다. 사실 ELB가 추가된 환경에서도 클라이언트의 IP를 정확하게 읽어올 것이라고 예상되긴 하는데요, 그럼에도 잘못 호출되는 경우 서버가 터질 우려가 있기에.. 적어도 한 번은 확인해볼 필요가 있다고 생각했습니다.</p>\n<blockquote>\n<p>제 테코톡(<a href=\"https://youtu.be/oUroldyG1_s?si=osh0ER_t6s8JWUNG&#x26;t=642\">링크</a>)에서 X-Forwarded-For 헤더와 클라이언트의 IP를 기록하는 방법을 다룹니다 ㅎㅎ 아래 글이 이해가 안 가신다면 영상을 참고해주세요!</p>\n</blockquote>\n<br/>\n<h2 id=\"확인\" style=\"position:relative;\"><a href=\"#%ED%99%95%EC%9D%B8\" aria-label=\"확인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>확인</h2>\n<p>이전 문단에서 다뤘듯이, 클라이언트의 IP를 가져오려면 <strong>springboot로 가는 요청에 클라이언트의 IP가 담긴 X-Forwarded-For 헤더가 포함</strong>되어야 하는데요,</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAcklEQVQY062L6wrDIAyFff9XHIxBnXUdvZikP4ziGUbWJ2jgI+eSuBACvH9jmjyW5YtaK1QVWRWqBaUMelZ6Z74i59Hr1Q/tHs8XEhHWbUciBouAmC1jlovuRU6kRHZz2D5N/386LswRd46L8YPW2m38AJQvOOMN2pM2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ELB에서의 X-Forwarded-For 헤더 설정\"\n        title=\"ELB에서의 X-Forwarded-For 헤더 설정\"\n        src=\"/static/095d410edbfd1eedcf80b101867cf738/37523/xforwardedfor.png\"\n        srcset=\"/static/095d410edbfd1eedcf80b101867cf738/e9ff0/xforwardedfor.png 180w,\n/static/095d410edbfd1eedcf80b101867cf738/f21e7/xforwardedfor.png 360w,\n/static/095d410edbfd1eedcf80b101867cf738/37523/xforwardedfor.png 720w,\n/static/095d410edbfd1eedcf80b101867cf738/302a4/xforwardedfor.png 1080w,\n/static/095d410edbfd1eedcf80b101867cf738/67a79/xforwardedfor.png 1408w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">AWS ELB 상세 페이지 → 작업 → Load Balancer 속성 편집</code>에 있는 위 설정으로 X-Forwarded-For 헤더 설정이 가능하며, 각 항목은 다음과 같습니다.</p>\n<ul>\n<li><strong>첨부</strong>: X-Forwarded-For 헤더에 클라이언트의 IP를 저장(추가) 하여 서버로 전달</li>\n<li><strong>보존</strong>: 기존의 X-Forwarded-For를 그대로 전달</li>\n<li><strong>제거</strong>: 기존의 X-Forwarded-For가 있으면 삭제</li>\n</ul>\n<p>따라서 클라이언트의 요청을 받는 ELB에서는 해당 설정이 ‘<code class=\"language-text\">첨부</code>’로 되어 있어야 실제 클라이언트의 IP가 기록되어 전달됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrequest<span class=\"token punctuation\">.</span><span class=\"token function\">getHeaderNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">asIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">forEachRemaining</span><span class=\"token punctuation\">(</span>headerName <span class=\"token operator\">-></span> headers<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>headerName<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span>headerName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>확인은 위 코드를 이용하여 실제 요청에 있는 모든 헤더를 출력한 뒤 EC2 내부의 Nginx 설정에 따라 X-Forwarded-For 헤더가 어떻게 달라지는지, 실제 헤더가 포함되고, 클라이언트의 IP가 잘 전달되는지 확인하는게 목표입니다!</p>\n<br/>\n<h3 id=\"1-nginx-설정에-x-forwarded-for-헤더-설정이-있는-경우\" style=\"position:relative;\"><a href=\"#1-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%9E%88%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"1 nginx 설정에 x forwarded for 헤더 설정이 있는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Nginx 설정에 X-Forwarded-For 헤더 설정이 있는 경우</h3>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://localhost:8080</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nginx 포워딩 설정에 proxy_set_header를 추가하고, springboot로 요청을 보낸 뒤 헤더를 출력하면 아래와 같이 x-forwarded-for 헤더에 실제 클라이언트의 IP(1.22~)와 ELB의 IP(172.3~)가 포함됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhklEQVQY03VQ4QqGIAzs/Z9RMSv1l1H6R0W7jxOM6KPBcdttO9gmfERrDdd19ZzMemDEWyembdtgrYUxBsuyYF1XOOeQc0YIoevkUgpSSl333mOeZxzHceujN9FAKQUpJYQQ3ZAmHDjPE1prxBj78FikIXf2ff83/Dq51nqfR2Y98HzFUyd+MIA2P5PhrS8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"X-Forwarded-For 설정을 추가했을 때의 결과\"\n        title=\"X-Forwarded-For 설정을 추가했을 때의 결과\"\n        src=\"/static/05dfe8a2533b7d32aeb30585dc955493/37523/result_1.png\"\n        srcset=\"/static/05dfe8a2533b7d32aeb30585dc955493/e9ff0/result_1.png 180w,\n/static/05dfe8a2533b7d32aeb30585dc955493/f21e7/result_1.png 360w,\n/static/05dfe8a2533b7d32aeb30585dc955493/37523/result_1.png 720w,\n/static/05dfe8a2533b7d32aeb30585dc955493/2e694/result_1.png 1048w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h3 id=\"2-nginx-설정에-x-forwarded-for-헤더-설정이-없는-경우\" style=\"position:relative;\"><a href=\"#2-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%97%86%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"2 nginx 설정에 x forwarded for 헤더 설정이 없는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Nginx 설정에 X-Forwarded-For 헤더 설정이 없는 경우</h3>\n<p>1번에서의 proxy_set_header 라인을 지우고 동일하게 테스트를 해보면, 예상대로 아래와 같이 ELB의 IP는 기록되지 않고 클라이언트의 IP 만 기록됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 694px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAiklEQVQY05WQSQrFIBBEvf/BshFF3HiJbOKUOMT6dIMhCFl84UFVaUvRYowBgs7U/2ZvRCkF13XhPE+8NZFzZv+VrfTeIfZ9h7UWWmtGKYVt2yCl5Nw5h9YaD5A2xiClhForZ1RiFuEP6TKEwBzH8eC958EY49OQ9PSfDe/7xmTdx8zpIbH6FdrhD4BJg3MbdgoSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"X-Forwarded-For 설정이 없을 때의 결과\"\n        title=\"X-Forwarded-For 설정이 없을 때의 결과\"\n        src=\"/static/ab360a7e937b32e31eed4af1103e32c2/31198/result_2.png\"\n        srcset=\"/static/ab360a7e937b32e31eed4af1103e32c2/e9ff0/result_2.png 180w,\n/static/ab360a7e937b32e31eed4af1103e32c2/f21e7/result_2.png 360w,\n/static/ab360a7e937b32e31eed4af1103e32c2/31198/result_2.png 694w\"\n        sizes=\"(max-width: 694px) 100vw, 694px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<ul>\n<li>ELB에서의 X-Forwarded-Header 설정을 <code class=\"language-text\">첨부</code></li>\n<li>springboot에 <code class=\"language-text\">server.forward-headers-strategy=native</code> 설정</li>\n</ul>\n<p>위와 같은 현재 프로젝트의 환경에서는, EC2의 Nginx에 <code class=\"language-text\">proxy_set_header X-Forwarded-For \"127.0.0.1\";</code> 와 같이 localhost를 명시적으로 지정하지 않는 한, 인스턴스 외부 요청에 대한 getRemoteHost() 값이 localhost가 될 수 없음을 확인하였습니다.</p>\n<br/>\n<h2 id=\"의의\" style=\"position:relative;\"><a href=\"#%EC%9D%98%EC%9D%98\" aria-label=\"의의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>의의</h2>\n<p>AWS와 같은 배포 및 인프라 작업은, 어느정도 결과가 예상되도 확실하게 테스트를 하는게 속이 편한 것 같습니다. 글에서 다룬 내용은 진작에 알던 내용이지만 확실하게 하지 않으면 엄청나게 큰 문제가 발생할 수 있는 것을 사전에 확인해보는,  ‘절벽에 있는 돌다리를 두들겨보고 건너는’ 작업이었다는 점에서 의미가 있었던 것 같습니다 ㅎㅎ</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B0%B0%EA%B2%BD\">배경</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A7%88%EB%AC%B8\">질문</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%99%95%EC%9D%B8\">확인</a></p>\n<ul>\n<li><a href=\"#1-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%9E%88%EB%8A%94-%EA%B2%BD%EC%9A%B0\">1. Nginx 설정에 X-Forwarded-For 헤더 설정이 있는 경우</a></li>\n<li><a href=\"#2-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%97%86%EB%8A%94-%EA%B2%BD%EC%9A%B0\">2. Nginx 설정에 X-Forwarded-For 헤더 설정이 없는 경우</a></li>\n<li><a href=\"#%EA%B2%B0%EB%A1%A0\">결론</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9D%98%EC%9D%98\">의의</a></p>\n</li>\n</ul>\n</div>","excerpt":"배경 팀원의 코드를 리뷰하고 있었는데, 아래와 같은 코드가 있었습니다. 실제 코드와 다르며 내용 파악을 위해 일부 수정하였습니다. 내용은 중요하지 않긴 하지만.. 간단하게만 말씀드리면 ELB에서의 헬스체크를 의도적으로 실패하도록 하는 API 입니다. 이 코드에서의 핵심은 클라이언트의 IP(=remoteHost)가 로컬호스트인 경우에만 OK 응답을 주겠다는 건데, 여기서 의문이 들었던 것은 “Nginx 설정과 무관하게 getRemoteHost()가 항상 실제 클라이언트의 IP를 반환할 것을 보장하는지?” 였는데요, 의문이 들었던 내용부터 실제 테스트를 하며 확인한 결과를 하나하나 작성해 보겠습니다.  시작하기 전에, 이번 글에서 사용하는 인프라 구조입니다! 질문 이전 문단에 나왔던 코드의 getRemoteHost() 부분에 아래와 같은 질문을 남겼었습니다.  찝찝했던 이유는 이전에 ELB를 사용하기 전 EC2로 직접 요청을 보냈을 때 클라이언트 정보를 읽어오지 못해 문제가 발생했던 …","frontmatter":{"date":"November 05, 2024","title":"AWS ELB 와 Springboot 에서의 클라이언트 IP 확인","categories":"level4 aws","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/check_client_ip/"}},"next":{"id":"d791bb2b-10db-526a-888e-7ec129168487","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p><a href=\"https://github.com/woowacourse/spring-roomescape-waiting/pull/30\">우아한테크코스의 세 번째 미션</a>을 진행하며, 리뷰어께서 좋은 의견을 주셨습니다. 웹 구현을 처음\n해보는 입장에서 생각지도 못했던 <code class=\"language-text\">API Break Change</code> 에 대한 것인데요, API JSON 응답은 <strong>List가 아닌 Object 형식</strong>으로 하는 것을 권하셨고 이번 글에서는 이 내용에 대해 기록해보고자\n합니다.</p>\n<br/>\n<h2 id=\"api-break-change란\" style=\"position:relative;\"><a href=\"#api-break-change%EB%9E%80\" aria-label=\"api break change란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API Break Change란?</h2>\n<p><a href=\"https://nordicapis.com/how-to-manage-breaking-changes-throughout-an-apis-lifecycle/\">출처</a>에 있는 글에서는 Breaking Change를 다음과\n같이 설명합니다.</p>\n<blockquote>\n<p>A<a href=\"https://nordicapis.com/what-are-breaking-changes-and-how-do-you-avoid-them/\">breaking change</a>is when one such change\ncauses a client application to break somehow. While some changes make a minimal impact, breaking changes are those\nfundamental changes that cause the system to cease functioning. This could be a change in a field name, the removal of\nan unused resource type, a new feature that deprecates older features, and so forth.</p>\n</blockquote>\n<p>이 글을 요약해보면,</p>\n<ol>\n<li><strong>클라이언트 애플리케이션이 중지되도록 하는 변경</strong>을 Breaking Change라고 한다.</li>\n<li>변경 사항이 최소한의 영향을 미칠수도 있지만, 시스템 작동을 중단시킬 수도 있다.</li>\n<li>필드 이름 변경, 사용하지 않는 리소스 제거, 기존의 기능을 deprecate하는 새로운 기능 등이 있다.</li>\n</ol>\n<p>그렇다면, <strong>현재 API 코드의 변화가 기존의 클라이언트 코드에 영향을 미치지 않도록 설계하는것이 중요</strong>하겠네요! 다음으로는 기존에 구현했던 방법을\n작성해 보겠습니다.</p>\n<br/>\n<h2 id=\"기존-구현\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%EA%B5%AC%ED%98%84\" aria-label=\"기존 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 구현</h2>\n<p>예시를 위한 코드는 기존과 같은 형식으로, 내용만 조금 간단하게 작성하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token class-name\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span>AccessLevel</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PROTECTED</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> age<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Builder</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> age<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>age <span class=\"token operator\">=</span> age<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>엔티티는 위와 같이 이름, 나이로 구성되어 있습니다. 사실 코드 자체가 중요한게 아니고 이름(name), 나이(age) 필드가 있다는 것만 알아도 충분합니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getAllMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>테스트를 위해 간단하게 작성한 코드라, 별도의 Layer 구분 없이 Repositroy를 컨트롤러에서 바로 사용하도록 작성하였습니다. 기존 구현은 위와 같이 <code class=\"language-text\">GET /members</code> 요청을 보내면 전체 회원을\n반환하고 있습니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>응답은 위와 같은 JSON 배열로 나갈 것이고, <strong>이 JSON만 보고 어떤 데이터인지 바로 파악하기 쉽지 않다는 문제</strong>가 있긴 하지만 클라이언트 코드에서 이를 처리하는 것 자체는 크게 문제가 없는 것 같습니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">fetchMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/members'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  data<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">member</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>클라이언트 코드는 대략 이런 형태로 구성될 것 같고, 웹을 처음 구현하는 입장에선 클라이언트 코드 조금 고치면 되니깐 크게 문제가 있다는 생각을 하진 못했습니다.</p>\n<br/>\n<h2 id=\"리뷰어-피드백\" style=\"position:relative;\"><a href=\"#%EB%A6%AC%EB%B7%B0%EC%96%B4-%ED%94%BC%EB%93%9C%EB%B0%B1\" aria-label=\"리뷰어 피드백 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>리뷰어 피드백</h2>\n<p>리뷰어께서 <a href=\"https://blog.stackademic.com/creating-a-high-quality-rest-api-201819325356\">아티클</a>을 바탕으로 피드백을 주셨는데, 해당 링크에 들어가면 다음과\n같은 내용이 나옵니다.</p>\n<blockquote>\n<p>• Don’t return arrays as top-level responses : The top-level response from an endpoint should be an Object and not\nan array. For instance GET /books returns: {“data”:[{…book1…}], [{…book2…}]} is good and GET /books returns:[{…book1…}]\nGET is bad. Returning arrays is not recommendable as it makes it hard to make changes to the output that are backward\ncompatible. For example, adding a pagination field like totalCount. This will be a breaking change for the client.</p>\n</blockquote>\n<p>기존에 구현한 방법과 같이 List 형태의 응답보단, 확장성을 고려해 이를 감싼 Object 형식으로 반환하라는 내용인데요, 사실 이 부분이 크게 와닿진 않았지만 리뷰어께서 남겨주신 다음 의견을 보고 어떠한\n의도셨는지 바로 이해할 수 있었습니다.</p>\n<blockquote>\n<p>서버 코드 변경에 맞추어 프론트 코드를 항상 바꾸어달라고 요구하는 건 현업에서 매우 어려운 일입니다 (단순히 공수를 넘어 배포 일정, 정치적인 관계 등 다양한 변수가 존재합니다 ㅋㅋ 누가 상돌 미션 처리할 거\n4개 쌓였는데 ‘죄송한데 이거 조금만 수정해서 내일 새벽 6시에 배포좀 같이 해주시면 안 될까요? ㅠㅠ’ 라고 부탁했다고 상상해보세요)</p>\n</blockquote>\n<p>이번 미션에서는 간단한 클라이언트 코드 수정은 직접 했지만, 프로젝트를 하거나 회사에 가면 이 변경을 프론트쪽에서도 반영을 해주어야 하는데.. 리뷰어께서 말씀하신 대로 쉬운 작업은 아니겠다는 생각을 할 수 있었습니다\nㅎㅎ 이제 마지막으로 이 피드백을 바탕으로 수정한 방법을 작성해보겠습니다.</p>\n<br/>\n<h2 id=\"구현-방법-수정\" style=\"position:relative;\"><a href=\"#%EA%B5%AC%ED%98%84-%EB%B0%A9%EB%B2%95-%EC%88%98%EC%A0%95\" aria-label=\"구현 방법 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>구현 방법 수정</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">MembersResponse</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MembersResponse</span> <span class=\"token function\">getAllMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MembersResponse</span><span class=\"token punctuation\">(</span>members<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이, <code class=\"language-text\">List&lt;Member></code> 를 감싸는 별도의 응답 DTO를 만들어 반환하도록 수정하였습니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"members\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol1\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그러면 응답 JSON 형태가 위와 같이 바뀌게 되며, 기존 구현과 달리 JSON 만을 보고도 회원 정보 데이터라는 것을 바로 파악할 수 있고 회원 정보 필드 이외의 다른 값(전체 데이터 개수)을\n<strong>새로운 필드로 추가해도 기존의 클라이언트 코드는 정상적으로 작동</strong>하기에 Breaking Change의 발생 가능성을 줄일 수 있겠네요!</p>\n<br/>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<ol>\n<li>응답을 JSON Arrray 형식으로 반환하는 것은 확장하기 힘든 구조이며, 따라서 API Breaking Change의 가능성이 크다.</li>\n<li>따라서 처음부터 Array가 아닌 Object 형식으로 이를 감싸서 응답하는 방법으로 Breaking Change의 발생 가능성을 줄일 수 있다.</li>\n</ol>\n<p>리뷰어께서 좋은 의견을 주신 덕분에 생각하지도 못한 것들에 대해 새로 알아갈 수 있어 유익한 시간이었습니다 ㅎㅎ</p>\n<p>읽어주셔서 감사합니다. 즐거운 하루 보내세요🙇</p>","frontmatter":{"date":"July 08, 2024","title":"API Break Change 방지를 위한 리스트 형태의 JSON 응답 수정","categories":"level2 Spring API","author":"이상진","emoji":"🌱"},"fields":{"slug":"/woowacourse/level2/api_break_change/"}},"prev":{"id":"77db79ad-632c-5b83-bccd-ed534dd5a2fe","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>프로젝트 팀원인 <a href=\"https://github.com/ay-eonii\">테니</a>가 기존의 무중단 배포에서 다운타임이 발생하는 문제를 해결하는 <a href=\"https://github.com/woowacourse-teams/2024-mouda/pull/794\">PR</a>을 올렸습니다.</p>\n<blockquote>\n<p>자세한 내용은 해당 PR에서 확인하실 수 있습니다.</p>\n</blockquote>\n<p>문제도 잘 파악했고, 해결까지의 전체 과정을 문서화해서 공유해준 덕분에 전체 과정을 빠르게 이해할 수 있었는데요(<strong>테니 감사합니다 😄</strong>), 제가 PR에 남겼던 댓글 중 일부를 직접 테스트해본 결과를 바탕으로 기존 방법에서 조금 더 개선이 가능한 부분을 공유하고자 합니다.</p>\n<br/>\n<h2 id=\"기존-배포-과정\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%EB%B0%B0%ED%8F%AC-%EA%B3%BC%EC%A0%95\" aria-label=\"기존 배포 과정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 배포 과정</h2>\n<p>개선 방법을 작성하기 전에, 기존의 과정을 순서대로 살펴보며 전체 흐름을 다시 정리하겠습니다.</p>\n<h3 id=\"1-인스턴스-내부에서-post-termination-요청을-보내-elb의-헬스체크에-실패하도록-지정\" style=\"position:relative;\"><a href=\"#1-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EB%82%B4%EB%B6%80%EC%97%90%EC%84%9C-post-termination-%EC%9A%94%EC%B2%AD%EC%9D%84-%EB%B3%B4%EB%82%B4-elb%EC%9D%98-%ED%97%AC%EC%8A%A4%EC%B2%B4%ED%81%AC%EC%97%90-%EC%8B%A4%ED%8C%A8%ED%95%98%EB%8F%84%EB%A1%9D-%EC%A7%80%EC%A0%95\" aria-label=\"1 인스턴스 내부에서 post termination 요청을 보내 elb의 헬스체크에 실패하도록 지정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 인스턴스 내부에서 POST /termination 요청을 보내 ELB의 헬스체크에 실패하도록 지정</h3>\n<p>ELB의 헬스체크에 사용되는 코드를 살펴보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HealthCheckController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">HOST_IPV4</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">HOST_IPV6</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"0:0:0:0:0:0:0:1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">HOST_NAME</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">;</span>\n   \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AtomicBoolean</span> isTerminating <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicBoolean</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   \n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/health\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">checkHealth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isTerminating<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BAD_GATEWAY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n   \n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/termination\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> remoteHost <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">HOST_IPV6</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token constant\">HOST_IPV4</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token constant\">HOST_NAME</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            isTerminating<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FORBIDDEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li><code class=\"language-text\">/health</code> 메서드는 필드에 있는 AtomicBoolean 값이 <code class=\"language-text\">false</code>이면 ELB가 <code class=\"language-text\">GET /health</code> 로 헬스체크 요청을 보낼 때 <code class=\"language-text\">200 응답</code>을 보내는 코드입니다.\n<ul>\n<li>ELB에는 헬스체크 정상 응답 코드가 200으로 지정되어 있습니다.</li>\n</ul>\n</li>\n<li><code class=\"language-text\">/termination</code> 메서드는 필드의 AtomicBoolean을 false로 지정하여, ELB가 헬스체크 요청을 보낼 때 <code class=\"language-text\">502 응답</code>을 보내 <strong>헬스체크에 실패</strong>하도록 합니다.</li>\n</ol>\n<p>이 API를 이용하여, 인스턴스에 있는 스크립트에서는 <code class=\"language-text\">POST /termination 요청 → 25초 sleep</code> 을 호출하여 본격적인 배포 시작 전에 ELB가 해당 인스턴스로의 트래픽을 보내지 않도록 지정합니다.</p>\n<blockquote>\n<p>25초에 대한 자세한 내용은 아래에서 다루겠습니다.</p>\n</blockquote>\n<br/> \n<h3 id=\"2-배포-시작\" style=\"position:relative;\"><a href=\"#2-%EB%B0%B0%ED%8F%AC-%EC%8B%9C%EC%9E%91\" aria-label=\"2 배포 시작 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 배포 시작</h3>\n<p>이후의 배포 과정은 다음 순서로 진행됩니다.</p>\n<ol>\n<li>(git clone &#x26; pull 등 프로젝트 코드 로딩 후) gradle 빌드 등 배포 준비</li>\n<li>기존의 springboot 프로세스를 종료\n<ul>\n<li>springboot의 <strong>graceful shutdown</strong> 옵션이 적용되었으며, <strong>timeout은 기본값인 30초</strong>입니다.</li>\n<li><strong>graceful shutdown</strong>은 기존의 요청이 있으면 <strong>최대 timeout 만큼의 시간동안은 해당 요청을 처리하고 종료</strong>하는 방법입니다.</li>\n</ul>\n</li>\n<li>1에서 빌드된 새로운 springboot 실행</li>\n<li><code class=\"language-text\">GET /health</code> 요청을 보내 springboot의 실행이 완료되고, 요청을 받아들이는지 한번 더 확인</li>\n</ol>\n<p>전체 과정은 큰 문제가 없고, 실제 배포 자체도 정상적으로 잘 되는 것은 확인하였지만 몇 가지의 걱정과 개선 방법이 떠올랐는데요, 이제 본격적으로 그 방법들을 다뤄보겠습니다.</p>\n<br/>\n<h2 id=\"기존-방법에서-우려되는-점\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%EB%B0%A9%EB%B2%95%EC%97%90%EC%84%9C-%EC%9A%B0%EB%A0%A4%EB%90%98%EB%8A%94-%EC%A0%90\" aria-label=\"기존 방법에서 우려되는 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 방법에서 우려되는 점</h2>\n<p>프로젝트 초기에 <strong>gradle 빌드 과정에서 메모리 부족으로 인스턴스가 멈췄던 적이</strong> 많았는데요, 현재 시점에서 프로젝트는 더 무거워졌는데 인스턴스는 그때와 같은 타입(t4g.micro)이기 때문에 메모리 문제가 충분히 발생할 수 있다고 생각했습니다.</p>\n<p>따라서, 제 개인 EC2 및 아래의 환경에서 실제 테스트를 진행하며 우려되는 것들이 실제 발생 가능한 문제인지 확인 해 보겠습니다.</p>\n<ol>\n<li>Free-Tier 인스턴스 타입인 t2.micro는 실제 프로젝트에서 사용하는 t4g.micro와 메모리(1GB)사양이 같고, 여기에 프로젝트 환경과 동일하게 2GB 스왑 메모리를 적용하였습니다.\n<ul>\n<li>제 개인 배포에 사용되는 인스턴스이다보니, Mysql 등 다른 프로세스도 실행이 되어 있습니다. 따라서 전체 사용량보다는 사용량의 변화를 중점으로 확인해주세요.</li>\n</ul>\n</li>\n<li>배포는 프로젝트 코드가 아닌 테스트를 위해 작성한 별도의 코드로 진행합니다. 규모는 프로젝트 코드보다 현저히 낮으며, 코드는 <a href=\"https://github.com/pricelees/woowang-pic\">GIthub 링크</a>에서 확인하실 수 있습니다.\n<ul>\n<li>프로젝트 코드를 받아와서 진행할 수도 있지만, 배포까지의 절차가 복잡하고 원하는 코드를 바로바로 추가할 수 있는 이유로 개인 코드를 사용합니다.</li>\n</ul>\n</li>\n</ol>\n<p>우려하는 점은 Graceful shutdown과 관련이 있는데요, 하나씩 더 자세하게 작성해 보겠습니다.</p>\n<br/>\n<h3 id=\"1-graceful-shutdown이-사실상-적용되지-않습니다\" style=\"position:relative;\"><a href=\"#1-graceful-shutdown%EC%9D%B4-%EC%82%AC%EC%8B%A4%EC%83%81-%EC%A0%81%EC%9A%A9%EB%90%98%EC%A7%80-%EC%95%8A%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-label=\"1 graceful shutdown이 사실상 적용되지 않습니다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Graceful Shutdown이 사실상 적용되지 않습니다.</h3>\n<p>기존의 과정에서, <code class=\"language-text\">POST /termination → 25초 sleep</code> 과정을 거치면 해당 시점에서는 ELB가 더 이상 트래픽을 보내지 않습니다. 조금 더 자세히 말씀드리면 다음과 같습니다.</p>\n<ol>\n<li>현재 헬스체크의 비정상 임계값은 3, 제한 시간은 2초, 간격은 5초입니다. 이 값으로만 ELB의 트래픽 중단까지의 시간을 간단하게 계산 해보면 <strong>16.xx초 ~ 20.xx초</strong>가 소요됩니다.</li>\n</ol>\n<blockquote>\n<p>16.xx초: /termination 호출과 동시에 헬스체크가 이뤄지는 경우. 즉 대기(0.xx초) → 확인(2초) → 대기(5초) → 확인(2초) → 대기(5초) → 확인(2초) 인 경우<br>\n20.xx초: 이전의 헬스체크가 끝난 동시에 /termination 호출이 이뤄지는 경우. 즉 대기(4.xx초) → 확인(2초) → 대기(5초) → 확인(2초) → 대기(5초) → 확인(2초) 인 경우</p>\n</blockquote>\n<ol start=\"2\">\n<li>\n<p>하지만 이 시간은 헬스체크 요청 및 실패 응답까지 <strong>제한 시간인 2초가 모두 소요된다는 가정 하</strong>이며, <strong>실제로는 요청부터 응답까지 2초가 나오지는 않습니다.</strong> 아래의 히스토그램을 보면, 100번의 요청 중 거의 대부분(이 그래프에서는 95번)이 <strong>0.06초 ~ 0.07초</strong>에 완료되는 것을 확인할 수 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABjklEQVQ4y62UwU7bQBCGebheeqHquRxRH6fiUA7lArwFbUEtAgQcIAQELfJCmtiBBJKA7dhZr9f7IS9xayuNBFJGWnnWO/+v2X9mdg4gyzJMpnk2g+u2cByHRqOB67oIIazfbrftvtlsMhqN0FqjlLJ4izSGOTOmqTtNljdOWP9xRm/wSCIlcRxbYP4t/GJJKUmSxPpRFP0j1JmBNOHrkcObTz/5sLJLzx/yGstJS4QZWsZs1gTvl3f5uLbP/WPIsxTGBk1bhVwVwvF/NmtXzH/eYXG1RFgc/semEqo0RUYh32tiNoTdu3tMmrBVv54NYRCGjEJ/dhkWATPTMK9ypmQlw7uH4G+Vy+AXVdmCtLJt8862zQFBFE9kMs0mCcfx344Fb5e2Wfiyw+HvFpdejyCSFbBKNZ2Bz23fRyplxzQnzKeooqFKJOfONXu/XLbrgr0zwcHFHy6vGsRxZOc3CHxuOh1ORYtT4eLd3Nqzbrdr57nU2IUWevI6WjMcDvE8j36/X7m+GT8I+QNRlucJn6wpckzVcxMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"헬스체크 소요 시간\"\n        title=\"헬스체크 소요 시간\"\n        src=\"/static/733b3c17d11cd1d9fff49ee865ba4c48/37523/1.png\"\n        srcset=\"/static/733b3c17d11cd1d9fff49ee865ba4c48/e9ff0/1.png 180w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/f21e7/1.png 360w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/37523/1.png 720w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/302a4/1.png 1080w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/844cc/1.png 1306w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n</li>\n</ol>\n<blockquote>\n<p>그래프는 python의 seaborn을 이용하였습니다.</p>\n</blockquote>\n<ol start=\"3\">\n<li>그럼에도 헬스체크 응답까지의 시간을 넉넉잡아 <strong>0.1초</strong>로 잡았을 때의 ELB의 트래픽 전송 중단까지의 최소 시간은 <strong>10.3xx초</strong>가 됩니다. 즉 ELB의 트래픽 전송 중단까지는 <strong>10.3xx</strong>초부터 <strong>20.xx초</strong>까지 소요된다고 할 수 있습니다.</li>\n</ol>\n<blockquote>\n<p>10.3xx초: 이전의 16.xx초에서 확인하는 2초를 0.1초로 바꾸고 계산한 값</p>\n</blockquote>\n<ol start=\"4\">\n<li>그러면 다음 줄인 sleep 25가 실행되는 동안 springboot가 새로운 요청을 받지 않고 기존의 요청을 처리할 수 있는 시간이 <strong>적어도 4.xx초</strong>(25초 - 20.xx초) <strong>부터 14.6xx초</strong>(25초 - 10.3xx초)<strong>까지</strong> 주어지며, 이 시간은 현재 프로젝트 규모와 트래픽을 고려했을 때 기존의 요청을 충분히 처리할 수 있는 시간입니다.</li>\n</ol>\n<p>즉, sleep 25 직후의 시점에서는 springboot가 요청을 받지도, 처리하고 있지도 않을 가능성이 농후한데 이후의 <strong>배포 준비 과정동안 메모리를 점유하고 있는 상황</strong>입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.666666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAe0lEQVQI1yWLSRKCMBQFuZFMAvkxpkjCICCKlnr/k7RFWPSmX78kTF90u1CZGXEbyj3RfsMMH7S9I9eZpl0PH96Y8YeyC046lHsgfouczYQOLxJlZ0rpOVWeXMZIpnoKfSOrA2nlSZuOXIa4FZeJvOmoSxu73e9tWh//PzOTRabYgjaCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메모리_1\"\n        title=\"메모리_1\"\n        src=\"/static/725e27e3dce45ea6f648f54578e0126f/37523/2.png\"\n        srcset=\"/static/725e27e3dce45ea6f648f54578e0126f/e9ff0/2.png 180w,\n/static/725e27e3dce45ea6f648f54578e0126f/f21e7/2.png 360w,\n/static/725e27e3dce45ea6f648f54578e0126f/37523/2.png 720w,\n/static/725e27e3dce45ea6f648f54578e0126f/302a4/2.png 1080w,\n/static/725e27e3dce45ea6f648f54578e0126f/07a9c/2.png 1440w,\n/static/725e27e3dce45ea6f648f54578e0126f/cc6fe/2.png 1860w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>사진은 <strong>sar -r 1</strong> 명령어로 1초 단위로 변화를 관찰한 뒤, 필요한 부분만 잘라붙였습니다.</p>\n</blockquote>\n<p>실제 메모리 변화를 관찰해보면, 빌드 중 최대 <code class=\"language-text\">68.17%</code>까지 메모리 사용률이 올랐고, 빌드가 끝난 뒤 <code class=\"language-text\">49%</code>대까지 떨어짐을 확인할 수 있는데요, gradle build 자체가 메모리를 상당히 많이 사용하는 작업이기에 기존의 springboot가 불필요하게 메모리를 점유하는 상황이 서버의 부하로 이어질 수 있습니다.</p>\n<br/>\n<h3 id=\"2-graceful-shutdown이-적용이-되도-문제가-발생할-수-있습니다\" style=\"position:relative;\"><a href=\"#2-graceful-shutdown%EC%9D%B4-%EC%A0%81%EC%9A%A9%EC%9D%B4-%EB%90%98%EB%8F%84-%EB%AC%B8%EC%A0%9C%EA%B0%80-%EB%B0%9C%EC%83%9D%ED%95%A0-%EC%88%98-%EC%9E%88%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-label=\"2 graceful shutdown이 적용이 되도 문제가 발생할 수 있습니다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Graceful Shutdown이 적용이 되도 문제가 발생할 수 있습니다.</h3>\n<p>이전에 언급한 대로 기존의 springboot를 종료하는 시점에서는 처리할 요청이 없어 graceful shutdown이 사실상 적용되지 않겠지만, 그럼에도 발생할 수 있는 문제 상황을 가정해 보겠습니다.</p>\n<ol>\n<li>이전에 계산한 대로, ELB가 트래픽을 배분하지 않아 <strong>springboot가 남아있는 요청만을 처리할 수 있는 시간은 4.xx~14.6xx초</strong>일 것입니다.</li>\n<li>빌드 등 배포 준비 과정이 보통 <strong>40초 ~ 1분</strong>정도 소요되니, 1의 시간을 포함하면 기존의 springboot를 종료할 때 까지 <strong>44.4xx초 ~ 1분 14.6xx초 정도의 시간</strong>동안 요청을 처리할 수 있습니다.</li>\n<li>현재 프로젝트에서는 이 정도 시간이 소요되는 작업도 없고, 이 정도의 트래픽이 몰리지도 않습니다. 즉, 44초 이상의 시간이 필요한 작업이라면 <strong>무한 루프 등의 시간이 지나도 해결이 되지 않을 문제일 가능성이 높습니다</strong>.</li>\n</ol>\n<p>아래의 입력된 delay(초) 만큼 멈춰 graceful shutdown의 적용을 확인하는 API를 호출한 뒤 메모리 사용량을 확인 해 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/shutdown-test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span>\n     <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"delay\"</span><span class=\"token punctuation\">,</span> defaultValue <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_SHUTDOWN_DELAY</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">int</span> delay<span class=\"token punctuation\">,</span>\n     <span class=\"token class-name\">Model</span> model\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Shutdown request received. Delay: {} seconds\"</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>delay <span class=\"token operator\">*</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n \n     model<span class=\"token punctuation\">.</span><span class=\"token function\">addAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delay\"</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">return</span> <span class=\"token string\">\"success-shutdown\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeklEQVQI1x2KWQ6DIAAFPVGruCDgUkRUUo1tbdL7n2Qa+JhM8t5kdr0w9qAZdrR7J0z0/MEMz4R8HOjphfEX/fZDdYFRL6lp7Unnv5R6QQ47mewDlfLcG4fQG0KvFGqliK6nRN56CrWkT5iAaBx1NaY+7qUJ3GpLLmf+HGVFUcgZGP0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메모리_2\"\n        title=\"메모리_2\"\n        src=\"/static/b5949fdbfd2eb39ef77bd7da6e789d84/37523/3.png\"\n        srcset=\"/static/b5949fdbfd2eb39ef77bd7da6e789d84/e9ff0/3.png 180w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/f21e7/3.png 360w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/37523/3.png 720w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/302a4/3.png 1080w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/07a9c/3.png 1440w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/b6e50/3.png 1862w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>새로운 springboot를 실행하는 동안의 메모리 점유율이 <code class=\"language-text\">50.71%</code> 에서 <code class=\"language-text\">67.55%</code> 까지 올랐고, 기존 springboot가 graceful shutdown을 마친 이후 스크립트 실행 전과 비슷한 <code class=\"language-text\">51%</code> 정도로 떨어집니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABHklEQVQoz4WQy26DMBBF8/8f10WVNLQLSEoTCG+wDfh5KkCKqlZpRjry3cyR5+6UlCilkFKhZwlhJDhJcAq8WrO3YiV4zTIhBB7NThtD13UY62jKlPJ6oLi8UWVHisuBOo/I0z1f8QuTap4Lm7YjTk4IOSKaFFkekFW0IsojqooY63dkscfq4blwO3c5e2SUNV6X2HnDzT9zgbfyLnzETgixCpcOJ1nh59u2rAv8vGGnG2bM7sL/ZrfIsixHa0NbX/lMXskv0UqRfXBOXunqBDPmGD3gfMB5/wfv/fbDru+J46VDhehvDO2Jvj3TN+f17ZoTsk9RQ8o0dmjrmI1BG7uy5FkbnHObcOlQqa3DSbUE2+LNL3SDm2uCm56e/A1hQGxCD1EkGAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"흐름도\"\n        title=\"흐름도\"\n        src=\"/static/49bbe9a16d62e05ffc39202e952fa100/37523/4.png\"\n        srcset=\"/static/49bbe9a16d62e05ffc39202e952fa100/e9ff0/4.png 180w,\n/static/49bbe9a16d62e05ffc39202e952fa100/f21e7/4.png 360w,\n/static/49bbe9a16d62e05ffc39202e952fa100/37523/4.png 720w,\n/static/49bbe9a16d62e05ffc39202e952fa100/302a4/4.png 1080w,\n/static/49bbe9a16d62e05ffc39202e952fa100/52576/4.png 1412w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>이 사진에서 노란색 영역은 기존 springboot와 새로운 springboot가 동시에 실행되는 구간입니다.</p>\n</blockquote>\n<p>즉, 주어진 시간인 44.xx초 ~ 1분 14.6xx초 동안 해결되지 않는 문제이면 새로운 springboot를 실행하는 동안 기존의 springboot가 graceful shutdown을 진행하도록 할 필요가 없습니다. 어차피 기존의 springboot를 종료한다면, 차라리 일찍 종료하는게 더 나은 방법입니다. (아니면 아예 새로운 버전의 배포를 멈추는 것도 방법입니다.)</p>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<p>테스트하는 과정에서 인스턴스가 튕기거나, 입력 및 처리가 현저히 느려지는 현상이 발생할 정도로 현재 과정에서는 graceful shutdown이 진행되는 여부와 관계 없이 메모리 부하가 발생할 수 있음을 확인하였습니다. 떠오르는 개선 방법은 정~말 간단한데요, 실제로 테스트를 해보며 이 방법이 적용 되는지 확인 해 보겠습니다.</p>\n<br/>\n<h2 id=\"개선해보기\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%84%A0%ED%95%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"개선해보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개선해보기</h2>\n<h3 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h3>\n<p>우선, 내용이 길어 기존 방법이 헷갈릴 수 있으니 기존 방법을 한번 더 언급하겠습니다. <code class=\"language-text\">sleep 25</code> 까지의 명령어로 ELB의 트래픽 전달을 막고, 빌드 등의 준비를 마친 뒤 기존 springboot를 종료하고 새로운 springboot를 실행하는 과정입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 기존 방법</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://localhost:8080/termination\n<span class=\"token function\">sleep</span> <span class=\"token number\">25</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인</code></pre></div>\n<p>떠오르는 개선 방법은 정말 간단한데요, 아래와 같이 <code class=\"language-text\">kill [기존 springboot]</code>를 <code class=\"language-text\">sleep 25</code> 직후 실행되도록 옮겨 <strong>ELB가 트래픽을 전달하지 않는 순간에 바로 springboot를 종료</strong>하는 방법입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 새로운 방법 방법</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://localhost:8080/termination\n<span class=\"token function\">sleep</span> <span class=\"token number\">25</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인</code></pre></div>\n<p>개선했을 때 기대되는 결과는 다음과 같습니다.</p>\n<ol>\n<li>graceful shutdown이 진행되지 않는다면, ELB의 트래픽 배분 중지와 동시에 기존 springboot가 종료될테니 빌드 등 새로운 springboot의 배포 준비 과정에서의 메모리 부하가 줄어들 것입니다.</li>\n<li>graceful shutdown이 진행된다고 하더라도, 배포 준비 시간(보통 40 ~50초)동안 30초인 timeout 만료로 기존의 springboot가 종료될테니 새로운 springboot가 실행될 때의 메모리 부하가 줄어들 것입니다.</li>\n</ol>\n<p>이제 본격적으로 테스트를 해보며, 이 개선안이 실제로 유의미한지 살펴보겠습니다.</p>\n<br/>\n<h3 id=\"1-테스트---graceful-shutdown이-적용되지-않을-때\" style=\"position:relative;\"><a href=\"#1-%ED%85%8C%EC%8A%A4%ED%8A%B8---graceful-shutdown%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%98%EC%A7%80-%EC%95%8A%EC%9D%84-%EB%95%8C\" aria-label=\"1 테스트   graceful shutdown이 적용되지 않을 때 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 테스트 - graceful shutdown이 적용되지 않을 때</h3>\n<p>테스트는 제 개인 EC2에서 진행하고 있고, 공개된 도메인도 아니기에 제가 별도의 요청을 보내지 않는 이상 springboot가 처리할 별도의 요청이 존재하지 않을 것입니다. 즉 이 경우에서는 kill 명령어로 기존의 springboot를 종료하면 바로 프로세스가 종료될 것이라고 생각할 수 있습니다.</p>\n<p>테스트는 기존 방법과 수정한 방법을 각 3회 진행한 뒤 평균을 낸 값을 비교하는 방법으로 진행하였습니다.</p>\n<blockquote>\n<p>물론 정규분포에 가까워진다고 여겨지는 30회 정도의 시도는 해보고 싶었으나.. 로그를 정리하는 시간이 생각보다 오래 걸리고, 3회 시도에서의 편차가 거의 없어 추이를 판단하기에는 크게 무리가 없다고 판단하였습니다.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABoUlEQVQoz3WTjY6jMAyE+/7veCtdDwrl2gIhifNnz8mBsN1dXaQIMOTzjG0uOWd47xFCqDvGiMfjgb7vcbvdMI5Dve/7Dr+vHf70A7qux/V6reecJ8zLgnmeUZhxSSnVFyJy7sIFLAJA7wWGMmxkOO9hzYJEFrqYGTkS+q7Dr48PKOuiqhSoSyoEFQgRxFxgfEIqgkAehTYgeWyvO6R9386UsgPVskKP+J5ZClIpWH08AgmI254UgLMWJcV6ph07geu6wjl3KJNq1YQE4yOYd9tC5iyHrkQOkdxBShAuSPkAPp/PqtBbA2tmbOuMbVsB4d1WtECJnxZVcPQoKVSQJtvMUkuScsZlmqZT4VFIsH+BE0GYgbCdsLPGB5CsgXGEkAVc0q5QG6Kjcna5Ws/g6CCJgBx+APW6vSY4s5w6zhqq3aawda2OjSoj82n9SNagf58vxJh+AluX3y0XhfhlBx6x7ytrA1n+r/B9sLMwmMyu8s3ul81cB7spVmEVqA/WWizLUgOagALhfp9qTOvbfsu2x3HEMAz119Sx02+IqKr8B/x4q+nEyHr0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"그래프_1\"\n        title=\"그래프_1\"\n        src=\"/static/5e11d2f228b8629cf9ac5e6e16f27e51/37523/5.png\"\n        srcset=\"/static/5e11d2f228b8629cf9ac5e6e16f27e51/e9ff0/5.png 180w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/f21e7/5.png 360w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/37523/5.png 720w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/302a4/5.png 1080w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/07a9c/5.png 1440w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/76435/5.png 1742w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>그래프는 python의 matplotlib을 이용하였고, 배포 과정에서 1초 단위로 기록된 모든 메모리 사용률을 넣었습니다.</p>\n</blockquote>\n<p>위 그래프의 <strong>초록색 선</strong>은 배포 시작뒤 25초 정도가 경과한 시점인데(sleep 25 및 kill [기존 springboot]  호출 뒤), 기대했던 대로 이 시점부터 새로운 springboot가 실행되는 배포 준비 과정까지 전체적인 메모리 사용량이 낮아졌습니다.</p>\n<p>추가적으로 새로운 springboot가 실행된 이후의 메모리 사용량은 비슷한 걸 보면, 기존의 springboot 역시 kill 명령어의 호출과 동시에 graceful shutdown 없이 바로 종료되는 것도 확인할 수 있습니다 😄</p>\n<br/>\n<h3 id=\"2-테스트---graceful-shutdown이-적용될-때\" style=\"position:relative;\"><a href=\"#2-%ED%85%8C%EC%8A%A4%ED%8A%B8---graceful-shutdown%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%A0-%EB%95%8C\" aria-label=\"2 테스트   graceful shutdown이 적용될 때 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 테스트 - graceful shutdown이 적용될 때</h3>\n<p>이전에 테스트용으로 만들었던 Delay를 주는 API를 호출하여, graceful shutdown이 최대(=timeout)인 30초동안 진행되도록 한 뒤 이전과 마찬가지로 기존 방법과 새로운 방법을 각 3회 테스트하였습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABnElEQVQoz32Ti47iMAxF+///CAhNYSWgA83Ledl3ZPexMFptpNDEsW9ObDMAQK0VOWeUUmw9zzPGccTlcsHl+gdfXyOOxyPO57PZD4eDnal/yhkpJRARRASDGkMIYOZ9ttbMufWOGh1ajqitQ7gjUMJjTii1ovcOStEuO51Oi6Aale73kPU3zE98f0+IpSGlCPe6o7PY3gZ3E1ZK/Q76xBjjEi7yMXty8FQgwqB5gp+/0VtBD5PZl5hFt67Eg779N6H5VALFgNK3CAIaoa/r4B1Y/r5lF7zdbobLmo+cweQgrdg35GakiiFraGeVZPj5Bb1LbQpFqsGM4fF4WAEoenjnLMlIk6WBGu+pwJYGZkA6op+RmsCFiBydaRihtogSbiPkjlwKXKofed3WCyHQyeMZMjh7229VH9RJc7gELQQ+N2uT/wlyjpCagLrA7IS62Kr8URjhf7SSgGUVJA9Jz91vL4o1J9He1LpXkvdGfz+rbW0XcjudnukrTVANSvh6vewWndM04X6/2zPepwZt55dxxPV6hRZV/1kb1A+Wbatu3ZXNagAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"그래프_2\"\n        title=\"그래프_2\"\n        src=\"/static/f88f72d51d4a297e7e03dc30e04a9e92/37523/6.png\"\n        srcset=\"/static/f88f72d51d4a297e7e03dc30e04a9e92/e9ff0/6.png 180w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/f21e7/6.png 360w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/37523/6.png 720w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/302a4/6.png 1080w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/07a9c/6.png 1440w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/f69df/6.png 1762w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>빌드가 시작되기 전에 기존의 springboot를 종료해도 graceful shutdown이 진행되기에 <strong>빌드 과정에서의 메모리 점유율은 기존 방법과 동일</strong>하지만, <strong>초록색 선</strong>의 시점(=graceful shutdown이 완료된 시점)부터는 기존 방법보다 메모리 사용량이 낮아짐을 확인할 수 있었습니다.</p>\n<br/>\n<h2 id=\"결론-1\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0-1\" aria-label=\"결론 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<p>기존의 springboot를 종료하는 순서만 바꾸는 단순한 작업임에도, 메모리 사용량이 줄어든 수치적인 변화와 더불어 인스턴스가 멈추는 등 기존 방법에서 나타났던 문제도 발생하지 않음을 확인할 수 있었습니다.</p>\n<p>다음 글에서는 Deregistration Delay라는 개념을 이용하여 <code class=\"language-text\">POST /termination → sleep 25</code> 과정을 대체해 보겠습니다. 긴 글 읽느라 고생 많으셨습니다 😄</p>","frontmatter":{"date":"November 06, 2024","title":"무중단 배포 과정에서의 매모리 사용량 개선 - 기존 애플리케이션의 종료 시점 변경","categories":"level4 aws","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/improving_deployment/1/"}},"site":{"siteMetadata":{"siteUrl":"https://pricelees.github.io","comments":{"utterances":{"repo":"pricelees/pricelees.github.io"}}}}},"pageContext":{"slug":"/woowacourse/level4/check_client_ip/","nextSlug":"/woowacourse/level2/api_break_change/","prevSlug":"/woowacourse/level4/improving_deployment/1/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}