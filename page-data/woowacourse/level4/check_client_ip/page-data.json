{"componentChunkName":"component---src-templates-blog-template-js","path":"/woowacourse/level4/check_client_ip/","result":{"data":{"cur":{"id":"3a9088fb-6964-5011-97d6-18839cb91de7","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>팀원의 코드를 리뷰하고 있었는데, 아래와 같은 코드가 있었습니다.</p>\n<blockquote>\n<p>실제 코드와 다르며 내용 파악을 위해 일부 수정하였습니다.</p>\n<p>내용은 중요하지 않긴 하지만.. 간단하게만 말씀드리면 ELB에서의 헬스체크를 의도적으로 실패하도록 하는 API 입니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/terminate\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> remoteHost <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"0:0:0:0:0:0:0:1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        isTerminated<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FORBIDDEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>이 코드에서의 핵심은 <strong>클라이언트의 IP(=remoteHost)가 로컬호스트인 경우에만 OK 응답</strong>을 주겠다는 건데, 여기서 의문이 들었던 것은 “<strong>Nginx 설정과 무관하게 getRemoteHost()가 항상 실제 클라이언트의 IP를 반환할 것을 보장하는지?</strong>” 였는데요, 의문이 들었던 내용부터 실제 테스트를 하며 확인한 결과를 하나하나 작성해 보겠습니다.</p>\n<br/>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABK0lEQVQoz2WRz0oDMRCH9yW9+ga+gu8gguhFFEE8CF6ECp7EgwgelKKIKLSHCi1qt62bTJLJfpLs9o868MtMAvnyy0xR1zVzkQTLfa5jzmbYY3y5Sx0EjTUxKjHGLG3rdKegjV/g1bPYAMuXO/rb6+AM4gLWWqxIls97QUQoErmqKlZDzYQoszk2r5WxlOWMTzvlb1R+ll0maDEuS3b29jPdmApNbq4PkPuzBh48QUPmdkdvrHU2OXy6WLz1OnrkvHvEt0xx4inKcsLxySlRtemNt9RfPerJOyoGKy5/iwjPH302rrbo9G5JLzsXGE4GPAxusN4g4ihUlQRdNi4mW6B+MaQU4hzRK751Ox9IqsVbfPC5r/+H0nZtoRaqGjHW4lzjWFbknM85BOUH/K0b96vhphoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인프라_구조\"\n        title=\"인프라_구조\"\n        src=\"/static/17bf5285cfa1dbc61cd59005efc0946d/37523/architecture.png\"\n        srcset=\"/static/17bf5285cfa1dbc61cd59005efc0946d/e9ff0/architecture.png 180w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/f21e7/architecture.png 360w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/37523/architecture.png 720w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/302a4/architecture.png 1080w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/37048/architecture.png 1352w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>시작하기 전에, 이번 글에서 사용하는 인프라 구조입니다!</p>\n<br/>\n<h2 id=\"질문\" style=\"position:relative;\"><a href=\"#%EC%A7%88%EB%AC%B8\" aria-label=\"질문 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>질문</h2>\n<p>이전 문단에 나왔던 코드의 getRemoteHost() 부분에 아래와 같은 질문을 남겼었습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhElEQVQI12VOTQ/CIBTj//8/NzN4ymbCYR7G18ExoOahmCU2adrXQ/sEkYQxBuv6hLUOPgTknHEcR9PmvzczpYRaKxhdQ4zYNotSCsS+v6DnBcN4hVSEaZIgukFK1bxShHl54DKMuGsN5/xfIQ/2IcGB87Gt8wLz81n5fdmzXnAuO2eMNyZO58ERVEn+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"코드리뷰_질문\"\n        title=\"코드리뷰_질문\"\n        src=\"/static/f6e51f5433612ecbad74d64cf501da57/37523/question.png\"\n        srcset=\"/static/f6e51f5433612ecbad74d64cf501da57/e9ff0/question.png 180w,\n/static/f6e51f5433612ecbad74d64cf501da57/f21e7/question.png 360w,\n/static/f6e51f5433612ecbad74d64cf501da57/37523/question.png 720w,\n/static/f6e51f5433612ecbad74d64cf501da57/302a4/question.png 1080w,\n/static/f6e51f5433612ecbad74d64cf501da57/07a9c/question.png 1440w,\n/static/f6e51f5433612ecbad74d64cf501da57/d3b46/question.png 1690w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>찝찝했던 이유는 이전에 ELB를 사용하기 전 EC2로 직접 요청을 보냈을 때 클라이언트 정보를 읽어오지 못해 문제가 발생했던 경험이 있었기 때문인데요, 이번에 ELB를 도입하며 비슷한 문제가 발생할 수도 있겠다는 우려가 있었던 것 같습니다 ㅎㅎ</p>\n<blockquote>\n<p>당시 발생했던 문제는 getRemotePort()를 호출했을 때 실제 요청 포트(443)을 읽지 못해 Swagger-UI에서 CORS가 발생했던 것인데요, <a href=\"https://github.com/woowacourse-teams/2024-mouda/pull/506\">PR 링크</a>에서 확인하실 수 있습니다.</p>\n</blockquote>\n<br/>\n<p>시작하기 전에, 우선 <code class=\"language-text\">getRemoteHost()</code>에 어떤 값이 들어가는지부터 확인해야 할 것 같습니다. 아래 코드는 HttpServletRequets의 구현 클래스 중 하나인 Request 클래스의 메서드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Request</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">HttpServletRequest</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connector<span class=\"token punctuation\">.</span><span class=\"token function\">getEnableLookups</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n    \n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드를 보면, getRemoteHost()도 <code class=\"language-text\">getRemoteAddr()</code> (=클라이언트의 IP)를 값으로 가지는데요, 이 메서드를 호출했을 때 실제 클라이언트의 IP를 기록하려면 아래의 설정이 필요합니다.</p>\n<br/>\n<ul>\n<li><strong>필수</strong>:  Nginx 설정파일에 <code class=\"language-text\">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> 를 추가하여 X-Forwarded-For 헤더를 springboot에 전달하도록 해야 합니다d.</li>\n</ul>\n<ol>\n<li>application.yml에 <code class=\"language-text\">server.forward-headers-strategy=native</code> 과 같은 Forward 헤더를 읽는 설정을 추가한다.</li>\n<li>설정을 추가하지 않았다면, getRemoteHost()가 아니라 <code class=\"language-text\">getHeader(”X-Forwarded-For”).split(”, “)[0]</code> 으로 값을 읽어와야 한다.</li>\n</ol>\n<p>위 과정 또는 비슷한 과정을 거치지 않았다면 인스턴스 외부에서의 요청에도 getRemoteHost()를 호출했을 때의 결과가 Localhost가 될 수 있습니다. 사실 ELB가 추가된 환경에서도 클라이언트의 IP를 정확하게 읽어올 것이라고 예상되긴 하는데요, 그럼에도 잘못 호출되는 경우 서버가 터질 우려가 있기에.. 적어도 한 번은 확인해볼 필요가 있다고 생각했습니다.</p>\n<blockquote>\n<p>제 테코톡(<a href=\"https://youtu.be/oUroldyG1_s?si=osh0ER_t6s8JWUNG&#x26;t=642\">링크</a>)에서 X-Forwarded-For 헤더와 클라이언트의 IP를 기록하는 방법을 다룹니다 ㅎㅎ 아래 글이 이해가 안 가신다면 영상을 참고해주세요!</p>\n</blockquote>\n<br/>\n<h2 id=\"확인\" style=\"position:relative;\"><a href=\"#%ED%99%95%EC%9D%B8\" aria-label=\"확인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>확인</h2>\n<p>이전 문단에서 다뤘듯이, 클라이언트의 IP를 가져오려면 <strong>springboot로 가는 요청에 클라이언트의 IP가 담긴 X-Forwarded-For 헤더가 포함</strong>되어야 하는데요,</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAcklEQVQY062L6wrDIAyFff9XHIxBnXUdvZikP4ziGUbWJ2jgI+eSuBACvH9jmjyW5YtaK1QVWRWqBaUMelZ6Z74i59Hr1Q/tHs8XEhHWbUciBouAmC1jlovuRU6kRHZz2D5N/386LswRd46L8YPW2m38AJQvOOMN2pM2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ELB에서의 X-Forwarded-For 헤더 설정\"\n        title=\"ELB에서의 X-Forwarded-For 헤더 설정\"\n        src=\"/static/095d410edbfd1eedcf80b101867cf738/37523/xforwardedfor.png\"\n        srcset=\"/static/095d410edbfd1eedcf80b101867cf738/e9ff0/xforwardedfor.png 180w,\n/static/095d410edbfd1eedcf80b101867cf738/f21e7/xforwardedfor.png 360w,\n/static/095d410edbfd1eedcf80b101867cf738/37523/xforwardedfor.png 720w,\n/static/095d410edbfd1eedcf80b101867cf738/302a4/xforwardedfor.png 1080w,\n/static/095d410edbfd1eedcf80b101867cf738/67a79/xforwardedfor.png 1408w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">AWS ELB 상세 페이지 → 작업 → Load Balancer 속성 편집</code>에 있는 위 설정으로 X-Forwarded-For 헤더 설정이 가능하며, 각 항목은 다음과 같습니다.</p>\n<ul>\n<li><strong>첨부</strong>: X-Forwarded-For 헤더에 클라이언트의 IP를 저장(추가) 하여 서버로 전달</li>\n<li><strong>보존</strong>: 기존의 X-Forwarded-For를 그대로 전달</li>\n<li><strong>제거</strong>: 기존의 X-Forwarded-For가 있으면 삭제</li>\n</ul>\n<p>따라서 클라이언트의 요청을 받는 ELB에서는 해당 설정이 ‘<code class=\"language-text\">첨부</code>’로 되어 있어야 실제 클라이언트의 IP가 기록되어 전달됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrequest<span class=\"token punctuation\">.</span><span class=\"token function\">getHeaderNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">asIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">forEachRemaining</span><span class=\"token punctuation\">(</span>headerName <span class=\"token operator\">-></span> headers<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>headerName<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span>headerName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>확인은 위 코드를 이용하여 실제 요청에 있는 모든 헤더를 출력한 뒤 EC2 내부의 Nginx 설정에 따라 X-Forwarded-For 헤더가 어떻게 달라지는지, 실제 헤더가 포함되고, 클라이언트의 IP가 잘 전달되는지 확인하는게 목표입니다!</p>\n<br/>\n<h3 id=\"1-nginx-설정에-x-forwarded-for-헤더-설정이-있는-경우\" style=\"position:relative;\"><a href=\"#1-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%9E%88%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"1 nginx 설정에 x forwarded for 헤더 설정이 있는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Nginx 설정에 X-Forwarded-For 헤더 설정이 있는 경우</h3>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://localhost:8080</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nginx 포워딩 설정에 proxy_set_header를 추가하고, springboot로 요청을 보낸 뒤 헤더를 출력하면 아래와 같이 x-forwarded-for 헤더에 실제 클라이언트의 IP(1.22~)와 ELB의 IP(172.3~)가 포함됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhklEQVQY03VQ4QqGIAzs/Z9RMSv1l1H6R0W7jxOM6KPBcdttO9gmfERrDdd19ZzMemDEWyembdtgrYUxBsuyYF1XOOeQc0YIoevkUgpSSl333mOeZxzHceujN9FAKQUpJYQQ3ZAmHDjPE1prxBj78FikIXf2ff83/Dq51nqfR2Y98HzFUyd+MIA2P5PhrS8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"X-Forwarded-For 설정을 추가했을 때의 결과\"\n        title=\"X-Forwarded-For 설정을 추가했을 때의 결과\"\n        src=\"/static/05dfe8a2533b7d32aeb30585dc955493/37523/result_1.png\"\n        srcset=\"/static/05dfe8a2533b7d32aeb30585dc955493/e9ff0/result_1.png 180w,\n/static/05dfe8a2533b7d32aeb30585dc955493/f21e7/result_1.png 360w,\n/static/05dfe8a2533b7d32aeb30585dc955493/37523/result_1.png 720w,\n/static/05dfe8a2533b7d32aeb30585dc955493/2e694/result_1.png 1048w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h3 id=\"2-nginx-설정에-x-forwarded-for-헤더-설정이-없는-경우\" style=\"position:relative;\"><a href=\"#2-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%97%86%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"2 nginx 설정에 x forwarded for 헤더 설정이 없는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Nginx 설정에 X-Forwarded-For 헤더 설정이 없는 경우</h3>\n<p>1번에서의 proxy_set_header 라인을 지우고 동일하게 테스트를 해보면, 예상대로 아래와 같이 ELB의 IP는 기록되지 않고 클라이언트의 IP 만 기록됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 694px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAiklEQVQY05WQSQrFIBBEvf/BshFF3HiJbOKUOMT6dIMhCFl84UFVaUvRYowBgs7U/2ZvRCkF13XhPE+8NZFzZv+VrfTeIfZ9h7UWWmtGKYVt2yCl5Nw5h9YaD5A2xiClhForZ1RiFuEP6TKEwBzH8eC958EY49OQ9PSfDe/7xmTdx8zpIbH6FdrhD4BJg3MbdgoSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"X-Forwarded-For 설정이 없을 때의 결과\"\n        title=\"X-Forwarded-For 설정이 없을 때의 결과\"\n        src=\"/static/ab360a7e937b32e31eed4af1103e32c2/31198/result_2.png\"\n        srcset=\"/static/ab360a7e937b32e31eed4af1103e32c2/e9ff0/result_2.png 180w,\n/static/ab360a7e937b32e31eed4af1103e32c2/f21e7/result_2.png 360w,\n/static/ab360a7e937b32e31eed4af1103e32c2/31198/result_2.png 694w\"\n        sizes=\"(max-width: 694px) 100vw, 694px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<ul>\n<li>ELB에서의 X-Forwarded-Header 설정을 <code class=\"language-text\">첨부</code></li>\n<li>springboot에 <code class=\"language-text\">server.forward-headers-strategy=native</code> 설정</li>\n</ul>\n<p>위와 같은 현재 프로젝트의 환경에서는, EC2의 Nginx에 <code class=\"language-text\">proxy_set_header X-Forwarded-For \"127.0.0.1\";</code> 와 같이 localhost를 명시적으로 지정하지 않는 한, 인스턴스 외부 요청에 대한 getRemoteHost() 값이 localhost가 될 수 없음을 확인하였습니다.</p>\n<br/>\n<h2 id=\"의의\" style=\"position:relative;\"><a href=\"#%EC%9D%98%EC%9D%98\" aria-label=\"의의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>의의</h2>\n<p>AWS와 같은 배포 및 인프라 작업은, 어느정도 결과가 예상되도 확실하게 테스트를 하는게 속이 편한 것 같습니다. 글에서 다룬 내용은 진작에 알던 내용이지만 확실하게 하지 않으면 엄청나게 큰 문제가 발생할 수 있는 것을 사전에 확인해보는,  ‘절벽에 있는 돌다리를 두들겨보고 건너는’ 작업이었다는 점에서 의미가 있었던 것 같습니다 ㅎㅎ</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B0%B0%EA%B2%BD\">배경</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A7%88%EB%AC%B8\">질문</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%99%95%EC%9D%B8\">확인</a></p>\n<ul>\n<li><a href=\"#1-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%9E%88%EB%8A%94-%EA%B2%BD%EC%9A%B0\">1. Nginx 설정에 X-Forwarded-For 헤더 설정이 있는 경우</a></li>\n<li><a href=\"#2-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%97%86%EB%8A%94-%EA%B2%BD%EC%9A%B0\">2. Nginx 설정에 X-Forwarded-For 헤더 설정이 없는 경우</a></li>\n<li><a href=\"#%EA%B2%B0%EB%A1%A0\">결론</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9D%98%EC%9D%98\">의의</a></p>\n</li>\n</ul>\n</div>","excerpt":"배경 팀원의 코드를 리뷰하고 있었는데, 아래와 같은 코드가 있었습니다. 실제 코드와 다르며 내용 파악을 위해 일부 수정하였습니다. 내용은 중요하지 않긴 하지만.. 간단하게만 말씀드리면 ELB에서의 헬스체크를 의도적으로 실패하도록 하는 API 입니다. 이 코드에서의 핵심은 클라이언트의 IP(=remoteHost)가 로컬호스트인 경우에만 OK 응답을 주겠다는 건데, 여기서 의문이 들었던 것은 “Nginx 설정과 무관하게 getRemoteHost()가 항상 실제 클라이언트의 IP를 반환할 것을 보장하는지?” 였는데요, 의문이 들었던 내용부터 실제 테스트를 하며 확인한 결과를 하나하나 작성해 보겠습니다.  시작하기 전에, 이번 글에서 사용하는 인프라 구조입니다! 질문 이전 문단에 나왔던 코드의 getRemoteHost() 부분에 아래와 같은 질문을 남겼었습니다.  찝찝했던 이유는 이전에 ELB를 사용하기 전 EC2로 직접 요청을 보냈을 때 클라이언트 정보를 읽어오지 못해 문제가 발생했던 …","frontmatter":{"date":"November 05, 2024","title":"AWS ELB 와 Springboot 에서의 클라이언트 IP 확인","categories":"level4 aws","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/check_client_ip/"}},"next":{"id":"d791bb2b-10db-526a-888e-7ec129168487","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p><a href=\"https://github.com/woowacourse/spring-roomescape-waiting/pull/30\">우아한테크코스의 세 번째 미션</a>을 진행하며, 리뷰어께서 좋은 의견을 주셨습니다. 웹 구현을 처음\n해보는 입장에서 생각지도 못했던 <code class=\"language-text\">API Break Change</code> 에 대한 것인데요, API JSON 응답은 <strong>List가 아닌 Object 형식</strong>으로 하는 것을 권하셨고 이번 글에서는 이 내용에 대해 기록해보고자\n합니다.</p>\n<br/>\n<h2 id=\"api-break-change란\" style=\"position:relative;\"><a href=\"#api-break-change%EB%9E%80\" aria-label=\"api break change란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API Break Change란?</h2>\n<p><a href=\"https://nordicapis.com/how-to-manage-breaking-changes-throughout-an-apis-lifecycle/\">출처</a>에 있는 글에서는 Breaking Change를 다음과\n같이 설명합니다.</p>\n<blockquote>\n<p>A<a href=\"https://nordicapis.com/what-are-breaking-changes-and-how-do-you-avoid-them/\">breaking change</a>is when one such change\ncauses a client application to break somehow. While some changes make a minimal impact, breaking changes are those\nfundamental changes that cause the system to cease functioning. This could be a change in a field name, the removal of\nan unused resource type, a new feature that deprecates older features, and so forth.</p>\n</blockquote>\n<p>이 글을 요약해보면,</p>\n<ol>\n<li><strong>클라이언트 애플리케이션이 중지되도록 하는 변경</strong>을 Breaking Change라고 한다.</li>\n<li>변경 사항이 최소한의 영향을 미칠수도 있지만, 시스템 작동을 중단시킬 수도 있다.</li>\n<li>필드 이름 변경, 사용하지 않는 리소스 제거, 기존의 기능을 deprecate하는 새로운 기능 등이 있다.</li>\n</ol>\n<p>그렇다면, <strong>현재 API 코드의 변화가 기존의 클라이언트 코드에 영향을 미치지 않도록 설계하는것이 중요</strong>하겠네요! 다음으로는 기존에 구현했던 방법을\n작성해 보겠습니다.</p>\n<br/>\n<h2 id=\"기존-구현\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%EA%B5%AC%ED%98%84\" aria-label=\"기존 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 구현</h2>\n<p>예시를 위한 코드는 기존과 같은 형식으로, 내용만 조금 간단하게 작성하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token class-name\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span>AccessLevel</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PROTECTED</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> age<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Builder</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> age<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>age <span class=\"token operator\">=</span> age<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>엔티티는 위와 같이 이름, 나이로 구성되어 있습니다. 사실 코드 자체가 중요한게 아니고 이름(name), 나이(age) 필드가 있다는 것만 알아도 충분합니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getAllMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>테스트를 위해 간단하게 작성한 코드라, 별도의 Layer 구분 없이 Repositroy를 컨트롤러에서 바로 사용하도록 작성하였습니다. 기존 구현은 위와 같이 <code class=\"language-text\">GET /members</code> 요청을 보내면 전체 회원을\n반환하고 있습니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>응답은 위와 같은 JSON 배열로 나갈 것이고, <strong>이 JSON만 보고 어떤 데이터인지 바로 파악하기 쉽지 않다는 문제</strong>가 있긴 하지만 클라이언트 코드에서 이를 처리하는 것 자체는 크게 문제가 없는 것 같습니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">fetchMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/members'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  data<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">member</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>클라이언트 코드는 대략 이런 형태로 구성될 것 같고, 웹을 처음 구현하는 입장에선 클라이언트 코드 조금 고치면 되니깐 크게 문제가 있다는 생각을 하진 못했습니다.</p>\n<br/>\n<h2 id=\"리뷰어-피드백\" style=\"position:relative;\"><a href=\"#%EB%A6%AC%EB%B7%B0%EC%96%B4-%ED%94%BC%EB%93%9C%EB%B0%B1\" aria-label=\"리뷰어 피드백 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>리뷰어 피드백</h2>\n<p>리뷰어께서 <a href=\"https://blog.stackademic.com/creating-a-high-quality-rest-api-201819325356\">아티클</a>을 바탕으로 피드백을 주셨는데, 해당 링크에 들어가면 다음과\n같은 내용이 나옵니다.</p>\n<blockquote>\n<p>• Don’t return arrays as top-level responses : The top-level response from an endpoint should be an Object and not\nan array. For instance GET /books returns: {“data”:[{…book1…}], [{…book2…}]} is good and GET /books returns:[{…book1…}]\nGET is bad. Returning arrays is not recommendable as it makes it hard to make changes to the output that are backward\ncompatible. For example, adding a pagination field like totalCount. This will be a breaking change for the client.</p>\n</blockquote>\n<p>기존에 구현한 방법과 같이 List 형태의 응답보단, 확장성을 고려해 이를 감싼 Object 형식으로 반환하라는 내용인데요, 사실 이 부분이 크게 와닿진 않았지만 리뷰어께서 남겨주신 다음 의견을 보고 어떠한\n의도셨는지 바로 이해할 수 있었습니다.</p>\n<blockquote>\n<p>서버 코드 변경에 맞추어 프론트 코드를 항상 바꾸어달라고 요구하는 건 현업에서 매우 어려운 일입니다 (단순히 공수를 넘어 배포 일정, 정치적인 관계 등 다양한 변수가 존재합니다 ㅋㅋ 누가 상돌 미션 처리할 거\n4개 쌓였는데 ‘죄송한데 이거 조금만 수정해서 내일 새벽 6시에 배포좀 같이 해주시면 안 될까요? ㅠㅠ’ 라고 부탁했다고 상상해보세요)</p>\n</blockquote>\n<p>이번 미션에서는 간단한 클라이언트 코드 수정은 직접 했지만, 프로젝트를 하거나 회사에 가면 이 변경을 프론트쪽에서도 반영을 해주어야 하는데.. 리뷰어께서 말씀하신 대로 쉬운 작업은 아니겠다는 생각을 할 수 있었습니다\nㅎㅎ 이제 마지막으로 이 피드백을 바탕으로 수정한 방법을 작성해보겠습니다.</p>\n<br/>\n<h2 id=\"구현-방법-수정\" style=\"position:relative;\"><a href=\"#%EA%B5%AC%ED%98%84-%EB%B0%A9%EB%B2%95-%EC%88%98%EC%A0%95\" aria-label=\"구현 방법 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>구현 방법 수정</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">MembersResponse</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MembersResponse</span> <span class=\"token function\">getAllMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MembersResponse</span><span class=\"token punctuation\">(</span>members<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이, <code class=\"language-text\">List&lt;Member></code> 를 감싸는 별도의 응답 DTO를 만들어 반환하도록 수정하였습니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"members\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sangdol1\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그러면 응답 JSON 형태가 위와 같이 바뀌게 되며, 기존 구현과 달리 JSON 만을 보고도 회원 정보 데이터라는 것을 바로 파악할 수 있고 회원 정보 필드 이외의 다른 값(전체 데이터 개수)을\n<strong>새로운 필드로 추가해도 기존의 클라이언트 코드는 정상적으로 작동</strong>하기에 Breaking Change의 발생 가능성을 줄일 수 있겠네요!</p>\n<br/>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<ol>\n<li>응답을 JSON Arrray 형식으로 반환하는 것은 확장하기 힘든 구조이며, 따라서 API Breaking Change의 가능성이 크다.</li>\n<li>따라서 처음부터 Array가 아닌 Object 형식으로 이를 감싸서 응답하는 방법으로 Breaking Change의 발생 가능성을 줄일 수 있다.</li>\n</ol>\n<p>리뷰어께서 좋은 의견을 주신 덕분에 생각하지도 못한 것들에 대해 새로 알아갈 수 있어 유익한 시간이었습니다 ㅎㅎ</p>\n<p>읽어주셔서 감사합니다. 즐거운 하루 보내세요🙇</p>","frontmatter":{"date":"July 08, 2024","title":"API Break Change 방지를 위한 리스트 형태의 JSON 응답 수정","categories":"level2 Spring API","author":"이상진","emoji":"🌱"},"fields":{"slug":"/woowacourse/level2/api_break_change/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://pricelees.github.io","comments":{"utterances":{"repo":"pricelees/pricelees.github.io"}}}}},"pageContext":{"slug":"/woowacourse/level4/check_client_ip/","nextSlug":"/woowacourse/level2/api_break_change/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}