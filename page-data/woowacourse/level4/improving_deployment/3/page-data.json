{"componentChunkName":"component---src-templates-blog-template-js","path":"/woowacourse/level4/improving_deployment/3/","result":{"data":{"cur":{"id":"0dce0473-b51b-5026-b22f-32b760578a3f","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<blockquote>\n<p>이번 글에서 다루는 deregister-targets 등의 개념은 <a href=\"https://pricelees.github.io/woowacourse/level4/improving_deployment/2/\">1편</a>에 작성되어 있습니다..ㅎㅎ 1편을 먼저 읽고 이번 글을 읽어주시면 감사하겠습니다.</p>\n</blockquote>\n<p>지난 글에서 통계량을 이용해 deregister-targets 호출 이후 실제 트래픽 중단까지 소요되는 최대 시간을 15초로 잡았었습니다. 지난번에 계산했던 트래픽 중단까지의 시간이 <strong>15초를 초과할 확률은 0.000021%</strong> 로 극히 미미한 수준이지만, 그럼에도 발생 가능성이 있다는 찝찝함은 있었던 것 같습니다.</p>\n<p>그래서.. <a href=\"https://docs.aws.amazon.com/cli/latest/reference/elbv2/\">aws-cli의 elbv2 API 문서</a>를 하나씩 살펴보던 도중 wait이라는 키워드를 발견했는데요, 이번 글에서는 wait을 이용하여 기존의 불확실성을 더 개선하는 방법을 소개하겠습니다.</p>\n<h3 id=\"wait-api\" style=\"position:relative;\"><a href=\"#wait-api\" aria-label=\"wait api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>wait API</h3>\n<blockquote>\n<p>Wait until a particular condition is satisfied. Each subcommand polls an API until the listed requirement is met.</p>\n</blockquote>\n<p><a href=\"https://docs.aws.amazon.com/cli/latest/reference/elbv2/wait/\">공식 문서</a>의 Description에 따르면,  wait 키워드는 특정 조건이 충족될 때 까지 기다리는 명령어입니다. 위의 Each subcommand의 종류는 다음과 같습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA10lEQVQoz42RcWuDMBDF/f4frNsfVlxLu7WVDo1Jy0yixtjW6eUVQxmUFfHB4+Du+N0dF1hrkec50jRFkiTgnIMLgYwxnxdC+FplW4xyzmFKgdYaH3GMaBni/W2B7WaD5LD3ufV6hSiKEIYhjuLnDzjlYGzqBkJ9G9B0BNsRyssvymv/bzoRTfoBdOCqRpwVWLEC+3PpI9fNuM5T8xx54FkZfGbK+5BrbFMJJs2sE1+c7CBPNdhO4fRdIftSkKJB39MTcK48sDU3VEWL1nQw8gIaaNZHXwHv5esehm+qqOoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/70b55122d2bdc48d9ecba3525955d299/37523/1.png\"\n        srcset=\"/static/70b55122d2bdc48d9ecba3525955d299/e9ff0/1.png 180w,\n/static/70b55122d2bdc48d9ecba3525955d299/f21e7/1.png 360w,\n/static/70b55122d2bdc48d9ecba3525955d299/37523/1.png 720w,\n/static/70b55122d2bdc48d9ecba3525955d299/302a4/1.png 1080w,\n/static/70b55122d2bdc48d9ecba3525955d299/9937c/1.png 1156w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>커맨드 목록을 보니, <strong>target-deregistered</strong>와 <strong>target-in-service</strong>에서 뭔가 원하는 해답을 찾을 수 있을 것 같은데요, 테스트를 진행하며 이 두가지를 더 자세하게 살펴보겠습니다.</p>\n<br/>\n<h2 id=\"target-deregistered\" style=\"position:relative;\"><a href=\"#target-deregistered\" aria-label=\"target deregistered permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>target-deregistered</h2>\n<h3 id=\"개념\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EB%85%90\" aria-label=\"개념 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개념</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABB0lEQVQoz42RUW+CMBSF+f//yUQTH32dCqFFaQEfQCoWqDr4lrLNkWzJPMmX3r6cc3NPcL/fsdbS9z1d19G2Lb1zvA8jXuM4/stcgVKKxWLBZrNhvV6zWi5520ecreNVzc2Dx+OBc+65oef29fe4X7Oj635m/86Ng7quiWNBnhf4baWUKK3JsgytNXmeT3OSJJxOJ7TOOByOKJUhhCRN1TNgMqyqiv0+RCmNFIJECkQck6ZHpBREYUgURcRxzHa7ZbfbEYbhFFSW5URRFHif6Ybe2Zgac7lQmoa6sdTNdaIyDY1tP4uancQzDMOftwx8wz6hPNeklaUw7URuWo7VFdPdXirju+0P0msXphOcRSEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2\"\n        title=\"2\"\n        src=\"/static/80733b9c3f405d945730d4d9fee45d40/37523/2.png\"\n        srcset=\"/static/80733b9c3f405d945730d4d9fee45d40/e9ff0/2.png 180w,\n/static/80733b9c3f405d945730d4d9fee45d40/f21e7/2.png 360w,\n/static/80733b9c3f405d945730d4d9fee45d40/37523/2.png 720w,\n/static/80733b9c3f405d945730d4d9fee45d40/302a4/2.png 1080w,\n/static/80733b9c3f405d945730d4d9fee45d40/6be49/2.png 1160w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><a href=\"https://docs.aws.amazon.com/cli/latest/reference/elbv2/wait/target-deregistered.html\">공식 문서</a>의 내용에 따르면, <code class=\"language-text\">InvalidTarget</code>이라는 상태가 호출될 때 까지 <strong>15초 단위로 총 40번 시도</strong>하는 것 같습니다. 그러면 일단 InvalidTarget이 실제 deregister-targets와 연관이 있는지 확인해볼 필요가 있겠고, describe-target-health를 먼저 호출해 보겠습니다. 명령어는 다음과 같습니다.</p>\n<blockquote>\n<p>15초 단위로 시도한다는 것을 봤을 때 이전 글에서의 15초와 연관이 있는 것 같다는 생각이 들어 살짝 소름돋았어요 ㅎㅎ</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 describe-target-health <span class=\"token punctuation\">\\</span>\n--target-group-arn <span class=\"token punctuation\">[</span>대상 그룹의 arn<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--targets</span> <span class=\"token assign-left variable\">Id</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>인스턴스 id<span class=\"token punctuation\">]</span> <span class=\"token comment\"># targets 옵션은 선택입니다. 입력하지 않아도 됩니다!</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.111111111111107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApUlEQVQY021QSRLCMAzr/x9Zyim0cUOzdT2IkRlDmOGgQyxFltyt6wrvBc49IDJjWRZwdhwH9n3HeZ7IOcN7r3xKSecG6lptZ48QnhjHEbV+zUxEkHfOIeeiPGem+2vIhMNw1ySWwrZTyBZ9f1NdCEGN2yY/htu2aYJpmiDzu1a7nSilqBlbECKiJ4gxIcao/2ut6Ghm7td1faq0sATkDXaKVseEL84jghHot2UPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3\"\n        title=\"3\"\n        src=\"/static/d891b6167f7321ee602a910eedc79241/37523/3.png\"\n        srcset=\"/static/d891b6167f7321ee602a910eedc79241/e9ff0/3.png 180w,\n/static/d891b6167f7321ee602a910eedc79241/f21e7/3.png 360w,\n/static/d891b6167f7321ee602a910eedc79241/37523/3.png 720w,\n/static/d891b6167f7321ee602a910eedc79241/302a4/3.png 1080w,\n/static/d891b6167f7321ee602a910eedc79241/07a9c/3.png 1440w,\n/static/d891b6167f7321ee602a910eedc79241/99e81/3.png 1946w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>왼쪽의 결과는 ELB가 트래픽을 보내고 있고, 인스턴스가 등록되어 있는 상태이고 오른쪽은 deregister-targets 호출 이후 실제 등록 취소가 완료된 상태에서의 결과입니다. 설명에 있는 InvalidTarget이라는 키워드는 없긴 한데, 추측하자면 TargetHealth.State로 판단하는 것 같습니다 ㅎㅎ</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAx0lEQVQY05VQyw6EIBDj/3/OQPS+KwIa3xcf8TGbdjOedyepAzK0pWZZFqnrWvq+Z2/bVpqm4TqlJN57wcyvZTBcliUvhhCJ1+st3gcJIUlKX5Gu64hhGCiOrnvFeZ5i1nWVEAIRY6IzCMDdcRyP8n3fhNZ1XQT+YQ7A2uAQ7pxz4pyVoijEWitZlkme5ySOMVIIUag43KlzFSYhPvM8cwiXNTs8QTMFYVVV7ACIt22Tfd8JOH0I8WRkMk0TScZxpAD2/5TG8QE3bMoWzz562gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4\"\n        title=\"4\"\n        src=\"/static/41545cc6b3dc3512b39666e8580bf0a8/37523/4.png\"\n        srcset=\"/static/41545cc6b3dc3512b39666e8580bf0a8/e9ff0/4.png 180w,\n/static/41545cc6b3dc3512b39666e8580bf0a8/f21e7/4.png 360w,\n/static/41545cc6b3dc3512b39666e8580bf0a8/37523/4.png 720w,\n/static/41545cc6b3dc3512b39666e8580bf0a8/302a4/4.png 1080w,\n/static/41545cc6b3dc3512b39666e8580bf0a8/07a9c/4.png 1440w,\n/static/41545cc6b3dc3512b39666e8580bf0a8/a8a6f/4.png 1516w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>사용 예시를 보면, 특정 타겟(인스턴스)를 지정하면 그 대상이 등록 취소될 때까지 멈추는 것 같네요. 이제 이 내용을 바탕으로 실제 테스트를 진행해 보겠습니다.</p>\n<h3 id=\"테스트\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">..</span> \n\n<span class=\"token assign-left variable\">START</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$SECONDS</span>\naws elbv2 <span class=\"token function\">wait</span> target-deregistered <span class=\"token punctuation\">\\</span>\n--target-group-arn <span class=\"token punctuation\">[</span>대상 그룹의 arn<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--targets</span> <span class=\"token assign-left variable\">Id</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>인스턴스 id<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">END</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$SECONDS</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"소요 시간: <span class=\"token variable\"><span class=\"token variable\">$((</span>$END <span class=\"token operator\">-</span> $START<span class=\"token variable\">))</span></span>\"</span></code></pre></div>\n<p>바로 이전에 있는 사용 예시를 보면 <code class=\"language-text\">The following wait target deregistered command pauses and continues only after..</code>  라는 내용이 있는데요, 위 스크립트를 실행하여 deregister-targets를 먼저 호출한 뒤 wait target-deregistered의 실행이 완료되는 시간을 측정해 보겠습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 272px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6UlEQVQoz5VSaQuCQBD1//8fKYQO0+yg6Ev0Qe3ASCPX/JL38WK2y0SMFoYZ3rx9y7xZIY5jUCRJgqa6GoS39SgLTRfq4m1CVTHKQpqmyLLsC6RMGPWoDsOQ4y8eRf6sifMl6LoMi+UKQRBAHqnY7vags9sfoE1m8LwrJKkHyzrC930uzhjDer2BrpsQxS5Mc4uyLB4jE1FRNTDPQ38gw+DNEqeTjdl8Acc5Q1HGuLgubNvB7RbwPByOoGlTdLoSdMNEnucfD6Mo4lH1hQhF8XiVejROndPkt1A1vW0p9QXVsbfgv9/j16bvVlhlWK66qkoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"5\"\n        title=\"5\"\n        src=\"/static/da39bef11e21e9a3a71c5bc4013ca8f9/2aae8/5.png\"\n        srcset=\"/static/da39bef11e21e9a3a71c5bc4013ca8f9/e9ff0/5.png 180w,\n/static/da39bef11e21e9a3a71c5bc4013ca8f9/2aae8/5.png 272w\"\n        sizes=\"(max-width: 272px) 100vw, 272px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>결과를 보면 <strong>16초</strong>가 걸렸는데요, 어라라..? 이전 글에서 15초 내로는 무조건 트래픽 중단(=등록 취소)이 된다고 한 것과는 다른 결과가 나왔습니다. 그래서 한번 더 테스트를 진행해볼건데, 이번에는 1초 단위로 실제 요청을 보내면서 실제 503 응답까지의 소요 시간도 측정해볼게요.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoklEQVQY05VPyw6DIBDk/79Qa7ECiko0kYcvOEzDWr33MNl5ZTfL6k+DphEQUoHzGm2nMY4GQkho3aPTGlXFoVRL+u5LqTBNE/E3r2GMQVGUYCEEOOexriu899i2jZB1yPjleXofsCwLrHVwzlHHWkteCFeXHceBfd8J53lSkL0YI+k8L1w8pfh4d55SejgbhpFe6fsB8zyjLF90ORfy4n/xBeSaMTnJ9IhJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"6\"\n        title=\"6\"\n        src=\"/static/d7e6929209a19f1503c039f6ad0b81ad/37523/6.png\"\n        srcset=\"/static/d7e6929209a19f1503c039f6ad0b81ad/e9ff0/6.png 180w,\n/static/d7e6929209a19f1503c039f6ad0b81ad/f21e7/6.png 360w,\n/static/d7e6929209a19f1503c039f6ad0b81ad/37523/6.png 720w,\n/static/d7e6929209a19f1503c039f6ad0b81ad/90712/6.png 882w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>deregister-targets는 <strong>27분 30초</strong>에 호출되었고, 이번에도 똑같이 <code class=\"language-text\">wait target-deregistered</code> 가 완료되는 시간은 <strong>16초</strong>가 걸렸는데요,</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 5.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAANUlEQVQI1z2KQQ4AIAzC/P9bHbD5AMwW44E0bVgA3ZPyUc7McVK/kxwHMJ8dYXSTHIHpVccXBNhL/IeLGPcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"7\"\n        title=\"7\"\n        src=\"/static/c696b0fa4084dc67dd41c8d156ed2ae3/37523/7.png\"\n        srcset=\"/static/c696b0fa4084dc67dd41c8d156ed2ae3/e9ff0/7.png 180w,\n/static/c696b0fa4084dc67dd41c8d156ed2ae3/f21e7/7.png 360w,\n/static/c696b0fa4084dc67dd41c8d156ed2ae3/37523/7.png 720w,\n/static/c696b0fa4084dc67dd41c8d156ed2ae3/302a4/7.png 1080w,\n/static/c696b0fa4084dc67dd41c8d156ed2ae3/07a9c/7.png 1440w,\n/static/c696b0fa4084dc67dd41c8d156ed2ae3/29114/7.png 1920w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>1초 단위로 요청을 보내면서 503 응답이 온 최초의 시점을 보면 <strong>27분 43초</strong>로 실제 트래픽 중단은 deregister-targets 호출 후 <strong>13초</strong>가 지난 시점에서 이뤄진 것을 확인할 수 있었습니다. 이 결과로 생각해보면, wait 명령어도 약간의 딜레이는 있다고 생각할 수 있을 것 같습니다.</p>\n<p>그러면 이번에는 실제로 딜레이가 있는건지 확인해볼게요.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">..</span> \n<span class=\"token function\">sleep</span> <span class=\"token number\">15</span>\n\n<span class=\"token comment\"># 이후 내용은 동일합니다. </span></code></pre></div>\n<p>이전에 sleep 15가 끝나는 시점에서는 ELB의 트래픽 중단, 즉 등록 취소가 완료될 것이라고 예상했는데요, 그러면 sleep 15 이후에 호출되는 wait target-deregistered는 빠른 시간 내에 완료가 되어야 하겠네요!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 254px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABDklEQVQoz7VSTUvDQBTc//8zevDUgwdFxYKKl4qgPdRqTQppkm2soWk2SbPZfDDyHmwoFnoQG5hkmcl7OztvhTEG/wlxkoZVVR3gr7ygV13XDCLbtuW15ZumYb7rOtZsMYE0wj4vqGi7TaFUhrIs4XlL5HnOP2ZZjij6QrHbwXEXCKVknoq11lBKIQwlXHfR84IW9w+PGD89YxVFGAzOuCk907cZLi6vsF5/4/rmFrP3D2w2CYIgRG0MXl4nGI3uMBye96fiDH0/gJQrdvrpuPwlvigKdpCmKeZzB3Ecs/skSVgnzlv6vAE55iNTV8qAnNIulNV+hjZTmyXB6qRZ9EP5PTWtj0/z2LRPcg9/AK09AjEA6bOdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"8\"\n        title=\"8\"\n        src=\"/static/17bd7e2349352807f51429a469a10570/6a91e/8.png\"\n        srcset=\"/static/17bd7e2349352807f51429a469a10570/e9ff0/8.png 180w,\n/static/17bd7e2349352807f51429a469a10570/6a91e/8.png 254w\"\n        sizes=\"(max-width: 254px) 100vw, 254px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>sleep 15를 포함한 위 스크립트를 돌려보면, <strong>소요 시간이 1초</strong>로 사실상 wait의 호출과 동시에 완료되었다고 할 수 있겠네요.</p>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<p><code class=\"language-text\">wait target-deregistered</code> 명령어를 호출하면, 실제로 인스턴스가 등록 취소(deregister)될때까지 기다린 후 그 이후의 명령어를 실행합니다. 실제 트래픽이 중단되는 시간보다는 약간의 딜레이가 있긴 하지만, wait 명령어가 완료되는 시점에서는 트래픽이 반드시 중단된다고 할 수 있습니다. 즉, 이전의 0.000021%로 추측한 약간의 가능성도 완전히 차단할 수 있겠습니다.</p>\n<br/>\n<h2 id=\"target-in-service\" style=\"position:relative;\"><a href=\"#target-in-service\" aria-label=\"target in service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>target-in-service</h2>\n<h3 id=\"개념-1\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EB%85%90-1\" aria-label=\"개념 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개념</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABNklEQVQoz5VR2W7CMBD0//8bCEHs3HHshFBoQw7ihASSqdYI+tJW7Uqj2UMa76xZGIZIkgRpmsL3fVCttcYwDKBYluVPeAZzHAer1Qqcc6zXa2w2Gwgh0LYt/hNPYXa/321jnme71e12s4NpmmCMQd/3lgk0f9Sd5b7/mi/L/BCMosjaJN5utwiC4GWdmLb1PM86IPY8H0EQgnMBIVwI4cF1PRTFAeM4geV5Dikl4jiG0hr7/R5JIm1PKYUsy+xN6UFi6pFgHCeQMgXnLpTS2O0cK8qKorBieZ5BpxJ5lkEmMVSaIgoDaKWsGG1L29PnPe3SCcju9Xq1+TiOYE3ToK4q1G2HU93hfDEvfDQd6q63d6WbEij/LVhZljge33CqWuSVwbHpcagNitogO3d4vww//uh3+ARPsV0UaXy6WQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"9\"\n        title=\"9\"\n        src=\"/static/349d0e9eec0ff17f5644ab8cfc324924/37523/9.png\"\n        srcset=\"/static/349d0e9eec0ff17f5644ab8cfc324924/e9ff0/9.png 180w,\n/static/349d0e9eec0ff17f5644ab8cfc324924/f21e7/9.png 360w,\n/static/349d0e9eec0ff17f5644ab8cfc324924/37523/9.png 720w,\n/static/349d0e9eec0ff17f5644ab8cfc324924/302a4/9.png 1080w,\n/static/349d0e9eec0ff17f5644ab8cfc324924/2cffa/9.png 1092w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><a href=\"https://docs.aws.amazon.com/cli/latest/reference/elbv2/wait/target-deregistered.html\">공식 문서</a>의 내용에 따르면, target-in-service는 타겟(인스턴스)의 상태가 ‘<code class=\"language-text\">healthy</code>’가 나올 때 까지 15초 단위로 총 40번 요청을 보내면서 대기하는 명령어입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.111111111111107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApUlEQVQY021QSRLCMAzr/x9Zyim0cUOzdT2IkRlDmOGgQyxFltyt6wrvBc49IDJjWRZwdhwH9n3HeZ7IOcN7r3xKSecG6lptZ48QnhjHEbV+zUxEkHfOIeeiPGem+2vIhMNw1ySWwrZTyBZ9f1NdCEGN2yY/htu2aYJpmiDzu1a7nSilqBlbECKiJ4gxIcao/2ut6Ghm7td1faq0sATkDXaKVseEL84jghHot2UPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"10\"\n        title=\"10\"\n        src=\"/static/d891b6167f7321ee602a910eedc79241/37523/10.png\"\n        srcset=\"/static/d891b6167f7321ee602a910eedc79241/e9ff0/10.png 180w,\n/static/d891b6167f7321ee602a910eedc79241/f21e7/10.png 360w,\n/static/d891b6167f7321ee602a910eedc79241/37523/10.png 720w,\n/static/d891b6167f7321ee602a910eedc79241/302a4/10.png 1080w,\n/static/d891b6167f7321ee602a910eedc79241/07a9c/10.png 1440w,\n/static/d891b6167f7321ee602a910eedc79241/99e81/10.png 1946w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이전에 target-deregistered에서 확인했던 describe-target-health 결과를 다시 확인해보면, 이 JSON 응답에 있는 <code class=\"language-text\">TargetHealth.State</code> 를 확인하는 것 같습니다.</p>\n<blockquote>\n<p>그리고 등록 취소된 인스턴스를 register-targets로 재등록 요청시, 오른쪽 사진의 상태가 되고 <strong>최초의 헬스체크 통과시 다시 트래픽이 전달</strong>됩니다.</p>\n</blockquote>\n<p>위의 내용은 이전 글에 작성한 내용인데요, <code class=\"language-text\">wait target-in-service</code> 명령어를 이용하면 실제 register-targets 호출 후 트래픽 전달까지의 소요 시간도 측정할 수 있겠네요 ㅎㅎ</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA0klEQVQY05VQyYqFMBDM/3+coEdBxSUxbnGJ48GtHtWg8OYyTENRnaRTqYqa5xnGGHRdh7qu0TQttNYoyxJVpaVv2xbWWuz7jvM8XxzH8QXuqWEYUBSFCBhTQ2sDaxt4/wPnRkzThL7vBXyU8+wfHsfx7WlOee9FjKBDMg+XZcF93/hvqeu6kKYpgiBAFEUIw/BFHMdIkgRZlgnneS7MfX4TDRB8nEUDitnXdRW7jMdD8rZtEocJuGYs55z0nOW9R+RhEaTY8wcELxEU+6t+izHyB/WzydF8Ga2dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"11\"\n        title=\"11\"\n        src=\"/static/490e7858c8e16b6492d0b40f4a71ad35/37523/11.png\"\n        srcset=\"/static/490e7858c8e16b6492d0b40f4a71ad35/e9ff0/11.png 180w,\n/static/490e7858c8e16b6492d0b40f4a71ad35/f21e7/11.png 360w,\n/static/490e7858c8e16b6492d0b40f4a71ad35/37523/11.png 720w,\n/static/490e7858c8e16b6492d0b40f4a71ad35/302a4/11.png 1080w,\n/static/490e7858c8e16b6492d0b40f4a71ad35/07a9c/11.png 1440w,\n/static/490e7858c8e16b6492d0b40f4a71ad35/8b640/11.png 1454w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>사용 예시는 이전의 target-deregistered와 동일하고, 바로 테스트를 진행하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets<span class=\"token punctuation\">..</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">15</span>\n\naws elbv2 register-targets <span class=\"token punctuation\">..</span>\n\n<span class=\"token assign-left variable\">START</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$SECONDS</span>\naws elbv2 <span class=\"token function\">wait</span> target-in-service <span class=\"token punctuation\">\\</span>\n--target-group-arn <span class=\"token punctuation\">[</span>대상 그룹의 arn<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--targets</span> <span class=\"token assign-left variable\">Id</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>인스턴스 id<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">END</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$SECONDS</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"소요 시간: <span class=\"token variable\"><span class=\"token variable\">$((</span>$END <span class=\"token operator\">-</span> $START<span class=\"token variable\">))</span></span>\"</span></code></pre></div>\n<p>이 스크립트는 우선 deregister-targets와 sleep 15로 인스턴스를 등록 취소하고, <code class=\"language-text\">register-targets</code>를 호출한 뒤 <code class=\"language-text\">wait target-in-service</code> 가 완료되는 시간을 측정하는 스크립트입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 296px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA50lEQVQoz61R7QrCMBDb+7+Q4C+Hoijit845p+ImirLh3Gz3HbnCpBUFBQuh17S5C6mWJAniOFbwjvuGp12rCkKapgIqlyDLMkUkN3rlNZmIogjB7fZ8yBhHdL/D931wzpVhNIQ4xpjqMM9zTKYzWNYa5spCq9VGWZY4Hk9o6E04jgtdb8I9HHA+X8B5DGNpotfro1aro93pghY1fzq07Y0Q7h0X84UhnIRhiM12J5oYholrEMDzPCGy1jZGowkGw7HQyjGIDMl+lR85Jo7qoijEXmVYgc50R6BazlP75Zc/QXEoT/4HHl03Z6Ok9Xe1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"12\"\n        title=\"12\"\n        src=\"/static/893fb0282e3b35abc0abeab04eb4661d/b1a44/12.png\"\n        srcset=\"/static/893fb0282e3b35abc0abeab04eb4661d/e9ff0/12.png 180w,\n/static/893fb0282e3b35abc0abeab04eb4661d/b1a44/12.png 296w\"\n        sizes=\"(max-width: 296px) 100vw, 296px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이번에도 지난번과 동일하게 16초가 소요되었네요. 16초라는 시간은 추측해보면 <strong>최초 확인 → 15초후 재확인 → 통과</strong>의 흐름에서의 소요 시간인 것 같아요. 이번에도 지난번과 동일하게 실제로 요청을 보내면서 실제로 응답이 오는 최초 시간을 측정해 보겠습니다. 이번에는 describe-target-health도 1초마다 호출하여 실제 상태가 어떻게 나오는지도 같이 관찰해볼게요.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.666666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWUlEQVQI122MOw7AMAhDe/+DJpDwSddkcGWqbh2QscHvylwQUcxpUH3VzDHGLI1IiAg8Au4O1VHKXu9SP8zIOOfgWuuGEGRWh3+gIjPLc/+ArfXqMefsvfEAlRiWlKGZa9kAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"13\"\n        title=\"13\"\n        src=\"/static/a33cbf0e423fff9f2de2e42cde651143/37523/13.png\"\n        srcset=\"/static/a33cbf0e423fff9f2de2e42cde651143/e9ff0/13.png 180w,\n/static/a33cbf0e423fff9f2de2e42cde651143/f21e7/13.png 360w,\n/static/a33cbf0e423fff9f2de2e42cde651143/37523/13.png 720w,\n/static/a33cbf0e423fff9f2de2e42cde651143/90712/13.png 882w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxklEQVQY022RwQ6DMAxD+/8fyQ5MGyMtUFooFJAnh/XCOFgC8mInwYzjiBAiQghIKWHbtlsdx4EYI04+aE/O+Y8zXddDROBcp+CyLLcqhmItrHXo+14HuHKGKc45iFj9sK7rrfZ9x5YzpmlC24pOWmr0KM9q+Hq9UVUPNM1Hp5znWdNTWlQMoiFZ1snW9VMHYUCM049PMHQdBq9mnJLp1lp477WZNa7KlcmyqRXRM5FViSjPqQ3Tr8fle1FZiYbnndbbn1bYL/Df0FBllIkKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"14\"\n        title=\"14\"\n        src=\"/static/c933a2b92dec38b857ace2046653b88a/37523/14.png\"\n        srcset=\"/static/c933a2b92dec38b857ace2046653b88a/e9ff0/14.png 180w,\n/static/c933a2b92dec38b857ace2046653b88a/f21e7/14.png 360w,\n/static/c933a2b92dec38b857ace2046653b88a/37523/14.png 720w,\n/static/c933a2b92dec38b857ace2046653b88a/302a4/14.png 1080w,\n/static/c933a2b92dec38b857ace2046653b88a/07a9c/14.png 1440w,\n/static/c933a2b92dec38b857ace2046653b88a/f69df/14.png 1762w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmElEQVQ4y5VTaY+CQAz1//88s2jklsuDhRkuDzDp5lXKuoy68UNTpimvfX3toihKiqKYXNejOEnIth1K0pTiOKEw3LLl+feUAz8MPV2vV8P6vqfF+XymruuoaRpqmpbaFtZxDIb36XSilnNajuHny+ViGOKLqqr4AeBhGNhQCYb49B47gCH3EUQKMCA+kHQ85kx3s7GZmh+EtLEdjmXZjnw/YPpBEJJSivTYiAHYjw+AIlEpzZQxAsThQRO00Rn8vLs/gI/zkMECINxGZK3W3Gld11zsGYjEDMB5JQBDUcf1SGlNu/2eRwCR5mAvAcWDGgDLsqTtNqKiKHh10ixjkZAj/m2Hd1UBpBgA85IZtuMagT58qdTTbg3AuzialssvchyXbMdl5b+sFat/OBxZtGBc+P4/QKGcphlZ1pqBMDvP8/mC8jznUaC7x/9eqgwDVXSqteYZJmnG1AGGfYRYKPgWEACyY/gZHSCGmcKL8nJNcs+GKHJicrcC9Ope57drrA0GjEdV1cbCfmoTIDq63W7T8f/S+tx+AA9b0DgCWx9dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"15\"\n        title=\"15\"\n        src=\"/static/cee843907aa39eb7500326a03f7d86af/37523/15.png\"\n        srcset=\"/static/cee843907aa39eb7500326a03f7d86af/e9ff0/15.png 180w,\n/static/cee843907aa39eb7500326a03f7d86af/f21e7/15.png 360w,\n/static/cee843907aa39eb7500326a03f7d86af/37523/15.png 720w,\n/static/cee843907aa39eb7500326a03f7d86af/3c051/15.png 760w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>register-targets는 26분 40초에 호출</strong>했고, 이전까지는 왼쪽의 사진처럼 unused 상태였다가 바로 initial 상태로 변경되었고, 이후 register-targets 호출 후 <strong>약 14초가 지난 시점인 26분 54초부터 상태가 ‘healthy’로 변경</strong>되었습니다.</p>\n<p>그러면 실제 트래픽은 언제부터 보내졌을까요?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.555555555555557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXklEQVQI1z2N2w6AMAxC/f/v1LW062a8vWI6zR5IgJDD0sMIXekmNJSpvdfROYRhSpWVjsKoYEAZELawkVuAvTmf++CSBrqNsVv5vMkEJrz+wPrDs8uj8+i8zn0qgS9YyJYRs+nZ6gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"16\"\n        title=\"16\"\n        src=\"/static/584c8fb407a346f187bedaae141005b6/37523/16.png\"\n        srcset=\"/static/584c8fb407a346f187bedaae141005b6/e9ff0/16.png 180w,\n/static/584c8fb407a346f187bedaae141005b6/f21e7/16.png 360w,\n/static/584c8fb407a346f187bedaae141005b6/37523/16.png 720w,\n/static/584c8fb407a346f187bedaae141005b6/302a4/16.png 1080w,\n/static/584c8fb407a346f187bedaae141005b6/07a9c/16.png 1440w,\n/static/584c8fb407a346f187bedaae141005b6/fa60d/16.png 1792w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위의 로그를 확인해보면, 52초까지의 요청은 503 응답이 나가다가 53초의 요청부터는 정상 응답이 반환되었습니다.</p>\n<h3 id=\"결론-1\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0-1\" aria-label=\"결론 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<p><code class=\"language-text\">wait target-in-service</code> 명령어를 호출하면 <strong>인스턴스가 healthy 상태가 될 때 까지</strong> 기다린 뒤 그 이후의 명령어를 실행하고, 실제 트래픽이 배분되기 시작하는 시간보다는 약간의 딜레이가 있음을 확인하였습니다. 즉 이전의 target-deregistered와 동일한 결과이며, wait target-in-service가 완료되는 시점부터는 인스턴스가 ELB의 트래픽을 정상 수신할 수 있습니다.</p>\n<br/>\n<h2 id=\"배포-스크립트-최종-수정\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%B5%9C%EC%A2%85-%EC%88%98%EC%A0%95\" aria-label=\"배포 스크립트 최종 수정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배포 스크립트 최종 수정</h2>\n<p>이전 글에서는 등록 취소를 위주로 다뤘습니다. 배포 과정이 완료되고 register-targets을 호출한 뒤에는 sleep을 걸지 않았던 이유는 두 번째 인스턴스의 배포가 시작되고, 이 인스턴스의 등록 취소가 진행되는 사이에 배포가 완료된 인스턴스가 트래픽을 받는다는 생각이었습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.111111111111107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6UlEQVQY02WQyW7DMAxE/f+/11NPQZekTiR5Fa2N0ius9BCgBAlu4MyAAy+Wi5JLxUtgWXemeSWm3OcpFyRkYkpIEEIMHDEg4aCU0u9bawxn471n9x63CKNZ+B5dj8+b4XqfuNsNOx9crjPrfhBifILFAx+E/AqYUuLxMFjrOOt1XbHOEUJg27a+k8NTyCiFqAGpHt13ipvRaSEbS3oYmiqDqnL7GRnHe5d+Ahtju2ovgrUTTgxX+eBzufDlL7zvb8QkUBu11q6s/eWhqiIieC99kHPucRKdBKdqLUqrjRQTtbbnw1v3f/YLGF6DueatADcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"17\"\n        title=\"17\"\n        src=\"/static/3e86d066b7f030b3b611e56696759f4b/37523/17.png\"\n        srcset=\"/static/3e86d066b7f030b3b611e56696759f4b/e9ff0/17.png 180w,\n/static/3e86d066b7f030b3b611e56696759f4b/f21e7/17.png 360w,\n/static/3e86d066b7f030b3b611e56696759f4b/37523/17.png 720w,\n/static/3e86d066b7f030b3b611e56696759f4b/302a4/17.png 1080w,\n/static/3e86d066b7f030b3b611e56696759f4b/07a9c/17.png 1440w,\n/static/3e86d066b7f030b3b611e56696759f4b/daf05/17.png 2672w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그림을 보면, 초록색 점선 시점부터는 배포가 완료된 인스턴스가 트래픽을 수신할 수 있으니 첫 번째 배포가 마무리 된 이후에는 sleep을 진행하기 보다는 빠르게 두 번째 인스턴스의 배포를 시작하는게 좋다는 생각이었습니다.</p>\n<p>하지만 이 방법도 ELB의 트래픽 배분까지의 소요 시간이 15초를 초과할 0.000021%의 확률처럼 불확실성을 완전히 해소하는 방법은 아니라고 생각해요. 따라서 지금까지의 내용을 바탕으로 배포 과정을 다시 정리해 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">..</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">15</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인\n\naws elbv2 register-targets <span class=\"token punctuation\">..</span></code></pre></div>\n<p>위에 있는 스크립트가 이전 편에서의 결과였고, 전체적으로 비슷하지만 다음 내용을 수정하겠습니다.</p>\n<ol>\n<li><code class=\"language-text\">sleep 15</code> → <code class=\"language-text\">aws elbv2 wait target-deregistered</code> 로 수정</li>\n<li><code class=\"language-text\">curl을 이용한 헬스체크</code>를  <code class=\"language-text\">aws elbv2 wait target-in-service..</code> 로 대체</li>\n</ol>\n<p>즉 스크립트가 다음의 형태로 바뀌게 되고,</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">..</span>\naws elbv2 <span class=\"token function\">wait</span> target-deregistered <span class=\"token punctuation\">..</span>.\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n\naws elbv2 register-targets <span class=\"token punctuation\">..</span>\naws elbv2 <span class=\"token function\">wait</span> target-in-service<span class=\"token punctuation\">..</span></code></pre></div>\n<p>바뀐 형태에서는 아래 내용을 확신할 수 있겠습니다.</p>\n<ol>\n<li><code class=\"language-text\">kill [기존 springboot]</code>를 호출하는 시점에서는 <strong>더 이상 ELB가 트래픽을 보내지 않는다</strong>.</li>\n<li>두 번째 인스턴스의 배포를 시작할 때, <strong>배포가 완료된 첫 번째 인스턴스는 ELB가 보내는 트래픽을 정상 수신하는 것이 보장</strong>된다.</li>\n</ol>\n<p>마지막의 wait에는 <strong>적절한 타임아웃을 걸어 특정 시간 내에 완료되지 않으면 배포를 중단</strong>(exit 1)하는 코드를 추가할 수 있을 것 같습니다 ㅎㅎ 이건 각자의 운영 환경에 맞게 정하면 될 것 같아요.</p>\n<br/>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>길고 길었던(<del>그리고 커피 한 잔 만큼의 서버비용이 나간..</del>) 정리가 드디어 끝났습니다👏👏 다시한번 말씀드리자면 Deregister 과정은 IAM 권한이 필요한 작업이고, 우아한테크코스에서 제공하는 AWS를 사용하고 있는 현재 프로젝트에서 적용할 수 있는 방법은 아닙니다.</p>\n<p>그럼에도 이번 과정을 진행하며 기존에 했던 배포의 전 과정을 다시 돌아볼 수 있었고, IAM 권한이 있는 AWS 계정을 사용한다면 배포 과정을 조금 더 효율적으로 구성할 수 있다는 점에서 정말 보람찬 과정이었다고 생각합니다 ㅎㅎ</p>\n<p>읽어주셔서 감사합니다 😄</p>","excerpt":"배경 이번 글에서 다루는 deregister-targets 등의 개념은 1편에 작성되어 있습니다..ㅎㅎ 1편을 먼저 읽고 이번 글을 읽어주시면 감사하겠습니다. 지난 글에서 통계량을 이용해 deregister-targets 호출 이후 실제 트래픽 중단까지 소요되는 최대 시간을 15초로 잡았었습니다. 지난번에 계산했던 트래픽 중단까지의 시간이 15초를 초과할 확률은 0.000021% 로 극히 미미한 수준이지만, 그럼에도 발생 가능성이 있다는 찝찝함은 있었던 것 같습니다. 그래서.. aws-cli의 elbv2 API 문서를 하나씩 살펴보던 도중 wait이라는 키워드를 발견했는데요, 이번 글에서는 wait을 이용하여 기존의 불확실성을 더 개선하는 방법을 소개하겠습니다. wait API Wait until a particular condition is satisfied. Each subcommand polls an API until the listed requirement is met. 공…","frontmatter":{"date":"November 12, 2024","title":"무중단 배포 과정에서의 불확실성 개선 [2] - AWS CLI의 wait API 적용","categories":"level4 aws deregister wait","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/improving_deployment/3/"}},"next":{"id":"fb8e534b-6253-5881-85b7-98290bffa9df","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>기존 방법은, <strong>의도적으로 헬스체크에 실패하도록 하는 API를 호출하여 ELB(로드 밸런서)의 트래픽 배분을 막는 방법</strong>이었습니다. 팀원인 테니가 상황에 맞게 훌륭하게 구현해줬고, 문제될 여지가 거의 없다고는 느껴지지만 아래의 불확실성은 있다는 생각이 들었습니다.</p>\n<ol>\n<li>해당 API의 호출 시점, 그리고 서버의 상황에 따라 <strong>실제 트래픽 중단까지 최대 10초에 가까운 시간 차이가 발생</strong>합니다.</li>\n<li>배포 작업이 애플리케이션의 영향을 받습니다. 현재는 API를 호출하여 healthcheck에 사용되는라 불리언 필드를 false로 바꿔 헬스체크에 실패하도록 하고 있는데, 이걸 다시 true로 바꾸는 기능은 없습니다. 즉 배포 과정에서의 사소한 실수로 불필요하게 해당 API가 호출된다면 Springboot를 다시 배포해야 합니다.</li>\n</ol>\n<p>두개의 원인을 보면 결국 <strong>API를 다른 무언가로 대체</strong>하는 것이 해결 방법인 것 같은데요, 물론 다른 해결 방법도 있겠지만 이번 글에서는 AWS CLI에서 사용하는 <strong>Deregister</strong>라는 방법을 이용해 보겠습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxUlEQVQY0zWQC4uDMBCE/f8/7g5aH0mMxjzUmPO0hdoWBKfsSheGWT4myW4yHwb8/F4glUYlawhZoygFKqGYCaWRFwJCalzyEkUpYTqHlGaMcYIPPdbbHVTHcSCb5wXGWDgfEPoBMSZ433NPj4V+RGA/ZV1AnBIe24Zte7LTRd/K5v8FujGs1lhWZx2atmOm6oa91i0z6zwzmp6cNKU/LOsNr9cb2TBGXPOKw1KdhylMIlZWkllnPX/Hl5/5M0cb0rT7vuMDCO4kgLL3AVkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/929388051d273fbbdb3566cf488c222d/37523/1.png\"\n        srcset=\"/static/929388051d273fbbdb3566cf488c222d/e9ff0/1.png 180w,\n/static/929388051d273fbbdb3566cf488c222d/f21e7/1.png 360w,\n/static/929388051d273fbbdb3566cf488c222d/37523/1.png 720w,\n/static/929388051d273fbbdb3566cf488c222d/302a4/1.png 1080w,\n/static/929388051d273fbbdb3566cf488c222d/07a9c/1.png 1440w,\n/static/929388051d273fbbdb3566cf488c222d/bd9eb/1.png 1442w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><a href=\"https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/APIReference/API_DeregisterTargets.html\">AWS 공식 문서</a>에서는 Deregister를 위와 같이 소개하고 있습니다. 이 글의 target에 EC2 인스턴스를 대입하면, “<strong>대상 그룹에 등록된 인스턴스를 등록 취소하여 로드 밸런서가 보내는 트래픽을 받지 않도록 한다</strong>” 라는 뜻이고, 이때 사용되는  Deregistration Delay는 이름 그대로 서버가 <strong>in-flight 요청</strong>(이미 들어와서 처리중인 요청)을 처리할 수 있도록 Deregister를 지연하는 값입니다.</p>\n<blockquote>\n<p>Deregistration Delay에 대한 개념은 <a href=\"https://karansingh.gitbook.io/aws-saa-c02/elb/connection-draining-deregistration-delay\">링크</a>를 참고해주세요!</p>\n</blockquote>\n<p>따라서, 이번 글에서는 <strong>aws-cli</strong>를 이용한 Deregister와 Deregisteration Delay를 직접 적용해볼 예정이고, 글의 흐름은 다음과 같습니다.</p>\n<ol>\n<li>Deregister 적용 및 확인</li>\n<li>확인 과정에서 판단한 문제</li>\n<li>이 문제의 원인 분석 및 해결 방법</li>\n</ol>\n<p>그리고 이후의 내용에서는 <strong>Deregister =</strong> <strong>등록 취소</strong> / <strong>Deregistration Delay =</strong> <strong>등록 취소 지연</strong>으로 통일하여 사용할 예정입니다 😄</p>\n<h3 id=\"주의\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EC%9D%98\" aria-label=\"주의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주의</h3>\n<ol>\n<li>이 방법을 이용하기 위해서는 <strong>ELB에 대한 IAM 권한 및 액세스 키가 필요</strong>합니다. 현재 프로젝트에서는 우아한테크코스에서 제공하는 AWS를 사용하고 있고, 현재는 해당 권한이 없어 프로젝트에 적용할 수 있는 방법이 아닙니다.</li>\n</ol>\n<blockquote>\n<p>리뷰를 할 때는 IAM 액세스 키를 사용할 수 없다는 걸 몰랐습니다..ㅠ 팀원 테니에게 죄송하다는 말씀 먼저 드립니다..</p>\n</blockquote>\n<ol start=\"2\">\n<li>본 글에서는 해당 과정을 실제 적용해보는 과정을 위주로 다룹니다. 따라서 AWS-CLI를 우분투에 설치하고 IAM을 등록하는 등의 과정은 생략합니다.</li>\n</ol>\n<br/>\n<h2 id=\"인스턴스-등록-취소하기\" style=\"position:relative;\"><a href=\"#%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C%ED%95%98%EA%B8%B0\" aria-label=\"인스턴스 등록 취소하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인스턴스 등록 취소하기</h2>\n<h3 id=\"등록-취소-지연-시간-설정\" style=\"position:relative;\"><a href=\"#%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C-%EC%A7%80%EC%97%B0-%EC%8B%9C%EA%B0%84-%EC%84%A4%EC%A0%95\" aria-label=\"등록 취소 지연 시간 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>등록 취소 지연 시간 설정</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAtUlEQVQoz6VQ0Q6CMAzk/78QRcYgIiYqcZGtGxucaQXjiz5gk0svvfXWNitLhX1RIM93YN73PWKMCCFsQqbrGlWloVSFpmlgjEFKabvhNE2Y51nARjwd41vwu19appSGqjQOpXrnrjuDvMdjGGCtg3UOjgjOkUzBtWGtO8JgrfCJDY/tCXdjpJlzGEd4H0CLAWfvvYDIi04Ld6KF12dE4G2z9tThcr0hxiQr/xtyw0+j9Z5b8QRiJyGstUaaqAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2\"\n        title=\"2\"\n        src=\"/static/05b64a5ae801a71f3e9ced630c62dd3d/37523/2.png\"\n        srcset=\"/static/05b64a5ae801a71f3e9ced630c62dd3d/e9ff0/2.png 180w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/f21e7/2.png 360w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/37523/2.png 720w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/302a4/2.png 1080w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/cf8e5/2.png 1402w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>등록 취소 지연값은 <code class=\"language-text\">EC2 → 대상 그룹 → 하단의 속성 탭 → 속성 편집</code>에서 설정할 수 있고, <code class=\"language-text\">기본값은 300초</code> 입니다.</p>\n<h3 id=\"aws-cli에서의-등록-취소-및-재등록-명령\" style=\"position:relative;\"><a href=\"#aws-cli%EC%97%90%EC%84%9C%EC%9D%98-%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C-%EB%B0%8F-%EC%9E%AC%EB%93%B1%EB%A1%9D-%EB%AA%85%EB%A0%B9\" aria-label=\"aws cli에서의 등록 취소 및 재등록 명령 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWS-CLI에서의 등록 취소 및 재등록 명령</h3>\n<p>다음으로, aws-cli에서 인스턴스를 등록 취소하기 위해 아래 명령어를 입력합니다. 재등록 하는 경우는 deregister-targets만 <code class=\"language-text\">register-targets</code> 로 바꿔주시면 됩니다 !</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">\\</span>\n--target-group-arn <span class=\"token punctuation\">[</span>대상 그룹의 arn<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--targets</span> <span class=\"token assign-left variable\">Id</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>트래픽을 중단할 EC2의 인스턴스 ID<span class=\"token punctuation\">]</span></code></pre></div>\n<p>여기서 대상 그룹의 arn은 사용하시는 대상 그룹 상세 페이지로 들어가면 ‘세부 정보’ 바로 아래 있는 arn으로 시작하는 값입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAR0lEQVQI153MMQ6AMAwEwfz/YZAvhIoQIL5Qu7Al65Ao6KEYbbeplIXTnCkCRgTN7OHub79Ia93Y9oNnF2Jc7AICg6r6a3oDlK+aaXA8yFsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3\"\n        title=\"3\"\n        src=\"/static/a04a037e70ad93430fcd01cf3cb848e0/37523/3.png\"\n        srcset=\"/static/a04a037e70ad93430fcd01cf3cb848e0/e9ff0/3.png 180w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/f21e7/3.png 360w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/37523/3.png 720w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/302a4/3.png 1080w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/4352a/3.png 1364w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>ARN은 AWS 리소스의 고유 식별자입니다. 리소스를 명료하게 지정하는 경우 사용합니다.</p>\n</blockquote>\n<p>deregister 또는 register를 호출했을 때, aws 콘솔에 나오는 상태를 확인해 보겠습니다.</p>\n<table>\n<thead>\n<tr>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 676px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPUlEQVQoz5VS2W6DMBDk/z+rVR+bVKqSAEEp2EC4Ei4fEApTrVNSpVcUS+Nd2ePxej0WAASMYb3egDGOje1Aa03LmKYJ9wziW5SQ0GL5YqJtOxBCXAj3gIZ1GgYQxmlC3/cY3gcopSCkvAnddeg+QbmpsD+dkGY50ixD3TQo69rEW2jaFnGSIIwiBJyjqutzhaTsuC62ngep1IX8H4jTCoHX1QrPiyUeHp+QF8VZkCqk8qWShkS4JTjjfO6rPebJ4zjicCxRVjXKqjIgEglr3Zkfl1KZHimlTX9pX9G6UmafiqJ/MII0+YwjzQvskwwBD5EXByRphrWzBQ9j7PwAbz6D7XqG6+18sDDCPs1QHI5X1jGCdJhHMcIoxrGsrnw124EiveYv/82wxnFC0wojRLcJIX+Y+nv+m/9mH34Ar/EDvrlKxS8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4\"\n        title=\"4\"\n        src=\"/static/6c54a21335464d673632c715539c1b0e/9bb7a/4.png\"\n        srcset=\"/static/6c54a21335464d673632c715539c1b0e/e9ff0/4.png 180w,\n/static/6c54a21335464d673632c715539c1b0e/f21e7/4.png 360w,\n/static/6c54a21335464d673632c715539c1b0e/9bb7a/4.png 676w\"\n        sizes=\"(max-width: 676px) 100vw, 676px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABD0lEQVQoz5WR6W6DMBCE8/4vV0Vt/yQEAiaYKxzhsI0xU+0iqtI2lYo0Mtodf3v4AADLsiCMIggRIwiukDLFFv/PR/7D9nPxA5w9j4FCCDY45zj3mxzJuU/PDjhZCzvPmKYJ2hgordH1/Z8axpG9m3+DMnBUCt7Fh0xTPLoOTduifTyeqh8GxEmC17d3vByPKMr7vkMCRkKgKEsG0qXmCYyKkSfLc17T6eyhqus90Fq7tq4UV6dxaIyRT8UFv8tMBvM886ro7m5ka2ecPB9hFKOqG8g0wzUSyIuSY+KWIBQxZJrjXtUcjxO5xrKcwT9emapqvVY1xvDi6ez7AUppzlPXxkzQWmMYxjX35UEI+AEt32o6oeUC6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"5\"\n        title=\"5\"\n        src=\"/static/d162f6dad58d5039aa32e6b515b8f509/37523/5.png\"\n        srcset=\"/static/d162f6dad58d5039aa32e6b515b8f509/e9ff0/5.png 180w,\n/static/d162f6dad58d5039aa32e6b515b8f509/f21e7/5.png 360w,\n/static/d162f6dad58d5039aa32e6b515b8f509/37523/5.png 720w,\n/static/d162f6dad58d5039aa32e6b515b8f509/c8e86/5.png 758w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n</tr>\n</thead>\n</table>\n<ol>\n<li>deregister-targets를 호출 시, 왼쪽 사진처럼 드레이닝 상태가 되고, <strong>지정한 등록 취소 지연 시간이 지난 뒤 대상에서 사라집니다</strong>.</li>\n<li>그리고 등록 취소된 인스턴스를 register-targets로 재등록 요청시, 오른쪽 사진의 상태가 되고 <strong>최초의 헬스체크 통과시 다시 트래픽이 전달</strong>됩니다.</li>\n</ol>\n<p>이제 위 과정을 이용하여, 실제 등록 취소 과정을 테스트 해보겠습니다.</p>\n<br/>\n<h2 id=\"테스트\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트</h2>\n<h3 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h3>\n<table>\n<thead>\n<tr>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfklEQVQ4y5VUu26DQBDkC1Lk51LkP9JHqfMP6aJ06ZALP2SwLFkOEraR/GhT2paxwWDgbqLdC+S4BCKfNFpud29ud1iwAEBKySifhRCM0l9C9+tLP2+ZgWvWX/mWHsjzHN1uF8PhEL1ejzEej2HbNjqdDvr9Pu8Jg8EArusiTdMauWXedDgcsN1uGWEYIooi7HY7Bvn2+z1OpxOOxyOSJKlJRbD06kifa1ZRFBVqFRLRaDTCdDpFEATwfZ8ttTibzeA4DubzORaLBTzPY0noeTKZcPt0lgqqtXy5XFiPLMs4SPZ8PnNr1CIhjmPOo1bJUl65rypse7MUW61W2Gw2WC6XWK/XrbKwhrqgJszkpvlsncMyQC3TG02SVIupPH24zYsbCemQ0rOAELKCWVEr4a/P8MdbgWMNZI2fHtlCKIL3ALh/A+5egZeP7/kTuK5C1rBQhM+OxO2TxM2jxIOtfLlQev5bYZ1Y2TSX+AzBiDNZxZqmzWr/m5gaNhOVhF/UVNnB+jLdqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"6\"\n        title=\"6\"\n        src=\"/static/e54f55399153ea41927ed0e711e04350/37523/6.png\"\n        srcset=\"/static/e54f55399153ea41927ed0e711e04350/e9ff0/6.png 180w,\n/static/e54f55399153ea41927ed0e711e04350/f21e7/6.png 360w,\n/static/e54f55399153ea41927ed0e711e04350/37523/6.png 720w,\n/static/e54f55399153ea41927ed0e711e04350/f8067/6.png 726w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 584px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABE0lEQVQoz61Ra0vEMBDs//81fpDDng9QKJ7idxHR0tajpaUFr02T5jWStak59QTRDcsms8kws4kAwFqLv4bniPxm0hOkltBGgysOoQWYZIQJJQhXRmOQjJJRHfAqdtDWLKSRmQnv2wecpKdYp+dYPcVIXjaI0zOsnuM517je3uCySHCRXeG2vEOy3eDo8Ri7qf8g9ApdfVeh9qwYWFpm3oUhjUL4niwvh/muNRaMMXDOKQUXlISNHOM4gg0DhBBf5rc3w2WW04SiKFBVFbquQ13XaJqGsLIsCc+yjHrhO1fJ8nc/9dufDSP63HSW8jwnZW3bLgodFip0eKjsIKHWGn3fE7Gz72fpZujS4b7/I+F/WX4Dd+4KX1IOpvoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"7\"\n        title=\"7\"\n        src=\"/static/084e2e8987ee4c762b73f7a5a0470cf6/e05eb/7.png\"\n        srcset=\"/static/084e2e8987ee4c762b73f7a5a0470cf6/e9ff0/7.png 180w,\n/static/084e2e8987ee4c762b73f7a5a0470cf6/f21e7/7.png 360w,\n/static/084e2e8987ee4c762b73f7a5a0470cf6/e05eb/7.png 584w\"\n        sizes=\"(max-width: 584px) 100vw, 584px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n</tr>\n</thead>\n</table>\n<blockquote>\n<p>사진의 페이지는 실제 배포가 되어있는 페이지입니다.</p>\n</blockquote>\n<p>왼쪽 사진의 페이지에서 입력한 시간(초) 만큼 <strong>Thread.sleep()</strong> 을 걸고, sleep이 끝나면 되면 오른쪽 사진의 페이지로 이동합니다.</p>\n<blockquote>\n</blockquote>\n<p>테스트는 다음 순서로 진행합니다.</p>\n<ol>\n<li><strong>등록 취소 지연 시간은 30초</strong>로 지정합니다.</li>\n<li>이 페이지에서 <strong>35초</strong>를 지정한 뒤 요청을 보냅니다.</li>\n<li>aws-cli에서 deregister-targets를 호출하여 등록 취소를 진행합니다.</li>\n</ol>\n<p>1번과 2번 작업 사이에 1초 정도가 소요되니, 여유있게 35초로 잡은 요청은 등록 취소 지연 시간을 초과하기 때문에 500번대 응답(502)이 올 것이라 기대할 수 있겠습니다.</p>\n<h3 id=\"결과\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EA%B3%BC\" aria-label=\"결과 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결과</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.222222222222221%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXklEQVQI10WNQRLAIAgD/f9DrSIgag96SgcO9pQws1nSWi9aE4gomDVStUPV0LvBbKIUwhgTIv0yfjvXiKPnXLD3QZpzgYgDvEL5hcOFD8FshLDWFozvPP2Zd89zDj7vPJeIur9hGAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"8\"\n        title=\"8\"\n        src=\"/static/571cc61191527d02704fc3623310ff50/37523/8.png\"\n        srcset=\"/static/571cc61191527d02704fc3623310ff50/e9ff0/8.png 180w,\n/static/571cc61191527d02704fc3623310ff50/f21e7/8.png 360w,\n/static/571cc61191527d02704fc3623310ff50/37523/8.png 720w,\n/static/571cc61191527d02704fc3623310ff50/cc155/8.png 886w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진처럼 19시 7분 <code class=\"language-text\">26초</code>에 deregister-targets을 호출했다면 30초 뒤인 <code class=\"language-text\">56초 이후</code>에 마무리되는 요청은 정상 응답이 나가지 않아야 하는데요, 실제 결과는 어떻게 되었을까요?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 632px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABFUlEQVQoz71PXU+DQBDk//8jH3ypoS2UkDZVkVRCoHB8lY/7EJ/KmF1DrcYn07jJ3sxNbvdmLNyopmlitIQu4JU+wvaAbb2HX20RtCGWuYOnU4CVcPHYPOOlDbnt3OH7rt5z38X3oB1U5+n8ufAhs+EWHtbChSs8BKcQq9zFWmywONqMjtjgtYvgVzv+nLs7YHFcojDVxaV188hEyCq1NhpSSSitML6PjObNMPZDD2MMBjnwG631ZW5exg7pmIW6rpGmKYQQ6LoOWZahaRrGOI5ZJ05YVV8x53l2+NPyX2Je1zeHSin0fc84jiOklByT7uSYYg7DwJy0Xx1eC0VRIM9zlGXJi4m3bcsRkyRhnbQoiv4v8gdDNAJzu0EhIAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"9\"\n        title=\"9\"\n        src=\"/static/ca56ea2cd482fe7d37eb3748875a7b6f/084e2/9.png\"\n        srcset=\"/static/ca56ea2cd482fe7d37eb3748875a7b6f/e9ff0/9.png 180w,\n/static/ca56ea2cd482fe7d37eb3748875a7b6f/f21e7/9.png 360w,\n/static/ca56ea2cd482fe7d37eb3748875a7b6f/084e2/9.png 632w\"\n        sizes=\"(max-width: 632px) 100vw, 632px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>25초에 요청을 받고 00초에 마무리 된 35초 지연 작업이 정상 응답을 반환하는 예상과 다른 결과가 나타났습니다..</p>\n<p>맨 위에서 작성한 공식 문서의 내용에 따르면 deregister-targets를 호출하여 인스턴스의 드레이닝이 진행되는 동안은 새로운 트래픽이 배분되지 않아야 하지만, 이 요청이 마무리가 되었다는 것은 deregister-targets 호출 이후에도 새로운 트래픽이 배분된 것이라고 생각할 수 있겠습니다.</p>\n<h3 id=\"원인-파악하기\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8-%ED%8C%8C%EC%95%85%ED%95%98%EA%B8%B0\" aria-label=\"원인 파악하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인 파악하기</h3>\n<p>이전에 예상했던 대로, deregister-targets 호출 이후에도 ELB가 트래픽을 배분하는지 확인해 보겠습니다. 로그를 조금 더 편하게 찍기 위해 위의 페이지와 동일한 기능을 하면서 요청 시간 / 완료 시간을 JSON으로 응답하는 API를 하나 추가하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">sendRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">sendRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token class-name\">WebClient</span> webClient <span class=\"token operator\">=</span> <span class=\"token class-name\">WebClient</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">baseUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"배포중인 도메인\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">LocalDateTime</span> requestTime <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\twebClient<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/shutdown-test-v2\"</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">bodyValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ShutdownRequest</span><span class=\"token punctuation\">(</span>requestTime<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">retrieve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">bodyToMono</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ShutdownResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>\n\t\t\tresult <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"request result: {}\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\terror <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"requestTime: {}, result: {}\"</span><span class=\"token punctuation\">,</span> requestTime<span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DATE_TIME_FORMATTER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t\terror<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>비동기 요청을 위해 WebClient를 사용하였습니다. WebClient 사용을 위해선 Spring Webflux 의존성 추가가 필요합니다 !</p>\n</blockquote>\n<p>테스트는 위 코드를 이용하여, 1초 단위로 요청을 계속 보내면서 deregister-targets 호출 이후 실제 요청이 들어가는지 확인해 보겠습니다. 테스트를 위해 <strong>등록 취소 지연 시간은</strong> 기존의 30초보다 짧은 <strong>10초</strong>로 지정하고, Thread.sleep()을 거는 <strong>딜레이도 동일한 10초</strong>로 지정하였습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABN0lEQVQoz21Ry5LDIAzL///i7mHbAOZhE0gaku5FHbvd2elMDxrACCFbU5UCIo/eBGsXLLWgSkZb2PZ9YbT63C+VsXXGWCNGT9heHOUqxr5i0kIkD+aEnAlEDsLRiCIJTQoWzhBOEMnYWsHoAaMFrPVZVwPKN8EujPn6gxBmOHdFCA5cokGJJsQJx9jwex84jx3HcRjOc7fa/dwNypmEM7yfEWMwp/N8MWE915fDWpK5Vq613Mmw1mKdvTnU3yM9XeUU4N3FkKJDCFeU6JHJg8IMCg6NHQZ/YfA3Kjnj6l2KHvutY9If1FGKwR6UTNaiDtnCKRmiI+CI29YwborFsG/NarqqmDnUlHVuOREoeAtGxTR1S17+Es72SOc0xmbrJ9gM1WFRQe/eUq7qNP0Ho21p3UT39SMep0xb+dLFCQ0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"10\"\n        title=\"10\"\n        src=\"/static/ae9fd88b4bd3766236deb19d03463490/37523/10.png\"\n        srcset=\"/static/ae9fd88b4bd3766236deb19d03463490/e9ff0/10.png 180w,\n/static/ae9fd88b4bd3766236deb19d03463490/f21e7/10.png 360w,\n/static/ae9fd88b4bd3766236deb19d03463490/37523/10.png 720w,\n/static/ae9fd88b4bd3766236deb19d03463490/302a4/10.png 1080w,\n/static/ae9fd88b4bd3766236deb19d03463490/07a9c/10.png 1440w,\n/static/ae9fd88b4bd3766236deb19d03463490/c0566/10.png 1544w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진은 실제 테스트 과정에서의 로그이고, 이 로그들을 조금 더 자세히 확인해 보겠습니다.</p>\n<ol>\n<li><strong>502 응답</strong></li>\n</ol>\n<p>우선 502 응답 부터 살펴보자면, 테스트에서 사용하는 API는 <strong>순수 Thread.sleep() 시간만 등록 취소 지연 시간과 동일한 10초</strong>이기에 실제 실행 시간은 10초를 초과합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAW0lEQVQI10WNSQ7AMAgD+/+PRglLIKRnV47U9oCQxgO+zBwihjkD7oGIBFlr/TARReaCqmEMhfuEqh8vZh7GvGqjd8HFI4aEa9U3fErplVlGxow+d9Xv730f/gD8bJgkch7JzgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"11\"\n        title=\"11\"\n        src=\"/static/4bdcd35acdbadfb1303e591e91a68e9c/37523/11.png\"\n        srcset=\"/static/4bdcd35acdbadfb1303e591e91a68e9c/e9ff0/11.png 180w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/f21e7/11.png 360w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/37523/11.png 720w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/302a4/11.png 1080w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/077b7/11.png 1166w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>따라서 nginx 로그를 살펴보면 이 요청에 대해서는 서버가 <code class=\"language-text\">499</code> 응답을 보낸 것으로 확인되고,</p>\n<blockquote>\n<p>499: 서버가 요청을 처리하고 <strong>응답을 보내기 전에 클라이언트가 서버에 대한 연결을 종료할 때 Nginx가 보내는</strong> 상태 코드. (출처: <a href=\"https://http-statuscode.com/ko/code/4XX/499-unofficial\">http-statuscode.com</a>)</p>\n</blockquote>\n<p>이는 서버가 응답을 보내기 전에 등록 취소 지연 시간이 지나 ELB와 서버간의 연결이 끊어졌기 때문이라고 할 수 있겠습니다. 실제로 등록 취소 지연을 기존과 동일한 10초로 했을 때, 테스트에 사용하는 딜레이만 9초로 낮춰도 502 응답은 나가지 않습니다 ㅎㅎ</p>\n<ol start=\"2\">\n<li><strong>503 응답</strong></li>\n</ol>\n<p>deregister-targets를 호출한 56분 58초부터 약 <strong>14초</strong> 뒤인 57분 12초부터의 요청은 모두 503 응답이 나갔는데요, 이때부터는 nginx 로그를 확인해도 해당 요청은 없는 바 이 시점부터 ELB의 트래픽 배분이 중지되었다고 판단할 수 있습니다.</p>\n<p>그러면 이 14초는 어떻게 산정된 값일까요?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAqUlEQVQI1y3OyU7DMAAA0fz/fyEhqFAQAZqoUFTb8b7W5TpIpod3m8NMvWa82XH2XwwWoyWpqDtJzJJUFcUZWvCUpolZEPJlNLnuXK+BWy9M1Xs+55llmVmPC9v6wet8QJiFH/3Cl3rivB8Q4Q29HonnCzptbOKBk3zke39Gunda8/SemXorOK2wVuGdJniDNYpSzf1OjIvSDNVbekq07sddHMRof29t+ANcmN5ypxZhEgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"12\"\n        title=\"12\"\n        src=\"/static/6924a674cfdfa9f04c1a77ed9762fe20/37523/12.png\"\n        srcset=\"/static/6924a674cfdfa9f04c1a77ed9762fe20/e9ff0/12.png 180w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/f21e7/12.png 360w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/37523/12.png 720w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/302a4/12.png 1080w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/07a9c/12.png 1440w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/7db30/12.png 1494w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>우선 위에 있는 헬스체크 로그를 보면 deregister-targets 호출 이후 3초, 8초 뒤에 헬스체크 요청이 왔는데, 이때의 응답은 모두 200이니 헬스체크는 연관이 없는 것 같습니다. 그래서 ‘<strong>deregister-targets 호출 이후에는 트래픽을 보내지 않는다고 하는데, 실제로 보내고 있다</strong>’ 라는 원론으로 돌아가서 생각해보니, 가장 유력하게 느껴지는 원인은 <strong>요청 이후 실제 ELB에 반영되는 시간</strong>인 것 같았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 modify-target-group <span class=\"token punctuation\">\\</span>\n--target-group-arn <span class=\"token punctuation\">[</span>대상 그룹의 arn<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n--health-check-interval-seconds <span class=\"token punctuation\">[</span>헬스체크 간격 시간<span class=\"token punctuation\">(</span>초<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>위의 코드는 AWS-CLI에서 헬스체크 간격을 수정하는 코드입니다. 이 코드를 호출해서 헬스체크 간격을 기존의 값인 5초에서 10초로 수정한 뒤 실제로 반영이 되는 시간을 확인 해 보겠습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAU0lEQVQI1zVNSQoAMQjr/59a3HXOGSL0ENRsHjOHiEHV4B7ILEQk7pXdRXR56gT95FUdEYXu2ds9t+cwTJAkqhozsyU0M/iePB91Tuoz307mmPkBHq+Yd3tiw0YAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"13\"\n        title=\"13\"\n        src=\"/static/9afb35a5aec6cccbc4b19b19d140bc7c/37523/13.png\"\n        srcset=\"/static/9afb35a5aec6cccbc4b19b19d140bc7c/e9ff0/13.png 180w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/f21e7/13.png 360w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/37523/13.png 720w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/302a4/13.png 1080w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/393aa/13.png 1190w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArElEQVQI1z2Oy2rDMBQF8/8f1kJK2rjE7qJ1CUSWda8k6xV3OyUqdHVgOAxzuOeEF4vIgorF64rKQiqWLRu2vBDTjZQtVZWa9Z91Xiy5CrUFfvbKITthGs4Mw4npMvAxvjOObxi98G1fmJdjXyMjOs1EuXF1r3yaJ77MM9f1hMS5i7vwXhJRHd6vBO/YghCjUKqSyvpXUBylCC0E9pbI1fXKR/Xj01pk33MX/gJobt7IWdkK2wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"14\"\n        title=\"14\"\n        src=\"/static/99cd51298a76f6ab130b29da897ccef8/37523/14.png\"\n        srcset=\"/static/99cd51298a76f6ab130b29da897ccef8/e9ff0/14.png 180w,\n/static/99cd51298a76f6ab130b29da897ccef8/f21e7/14.png 360w,\n/static/99cd51298a76f6ab130b29da897ccef8/37523/14.png 720w,\n/static/99cd51298a76f6ab130b29da897ccef8/302a4/14.png 1080w,\n/static/99cd51298a76f6ab130b29da897ccef8/07a9c/14.png 1440w,\n/static/99cd51298a76f6ab130b29da897ccef8/a8c87/14.png 1538w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>헬스체크 간격 수정 명령어는 22분 16초에 호출했고, 위의 로그를 보면 31초까지는 5초 단위로 헬스체크 요청이 오고 이후부터 10초로 변경된 것을 확인할 수 있습니다. 초 단위까지만 측정하여 정확하지는 않지만 실제 변경까지는 대략 14~15초 정도 소요되고, 이 시간은 이전에 deregister-targets 호출 뒤 트래픽 중단까지 걸린 14초와 대략적으로 비슷한 시간임을 확인하였습니다.</p>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<p>aws-cli에서 제공하는 deregister 기능은 정상 작동하긴 하지만, 기대와 달리 실제 트래픽 중단까지는 약 14초가 소요되고, 헬스체크 간격 변경이 실제 반영될 때 까지 15초 정도가 소요되는 것을 보아 CLI에서의 요청 뒤 실제 ELB로의 반영까지는 대략 15초 전후의 시간이 걸린다고 예측할 수 있습니다.</p>\n<p>이제 마지막으로, 이걸 실제 배포 과정에 적용하는 과정과 CLI 요청 후 실제 ELB까지의 반영에 걸리는 시간 문제를 해결한 방법을 소개하겠습니다.</p>\n<br/>\n<h2 id=\"실제-배포에-적용하기\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%EC%A0%9C-%EB%B0%B0%ED%8F%AC%EC%97%90-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"실제 배포에 적용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실제 배포에 적용하기</h2>\n<h3 id=\"개요-1\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94-1\" aria-label=\"개요 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h3>\n<p>기존의 과정은 <strong>헬스체크 실패 API 호출 → 25초 sleep → 기존 스프링부트 종료 → 새로운 스프링부트 배포</strong> 순서로 진행됩니다. 스크립트 코드를 대략적으로 작성하면 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://localhost:8080/termination\n<span class=\"token function\">sleep</span> <span class=\"token number\">25</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인</code></pre></div>\n<p>수정할 과정은 deregister-targets 호출 → <strong>[실제 ELB까지 반영되어 트래픽이 전송되지 않을 때 까지 대기]</strong> → 기존 스프링부트 종료 → 새로운 스프링부트 배포 → register-targets 호출 순서로 진행됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">..</span>\n<span class=\"token punctuation\">[</span>실제 트래픽 중단까지 대기<span class=\"token punctuation\">]</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인\n\naws elbv2 register-targets <span class=\"token punctuation\">..</span></code></pre></div>\n<p>그러면 새로운 과정에서 고려해볼 것은, 실제 트래픽 중단까지 대기하는 시간과 등록 취소 지연 시간이 되겠네요. 우선 등록 취소 지연 시간부터 살펴보겠습니다.</p>\n<h3 id=\"graceful-shutdown과-등록-취소-지연-설정\" style=\"position:relative;\"><a href=\"#graceful-shutdown%EA%B3%BC-%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C-%EC%A7%80%EC%97%B0-%EC%84%A4%EC%A0%95\" aria-label=\"graceful shutdown과 등록 취소 지연 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Graceful shutdown과 등록 취소 지연 설정</h3>\n<p>현재 Springboot의 graceful shutdown timeout은 기본값인 30초로 지정되어 있습니다.</p>\n<blockquote>\n<p>graceful shutdown: 지정한 timeout까지의 요청은 처리하고 애플리케이션을 종료하는 방법</p>\n</blockquote>\n<p>이전의 테스트 결과(502 응답이 나온 상황)로부터, 인스턴스가 마지막 요청을 받은 뒤 지정한 등록 취소 지연 시간이 지나면 애플리케이션이 요청을 처리해도 실제 응답까지 가지 않는다는 것을 확인하였습니다.</p>\n<p>즉, Graceful shutdown이 진행되는 동안 등록 취소 지연 시간이 지나면 이 응답은 사용자에게 가지 않을 것입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABLUlEQVQoz6WSSU/FMAyE+///GBcQXBAX0GN5eku3NEmbNmnjD1wo6xFLI9ujaGxrUvDPkF+5EBFyzmg2LlC2/gcq03NuHMeq41hbKuM5NY7doSW5HrxHNPfDqlHEGJmmiRAC4xQZp4R1Pc4PK5YZhiFS1xZjemLMpCgMY4Z9CQ8vyP0j8ryHJVPM80xrDMZ0pJQYxxHnHOdTiQuWNpXYpcFJi8st3VJjUkmXW6rdNfXdBeyekZcDkjOFigwhMAwBFdfeOb8O8MHhZ0vdl5y64wqtferoc499vMXeXYJu+LRHdEM9WUX07GVZEMkop+Ka18ggi6zQeuNoLBxrqBqkNaAbbqZsxqxvv/Ub92Xrez+dS7qrG6IKfbisKP58g18Cm+h3bHxO6XPIyr+5/Aohb29Nqs/GzwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"15\"\n        title=\"15\"\n        src=\"/static/87deef86bc83d72b64d067dbeb3e6765/37523/15.png\"\n        srcset=\"/static/87deef86bc83d72b64d067dbeb3e6765/e9ff0/15.png 180w,\n/static/87deef86bc83d72b64d067dbeb3e6765/f21e7/15.png 360w,\n/static/87deef86bc83d72b64d067dbeb3e6765/37523/15.png 720w,\n/static/87deef86bc83d72b64d067dbeb3e6765/302a4/15.png 1080w,\n/static/87deef86bc83d72b64d067dbeb3e6765/07a9c/15.png 1440w,\n/static/87deef86bc83d72b64d067dbeb3e6765/24def/15.png 1812w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>위 그림에서의 화살표 길이는 등록 취소 지연 시간 및 graceful shutdown timeout 시간이라고 생각해주세요!</p>\n</blockquote>\n<p>그림으로 살펴보면 대략 이런 느낌인데요, 만약 Graceful shutdown timeout이 등록 취소 지연 시간보다 길어진다면 실제 Springboot는 요청을 처리했지만 이 응답이 사용자에게 가지는 않습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABIklEQVQoz5WS2W7DIBBF8/+fV6lvWZylieMQ2wWD2U/rLUrTvnTQFQyCw3JnlXNm0X/j146cWT3nxnp07zH91E9y47xx4ZGLtsNaDymRYyTHNMKGWHnviTFiraVVPaJViEYiGsW91UjlOJc1p4tA1ArVOa51jykF7A7k4kg+fEAIE3AAfUqJlGo8JQSPlBKlFL3XBCw2GmzU+GzxuUfSEGsB64K83U/QBRhC4F43qK7DOYfWhmt1o6oEwly5mBP7ZkvRbCjqDRd9ZNuvMbczrPfkTUHeHX7ecHi2MWY0ZjhgAA+KIU1/HYE0a4lWkoabnUsoq/EvR+AASSmNWtx+zSc/89wgaI18e6c/nWdz53WvLv9ZGk9l9VxeybnH+FFy38AvRkJw2bwLu3IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"16\"\n        title=\"16\"\n        src=\"/static/70251bd296b51d4be42936593c8fdc16/37523/16.png\"\n        srcset=\"/static/70251bd296b51d4be42936593c8fdc16/e9ff0/16.png 180w,\n/static/70251bd296b51d4be42936593c8fdc16/f21e7/16.png 360w,\n/static/70251bd296b51d4be42936593c8fdc16/37523/16.png 720w,\n/static/70251bd296b51d4be42936593c8fdc16/302a4/16.png 1080w,\n/static/70251bd296b51d4be42936593c8fdc16/07a9c/16.png 1440w,\n/static/70251bd296b51d4be42936593c8fdc16/c6720/16.png 1922w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>따라서 Springboot의 종료는 위 그림처럼 등록 취소 지연 시간이 지나기 전에 마무리가 되어야 하며, 마지막 요청 수신과 기존의 springboot의 종료가 순서대로 진행되니 <strong>graceful shutdown timeout은 등록 취소 지연 시간보다 작거나 같게 설정</strong>해야 합니다.</p>\n<h3 id=\"실제-트래픽-중단까지-대기---시간-지정\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%EC%A0%9C-%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%A4%91%EB%8B%A8%EA%B9%8C%EC%A7%80-%EB%8C%80%EA%B8%B0---%EC%8B%9C%EA%B0%84-%EC%A7%80%EC%A0%95\" aria-label=\"실제 트래픽 중단까지 대기   시간 지정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실제 트래픽 중단까지 대기 - 시간 지정</h3>\n<p>이제 이전의 개요에 있던 <strong>실제 트래픽 중단까지 대기</strong>만 잘 하면 되겠네요. 제가 사용할 방법은, <strong>실제 데이터를 측정한 뒤 나온 통계량을 이용해서 적절한 대기 시간을 거는 방법</strong>입니다.</p>\n<blockquote>\n<p>사실 이 방법은 본문을 작성하며 진행한 수십 번의 테스트에서 시작되었습니다ㅎㅎ 매번 확인하다 보니 자연스레 ‘15초를 초과하지 않을 것이다’ 라는 가설 검증의 과정으로 진행 되더라구요</p>\n</blockquote>\n<p>우선 통계량을 구하기 위해 테스트를 진행하겠습니다. 테스트는 deregister-targets 명령어 호출 이후 0.1초 단위로 요청을 보내고 503 응답이 나올 때 까지의 시간을 기록하는 순서로 진행하며, 총 30회 수행합니다. 아래 그래프는 이 작업을 총 30회 시도했을 때의 분포입니다.</p>\n<blockquote>\n<p>30회는 보통 정규분포를 가정할 때 사용하는 최소 표본 수입니다.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACZklEQVQ4y42SS2sTURiG80PUKgheigv/gLgXV6ILXRVcxYq2Cm67U1RaKGJFBLGIlxqaTBQa4yW22MTYapVQxVwmY25Nk0lmkjmTyW3mlXMmM5kQKx745tzmPOf9vve4AKDVaoHneaRSKRQKBSSTSeRyOSQSCRZp4TcSyRQLQRCQzWYRj8fZ2OolSaIouOin3W5DFEXUajUoigJZlllPo0HqqBRzKG9loNaqaDQaIITY+zTq9To7YwOr1SqD/q3x2wru+KK4y0Xx6nMKOzVN0/pAemuz2WQLhmGw6HR1Nn/ykcfeiz7sv8Th5M0QWp0uW9d7/1mhqupgyrSOFpC2rm72LyICDk34cOSqH2dmltHuXWSBrDEVNQB0KnQCFyICDlz2YfSKH6en/wNIC0wnOynsAzkH0LBTHgIWi0XmlGXKP4Ezy44ammEptYG6rjN1ToVOU5wpn5r+wNYachlEKkNvEtuggRpShyzbewKh957DQiTNgIcnOZydXUG6RHD9eRi3PJ/w8O0mmh2zBEMuW6ZA76BWKUGRKzRxeKIZBjw44cPY3CoC3/LY5V5kz+jYVBCiYp4jTiA1RtPMjXhewvzrdTwLxfCd34ZvPWcrHJsLI7RZxOgkh6PXXuLEjXeQVLNUqupImapTiHnDbX8MI+Ne7L7gxfl7YXijAva4Pdg3vohzsytY2shixO1hio9PBVCSVcDQoSikD6TG0Bs6rSZ+ZkQ8frOB+9wqwj+y4LeqmA9+xaPAFwTXfiEv1vH0fQwP/GEsrSWhqA1Wf61XMpf1TIabYfdErkAWi2hrxLGvD58wDPwBAxw/lQEWshIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"17\"\n        title=\"17\"\n        src=\"/static/1e483b678913d034e0220a30fe56db54/37523/17.png\"\n        srcset=\"/static/1e483b678913d034e0220a30fe56db54/e9ff0/17.png 180w,\n/static/1e483b678913d034e0220a30fe56db54/f21e7/17.png 360w,\n/static/1e483b678913d034e0220a30fe56db54/37523/17.png 720w,\n/static/1e483b678913d034e0220a30fe56db54/302a4/17.png 1080w,\n/static/1e483b678913d034e0220a30fe56db54/0d0e4/17.png 1230w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>대부분의 결과가 13초 이내이고 최대값은 13.46초로 아무리 늦어도 13.5초 내에는 트래픽이 중단됩니다. 30번의 시도를 한 이유는 정규분포를 가정하고 확률을 계산하기 위함이지만 실제 위 분포를 정규분포로 가정하기에는 근거가 부족한 것 같아요.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABZ0lEQVQoz0WRbW+bMBSF+f//ato0LWtarXljkASCMWAbY0q68NIoeiaTqvlwpHPPvb629QRn946tG2QlUabivb7QNyNaa1rnmMaJcRyZZt39ox4Zh0ev73sCoTJ26ZZUCVKdI2tFYRXtuZt9bips6yitJlUS4yx12yB0SWUN9s2R6YJMl7x1HUHXdbjGcT7/I5YnnuINz/GWTBU87TdznRSCdRrzY/dCnKdEecrysGV72pOUYp77Ha9RtSGYnz9N9EPPThz5Fa1Y/F2RVjmLT38sMlZpxPfdC5FICEXCz/APy/2WYyFYxGu+bZZUfqH/t9elv5BUOa9JRJgdkUaxPsXssgNSV4R5MvdyXXEsBa9pxEFmX3PP+5Cm7QhaZ9BKcToJyrIgFwJtLKMHMNwBDMPwgDIMs6ZPOHc/8TF93KE451BKYYzBWktd1/jMU5aFRAh/UTlnvu9zn3kVZTGfu16v3G63Wf8BOrkHuv8b11IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"18\"\n        title=\"18\"\n        src=\"/static/f99d8a3578e97d4daa558c51b825b016/37523/18.png\"\n        srcset=\"/static/f99d8a3578e97d4daa558c51b825b016/e9ff0/18.png 180w,\n/static/f99d8a3578e97d4daa558c51b825b016/f21e7/18.png 360w,\n/static/f99d8a3578e97d4daa558c51b825b016/37523/18.png 720w,\n/static/f99d8a3578e97d4daa558c51b825b016/302a4/18.png 1080w,\n/static/f99d8a3578e97d4daa558c51b825b016/d4e7f/18.png 1416w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그래서 <a href=\"https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test\">Shapiro-Wilk 정규성 검증</a>으로 실제 정규성을 가지는지 검증했고, 검증 결과로 나온 P-value는 0.068로 정규성을 가진다고 할 수 있는 기준값인 0.05를 초과합니다.\n따라서 이 분포를 정규분포로 가정한 뒤 확률을 계산해보면 트래픽 중단까지의 시간이 <strong>14초를 초과할 확률은 0.16%</strong>, <strong>15초를 초과할 확률은 0.000021%</strong> 로 계산되고, 저는 deregister-targets 호출 이후 <code class=\"language-text\">sleep 15</code>로 15초를 기다리는 방식으로 진행하였습니다.</p>\n<blockquote>\n<p>AWS가 제공하는 서비스의 안정성을 생각하면 이상치가 나올 가능성이 극히 적다는 생각도 있었습니다 ㅎㅎ</p>\n</blockquote>\n<br/>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>글이 꽤나 길어졌네요..ㅎㅎ 그래서 일단 간단하게 요약해 보겠습니다.</p>\n<ol>\n<li>팀원이 구현한 API를 호출하여 헬스체크에 실패하도록 하는 방법은 좋은 방법이고, 현재는 IAM 권한 문제로 이 방법이 최선입니다.</li>\n<li>하지만 API를 사용하는데에서 오는, 배포와 애플리케이션의 의존에서의 불확실성이 존재하긴 합니다.</li>\n<li>AWS-CLI의 deregister-targets을 이용하여 ELB가 트래픽을 중단하도록 할 수 있습니다. 이 경우 등록 취소 지연(deregistration delay)를 springboot의 graceful-shutdown tiimeout보다 같거나 크게 설정해야 합니다.</li>\n<li>deregister-targets를 호출해도 실제 ELB에 반영되어 트래픽이 중지될 때 까지는 약 15초정도가 소요되며, 30회 측정 후 통계량을 구한 결과를 바탕으로 계산했을 때 15초를 초과할 확률은 매우 낮습니다. 따라서 deregister-targets 명령어 호출 이후 15초를 대기합니다.</li>\n</ol>\n<p>이전 글도 그렇고, 이번 글도 그렇고 코드 리뷰를 하며 남긴 “Deregistration delay를 도입할 수 있지 않을까?” 라는 댓글에서 시작했습니다. 저도 이런 개념이 있다 정도만 얼핏 봤지 실제로 적용해본 방법은 아니었는데요, 처음부터 하나씩 알아가다보니 많은 시간이 쓰이긴 했지만 그만큼 의미있고 보람찬 작업이었던 것 같습니다 ㅎㅎ</p>\n<p>복잡하고 긴 내용이지만 여기까지 읽어주셔서 감사합니다 😄</p>","frontmatter":{"date":"November 11, 2024","title":"무중단 배포 과정에서의 불확실성 개선 [1] - AWS CLI를 이용한 등록 취소","categories":"level4 aws deregister","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/improving_deployment/2/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://pricelees.github.io","comments":{"utterances":{"repo":"pricelees/pricelees.github.io"}}}}},"pageContext":{"slug":"/woowacourse/level4/improving_deployment/3/","nextSlug":"/woowacourse/level4/improving_deployment/2/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}