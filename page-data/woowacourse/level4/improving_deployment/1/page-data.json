{"componentChunkName":"component---src-templates-blog-template-js","path":"/woowacourse/level4/improving_deployment/1/","result":{"data":{"cur":{"id":"77db79ad-632c-5b83-bccd-ed534dd5a2fe","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>프로젝트 팀원인 <a href=\"https://github.com/ay-eonii\">테니</a>가 기존의 무중단 배포에서 다운타임이 발생하는 문제를 해결하는 <a href=\"https://github.com/woowacourse-teams/2024-mouda/pull/794\">PR</a>을 올렸습니다.</p>\n<blockquote>\n<p>자세한 내용은 해당 PR에서 확인하실 수 있습니다.</p>\n</blockquote>\n<p>문제도 잘 파악했고, 해결까지의 전체 과정을 문서화해서 공유해준 덕분에 전체 과정을 빠르게 이해할 수 있었는데요(<strong>테니 감사합니다 😄</strong>), 제가 PR에 남겼던 댓글 중 일부를 직접 테스트해본 결과를 바탕으로 기존 방법에서 조금 더 개선이 가능한 부분을 공유하고자 합니다.</p>\n<br/>\n<h2 id=\"기존-배포-과정\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%EB%B0%B0%ED%8F%AC-%EA%B3%BC%EC%A0%95\" aria-label=\"기존 배포 과정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 배포 과정</h2>\n<p>개선 방법을 작성하기 전에, 기존의 과정을 순서대로 살펴보며 전체 흐름을 다시 정리하겠습니다.</p>\n<h3 id=\"1-인스턴스-내부에서-post-termination-요청을-보내-elb의-헬스체크에-실패하도록-지정\" style=\"position:relative;\"><a href=\"#1-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EB%82%B4%EB%B6%80%EC%97%90%EC%84%9C-post-termination-%EC%9A%94%EC%B2%AD%EC%9D%84-%EB%B3%B4%EB%82%B4-elb%EC%9D%98-%ED%97%AC%EC%8A%A4%EC%B2%B4%ED%81%AC%EC%97%90-%EC%8B%A4%ED%8C%A8%ED%95%98%EB%8F%84%EB%A1%9D-%EC%A7%80%EC%A0%95\" aria-label=\"1 인스턴스 내부에서 post termination 요청을 보내 elb의 헬스체크에 실패하도록 지정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 인스턴스 내부에서 POST /termination 요청을 보내 ELB의 헬스체크에 실패하도록 지정</h3>\n<p>ELB의 헬스체크에 사용되는 코드를 살펴보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HealthCheckController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">HOST_IPV4</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">HOST_IPV6</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"0:0:0:0:0:0:0:1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">HOST_NAME</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">;</span>\n   \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AtomicBoolean</span> isTerminating <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicBoolean</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   \n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/health\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">checkHealth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isTerminating<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BAD_GATEWAY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n   \n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/termination\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> remoteHost <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">HOST_IPV6</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token constant\">HOST_IPV4</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token constant\">HOST_NAME</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            isTerminating<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FORBIDDEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li><code class=\"language-text\">/health</code> 메서드는 필드에 있는 AtomicBoolean 값이 <code class=\"language-text\">false</code>이면 ELB가 <code class=\"language-text\">GET /health</code> 로 헬스체크 요청을 보낼 때 <code class=\"language-text\">200 응답</code>을 보내는 코드입니다.\n<ul>\n<li>ELB에는 헬스체크 정상 응답 코드가 200으로 지정되어 있습니다.</li>\n</ul>\n</li>\n<li><code class=\"language-text\">/termination</code> 메서드는 필드의 AtomicBoolean을 false로 지정하여, ELB가 헬스체크 요청을 보낼 때 <code class=\"language-text\">502 응답</code>을 보내 <strong>헬스체크에 실패</strong>하도록 합니다.</li>\n</ol>\n<p>이 API를 이용하여, 인스턴스에 있는 스크립트에서는 <code class=\"language-text\">POST /termination 요청 → 25초 sleep</code> 을 호출하여 본격적인 배포 시작 전에 ELB가 해당 인스턴스로의 트래픽을 보내지 않도록 지정합니다.</p>\n<blockquote>\n<p>25초에 대한 자세한 내용은 아래에서 다루겠습니다.</p>\n</blockquote>\n<br/> \n<h3 id=\"2-배포-시작\" style=\"position:relative;\"><a href=\"#2-%EB%B0%B0%ED%8F%AC-%EC%8B%9C%EC%9E%91\" aria-label=\"2 배포 시작 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 배포 시작</h3>\n<p>이후의 배포 과정은 다음 순서로 진행됩니다.</p>\n<ol>\n<li>(git clone &#x26; pull 등 프로젝트 코드 로딩 후) gradle 빌드 등 배포 준비</li>\n<li>기존의 springboot 프로세스를 종료\n<ul>\n<li>springboot의 <strong>graceful shutdown</strong> 옵션이 적용되었으며, <strong>timeout은 기본값인 30초</strong>입니다.</li>\n<li><strong>graceful shutdown</strong>은 기존의 요청이 있으면 <strong>최대 timeout 만큼의 시간동안은 해당 요청을 처리하고 종료</strong>하는 방법입니다.</li>\n</ul>\n</li>\n<li>1에서 빌드된 새로운 springboot 실행</li>\n<li><code class=\"language-text\">GET /health</code> 요청을 보내 springboot의 실행이 완료되고, 요청을 받아들이는지 한번 더 확인</li>\n</ol>\n<p>전체 과정은 큰 문제가 없고, 실제 배포 자체도 정상적으로 잘 되는 것은 확인하였지만 몇 가지의 걱정과 개선 방법이 떠올랐는데요, 이제 본격적으로 그 방법들을 다뤄보겠습니다.</p>\n<br/>\n<h2 id=\"기존-방법에서-우려되는-점\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%EB%B0%A9%EB%B2%95%EC%97%90%EC%84%9C-%EC%9A%B0%EB%A0%A4%EB%90%98%EB%8A%94-%EC%A0%90\" aria-label=\"기존 방법에서 우려되는 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 방법에서 우려되는 점</h2>\n<p>프로젝트 초기에 <strong>gradle 빌드 과정에서 메모리 부족으로 인스턴스가 멈췄던 적이</strong> 많았는데요, 현재 시점에서 프로젝트는 더 무거워졌는데 인스턴스는 그때와 같은 타입(t4g.micro)이기 때문에 메모리 문제가 충분히 발생할 수 있다고 생각했습니다.</p>\n<p>따라서, 제 개인 EC2 및 아래의 환경에서 실제 테스트를 진행하며 우려되는 것들이 실제 발생 가능한 문제인지 확인 해 보겠습니다.</p>\n<ol>\n<li>Free-Tier 인스턴스 타입인 t2.micro는 실제 프로젝트에서 사용하는 t4g.micro와 메모리(1GB)사양이 같고, 여기에 프로젝트 환경과 동일하게 2GB 스왑 메모리를 적용하였습니다.\n<ul>\n<li>제 개인 배포에 사용되는 인스턴스이다보니, Mysql 등 다른 프로세스도 실행이 되어 있습니다. 따라서 전체 사용량보다는 사용량의 변화를 중점으로 확인해주세요.</li>\n</ul>\n</li>\n<li>배포는 프로젝트 코드가 아닌 테스트를 위해 작성한 별도의 코드로 진행합니다. 규모는 프로젝트 코드보다 현저히 낮으며, 코드는 <a href=\"https://github.com/pricelees/woowang-pic\">GIthub 링크</a>에서 확인하실 수 있습니다.\n<ul>\n<li>프로젝트 코드를 받아와서 진행할 수도 있지만, 배포까지의 절차가 복잡하고 원하는 코드를 바로바로 추가할 수 있는 이유로 개인 코드를 사용합니다.</li>\n</ul>\n</li>\n</ol>\n<p>우려하는 점은 Graceful shutdown과 관련이 있는데요, 하나씩 더 자세하게 작성해 보겠습니다.</p>\n<br/>\n<h3 id=\"1-graceful-shutdown이-사실상-적용되지-않습니다\" style=\"position:relative;\"><a href=\"#1-graceful-shutdown%EC%9D%B4-%EC%82%AC%EC%8B%A4%EC%83%81-%EC%A0%81%EC%9A%A9%EB%90%98%EC%A7%80-%EC%95%8A%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-label=\"1 graceful shutdown이 사실상 적용되지 않습니다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Graceful Shutdown이 사실상 적용되지 않습니다.</h3>\n<p>기존의 과정에서, <code class=\"language-text\">POST /termination → 25초 sleep</code> 과정을 거치면 해당 시점에서는 ELB가 더 이상 트래픽을 보내지 않습니다. 조금 더 자세히 말씀드리면 다음과 같습니다.</p>\n<ol>\n<li>현재 헬스체크의 비정상 임계값은 3, 제한 시간은 2초, 간격은 5초입니다. 이 값으로만 ELB의 트래픽 중단까지의 시간을 간단하게 계산 해보면 <strong>16.xx초 ~ 20.xx초</strong>가 소요됩니다.</li>\n</ol>\n<blockquote>\n<p>16.xx초: /termination 호출과 동시에 헬스체크가 이뤄지는 경우. 즉 대기(0.xx초) → 확인(2초) → 대기(5초) → 확인(2초) → 대기(5초) → 확인(2초) 인 경우<br>\n20.xx초: 이전의 헬스체크가 끝난 동시에 /termination 호출이 이뤄지는 경우. 즉 대기(4.xx초) → 확인(2초) → 대기(5초) → 확인(2초) → 대기(5초) → 확인(2초) 인 경우</p>\n</blockquote>\n<ol start=\"2\">\n<li>\n<p>하지만 이 시간은 헬스체크 요청 및 실패 응답까지 <strong>제한 시간인 2초가 모두 소요된다는 가정 하</strong>이며, <strong>실제로는 요청부터 응답까지 2초가 나오지는 않습니다.</strong> 아래의 히스토그램을 보면, 100번의 요청 중 거의 대부분(이 그래프에서는 95번)이 <strong>0.06초 ~ 0.07초</strong>에 완료되는 것을 확인할 수 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABjklEQVQ4y62UwU7bQBCGebheeqHquRxRH6fiUA7lArwFbUEtAgQcIAQELfJCmtiBBJKA7dhZr9f7IS9xayuNBFJGWnnWO/+v2X9mdg4gyzJMpnk2g+u2cByHRqOB67oIIazfbrftvtlsMhqN0FqjlLJ4izSGOTOmqTtNljdOWP9xRm/wSCIlcRxbYP4t/GJJKUmSxPpRFP0j1JmBNOHrkcObTz/5sLJLzx/yGstJS4QZWsZs1gTvl3f5uLbP/WPIsxTGBk1bhVwVwvF/NmtXzH/eYXG1RFgc/semEqo0RUYh32tiNoTdu3tMmrBVv54NYRCGjEJ/dhkWATPTMK9ypmQlw7uH4G+Vy+AXVdmCtLJt8862zQFBFE9kMs0mCcfx344Fb5e2Wfiyw+HvFpdejyCSFbBKNZ2Bz23fRyplxzQnzKeooqFKJOfONXu/XLbrgr0zwcHFHy6vGsRxZOc3CHxuOh1ORYtT4eLd3Nqzbrdr57nU2IUWevI6WjMcDvE8j36/X7m+GT8I+QNRlucJn6wpckzVcxMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"헬스체크 소요 시간\"\n        title=\"헬스체크 소요 시간\"\n        src=\"/static/733b3c17d11cd1d9fff49ee865ba4c48/37523/1.png\"\n        srcset=\"/static/733b3c17d11cd1d9fff49ee865ba4c48/e9ff0/1.png 180w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/f21e7/1.png 360w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/37523/1.png 720w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/302a4/1.png 1080w,\n/static/733b3c17d11cd1d9fff49ee865ba4c48/844cc/1.png 1306w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n</li>\n</ol>\n<blockquote>\n<p>그래프는 python의 seaborn을 이용하였습니다.</p>\n</blockquote>\n<ol start=\"3\">\n<li>그럼에도 헬스체크 응답까지의 시간을 넉넉잡아 <strong>0.1초</strong>로 잡았을 때의 ELB의 트래픽 전송 중단까지의 최소 시간은 <strong>10.3xx초</strong>가 됩니다. 즉 ELB의 트래픽 전송 중단까지는 <strong>10.3xx</strong>초부터 <strong>20.xx초</strong>까지 소요된다고 할 수 있습니다.</li>\n</ol>\n<blockquote>\n<p>10.3xx초: 이전의 16.xx초에서 확인하는 2초를 0.1초로 바꾸고 계산한 값</p>\n</blockquote>\n<ol start=\"4\">\n<li>그러면 다음 줄인 sleep 25가 실행되는 동안 springboot가 새로운 요청을 받지 않고 기존의 요청을 처리할 수 있는 시간이 <strong>적어도 4.xx초</strong>(25초 - 20.xx초) <strong>부터 14.6xx초</strong>(25초 - 10.3xx초)<strong>까지</strong> 주어지며, 이 시간은 현재 프로젝트 규모와 트래픽을 고려했을 때 기존의 요청을 충분히 처리할 수 있는 시간입니다.</li>\n</ol>\n<p>즉, sleep 25 직후의 시점에서는 springboot가 요청을 받지도, 처리하고 있지도 않을 가능성이 농후한데 이후의 <strong>배포 준비 과정동안 메모리를 점유하고 있는 상황</strong>입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.666666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAe0lEQVQI1yWLSRKCMBQFuZFMAvkxpkjCICCKlnr/k7RFWPSmX78kTF90u1CZGXEbyj3RfsMMH7S9I9eZpl0PH96Y8YeyC046lHsgfouczYQOLxJlZ0rpOVWeXMZIpnoKfSOrA2nlSZuOXIa4FZeJvOmoSxu73e9tWh//PzOTRabYgjaCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메모리_1\"\n        title=\"메모리_1\"\n        src=\"/static/725e27e3dce45ea6f648f54578e0126f/37523/2.png\"\n        srcset=\"/static/725e27e3dce45ea6f648f54578e0126f/e9ff0/2.png 180w,\n/static/725e27e3dce45ea6f648f54578e0126f/f21e7/2.png 360w,\n/static/725e27e3dce45ea6f648f54578e0126f/37523/2.png 720w,\n/static/725e27e3dce45ea6f648f54578e0126f/302a4/2.png 1080w,\n/static/725e27e3dce45ea6f648f54578e0126f/07a9c/2.png 1440w,\n/static/725e27e3dce45ea6f648f54578e0126f/cc6fe/2.png 1860w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>사진은 <strong>sar -r 1</strong> 명령어로 1초 단위로 변화를 관찰한 뒤, 필요한 부분만 잘라붙였습니다.</p>\n</blockquote>\n<p>실제 메모리 변화를 관찰해보면, 빌드 중 최대 <code class=\"language-text\">68.17%</code>까지 메모리 사용률이 올랐고, 빌드가 끝난 뒤 <code class=\"language-text\">49%</code>대까지 떨어짐을 확인할 수 있는데요, gradle build 자체가 메모리를 상당히 많이 사용하는 작업이기에 기존의 springboot가 불필요하게 메모리를 점유하는 상황이 서버의 부하로 이어질 수 있습니다.</p>\n<br/>\n<h3 id=\"2-graceful-shutdown이-적용이-되도-문제가-발생할-수-있습니다\" style=\"position:relative;\"><a href=\"#2-graceful-shutdown%EC%9D%B4-%EC%A0%81%EC%9A%A9%EC%9D%B4-%EB%90%98%EB%8F%84-%EB%AC%B8%EC%A0%9C%EA%B0%80-%EB%B0%9C%EC%83%9D%ED%95%A0-%EC%88%98-%EC%9E%88%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-label=\"2 graceful shutdown이 적용이 되도 문제가 발생할 수 있습니다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Graceful Shutdown이 적용이 되도 문제가 발생할 수 있습니다.</h3>\n<p>이전에 언급한 대로 기존의 springboot를 종료하는 시점에서는 처리할 요청이 없어 graceful shutdown이 사실상 적용되지 않겠지만, 그럼에도 발생할 수 있는 문제 상황을 가정해 보겠습니다.</p>\n<ol>\n<li>이전에 계산한 대로, ELB가 트래픽을 배분하지 않아 <strong>springboot가 남아있는 요청만을 처리할 수 있는 시간은 4.xx~14.6xx초</strong>일 것입니다.</li>\n<li>빌드 등 배포 준비 과정이 보통 <strong>40초 ~ 1분</strong>정도 소요되니, 1의 시간을 포함하면 기존의 springboot를 종료할 때 까지 <strong>44.4xx초 ~ 1분 14.6xx초 정도의 시간</strong>동안 요청을 처리할 수 있습니다.</li>\n<li>현재 프로젝트에서는 이 정도 시간이 소요되는 작업도 없고, 이 정도의 트래픽이 몰리지도 않습니다. 즉, 44초 이상의 시간이 필요한 작업이라면 <strong>무한 루프 등의 시간이 지나도 해결이 되지 않을 문제일 가능성이 높습니다</strong>.</li>\n</ol>\n<p>아래의 입력된 delay(초) 만큼 멈춰 graceful shutdown의 적용을 확인하는 API를 호출한 뒤 메모리 사용량을 확인 해 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/shutdown-test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span>\n     <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"delay\"</span><span class=\"token punctuation\">,</span> defaultValue <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_SHUTDOWN_DELAY</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">int</span> delay<span class=\"token punctuation\">,</span>\n     <span class=\"token class-name\">Model</span> model\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Shutdown request received. Delay: {} seconds\"</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>delay <span class=\"token operator\">*</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n \n     model<span class=\"token punctuation\">.</span><span class=\"token function\">addAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delay\"</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">return</span> <span class=\"token string\">\"success-shutdown\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeklEQVQI1x2KWQ6DIAAFPVGruCDgUkRUUo1tbdL7n2Qa+JhM8t5kdr0w9qAZdrR7J0z0/MEMz4R8HOjphfEX/fZDdYFRL6lp7Unnv5R6QQ47mewDlfLcG4fQG0KvFGqliK6nRN56CrWkT5iAaBx1NaY+7qUJ3GpLLmf+HGVFUcgZGP0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메모리_2\"\n        title=\"메모리_2\"\n        src=\"/static/b5949fdbfd2eb39ef77bd7da6e789d84/37523/3.png\"\n        srcset=\"/static/b5949fdbfd2eb39ef77bd7da6e789d84/e9ff0/3.png 180w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/f21e7/3.png 360w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/37523/3.png 720w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/302a4/3.png 1080w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/07a9c/3.png 1440w,\n/static/b5949fdbfd2eb39ef77bd7da6e789d84/b6e50/3.png 1862w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>새로운 springboot를 실행하는 동안의 메모리 점유율이 <code class=\"language-text\">50.71%</code> 에서 <code class=\"language-text\">67.55%</code> 까지 올랐고, 기존 springboot가 graceful shutdown을 마친 이후 스크립트 실행 전과 비슷한 <code class=\"language-text\">51%</code> 정도로 떨어집니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABHklEQVQoz4WQy26DMBBF8/8f10WVNLQLSEoTCG+wDfh5KkCKqlZpRjry3cyR5+6UlCilkFKhZwlhJDhJcAq8WrO3YiV4zTIhBB7NThtD13UY62jKlPJ6oLi8UWVHisuBOo/I0z1f8QuTap4Lm7YjTk4IOSKaFFkekFW0IsojqooY63dkscfq4blwO3c5e2SUNV6X2HnDzT9zgbfyLnzETgixCpcOJ1nh59u2rAv8vGGnG2bM7sL/ZrfIsixHa0NbX/lMXskv0UqRfXBOXunqBDPmGD3gfMB5/wfv/fbDru+J46VDhehvDO2Jvj3TN+f17ZoTsk9RQ8o0dmjrmI1BG7uy5FkbnHObcOlQqa3DSbUE2+LNL3SDm2uCm56e/A1hQGxCD1EkGAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"흐름도\"\n        title=\"흐름도\"\n        src=\"/static/49bbe9a16d62e05ffc39202e952fa100/37523/4.png\"\n        srcset=\"/static/49bbe9a16d62e05ffc39202e952fa100/e9ff0/4.png 180w,\n/static/49bbe9a16d62e05ffc39202e952fa100/f21e7/4.png 360w,\n/static/49bbe9a16d62e05ffc39202e952fa100/37523/4.png 720w,\n/static/49bbe9a16d62e05ffc39202e952fa100/302a4/4.png 1080w,\n/static/49bbe9a16d62e05ffc39202e952fa100/52576/4.png 1412w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>이 사진에서 노란색 영역은 기존 springboot와 새로운 springboot가 동시에 실행되는 구간입니다.</p>\n</blockquote>\n<p>즉, 주어진 시간인 44.xx초 ~ 1분 14.6xx초 동안 해결되지 않는 문제이면 새로운 springboot를 실행하는 동안 기존의 springboot가 graceful shutdown을 진행하도록 할 필요가 없습니다. 어차피 기존의 springboot를 종료한다면, 차라리 일찍 종료하는게 더 나은 방법입니다. (아니면 아예 새로운 버전의 배포를 멈추는 것도 방법입니다.)</p>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<p>테스트하는 과정에서 인스턴스가 튕기거나, 입력 및 처리가 현저히 느려지는 현상이 발생할 정도로 현재 과정에서는 graceful shutdown이 진행되는 여부와 관계 없이 메모리 부하가 발생할 수 있음을 확인하였습니다. 떠오르는 개선 방법은 정~말 간단한데요, 실제로 테스트를 해보며 이 방법이 적용 되는지 확인 해 보겠습니다.</p>\n<br/>\n<h2 id=\"개선해보기\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%84%A0%ED%95%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"개선해보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개선해보기</h2>\n<h3 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h3>\n<p>우선, 내용이 길어 기존 방법이 헷갈릴 수 있으니 기존 방법을 한번 더 언급하겠습니다. <code class=\"language-text\">sleep 25</code> 까지의 명령어로 ELB의 트래픽 전달을 막고, 빌드 등의 준비를 마친 뒤 기존 springboot를 종료하고 새로운 springboot를 실행하는 과정입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 기존 방법</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://localhost:8080/termination\n<span class=\"token function\">sleep</span> <span class=\"token number\">25</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인</code></pre></div>\n<p>떠오르는 개선 방법은 정말 간단한데요, 아래와 같이 <code class=\"language-text\">kill [기존 springboot]</code>를 <code class=\"language-text\">sleep 25</code> 직후 실행되도록 옮겨 <strong>ELB가 트래픽을 전달하지 않는 순간에 바로 springboot를 종료</strong>하는 방법입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 새로운 방법 방법</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://localhost:8080/termination\n<span class=\"token function\">sleep</span> <span class=\"token number\">25</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인</code></pre></div>\n<p>개선했을 때 기대되는 결과는 다음과 같습니다.</p>\n<ol>\n<li>graceful shutdown이 진행되지 않는다면, ELB의 트래픽 배분 중지와 동시에 기존 springboot가 종료될테니 빌드 등 새로운 springboot의 배포 준비 과정에서의 메모리 부하가 줄어들 것입니다.</li>\n<li>graceful shutdown이 진행된다고 하더라도, 배포 준비 시간(보통 40 ~50초)동안 30초인 timeout 만료로 기존의 springboot가 종료될테니 새로운 springboot가 실행될 때의 메모리 부하가 줄어들 것입니다.</li>\n</ol>\n<p>이제 본격적으로 테스트를 해보며, 이 개선안이 실제로 유의미한지 살펴보겠습니다.</p>\n<br/>\n<h3 id=\"1-테스트---graceful-shutdown이-적용되지-않을-때\" style=\"position:relative;\"><a href=\"#1-%ED%85%8C%EC%8A%A4%ED%8A%B8---graceful-shutdown%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%98%EC%A7%80-%EC%95%8A%EC%9D%84-%EB%95%8C\" aria-label=\"1 테스트   graceful shutdown이 적용되지 않을 때 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 테스트 - graceful shutdown이 적용되지 않을 때</h3>\n<p>테스트는 제 개인 EC2에서 진행하고 있고, 공개된 도메인도 아니기에 제가 별도의 요청을 보내지 않는 이상 springboot가 처리할 별도의 요청이 존재하지 않을 것입니다. 즉 이 경우에서는 kill 명령어로 기존의 springboot를 종료하면 바로 프로세스가 종료될 것이라고 생각할 수 있습니다.</p>\n<p>테스트는 기존 방법과 수정한 방법을 각 3회 진행한 뒤 평균을 낸 값을 비교하는 방법으로 진행하였습니다.</p>\n<blockquote>\n<p>물론 정규분포에 가까워진다고 여겨지는 30회 정도의 시도는 해보고 싶었으나.. 로그를 정리하는 시간이 생각보다 오래 걸리고, 3회 시도에서의 편차가 거의 없어 추이를 판단하기에는 크게 무리가 없다고 판단하였습니다.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABoUlEQVQoz3WTjY6jMAyE+/7veCtdDwrl2gIhifNnz8mBsN1dXaQIMOTzjG0uOWd47xFCqDvGiMfjgb7vcbvdMI5Dve/7Dr+vHf70A7qux/V6reecJ8zLgnmeUZhxSSnVFyJy7sIFLAJA7wWGMmxkOO9hzYJEFrqYGTkS+q7Dr48PKOuiqhSoSyoEFQgRxFxgfEIqgkAehTYgeWyvO6R9386UsgPVskKP+J5ZClIpWH08AgmI254UgLMWJcV6ph07geu6wjl3KJNq1YQE4yOYd9tC5iyHrkQOkdxBShAuSPkAPp/PqtBbA2tmbOuMbVsB4d1WtECJnxZVcPQoKVSQJtvMUkuScsZlmqZT4VFIsH+BE0GYgbCdsLPGB5CsgXGEkAVc0q5QG6Kjcna5Ws/g6CCJgBx+APW6vSY4s5w6zhqq3aawda2OjSoj82n9SNagf58vxJh+AluX3y0XhfhlBx6x7ytrA1n+r/B9sLMwmMyu8s3ul81cB7spVmEVqA/WWizLUgOagALhfp9qTOvbfsu2x3HEMAz119Sx02+IqKr8B/x4q+nEyHr0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"그래프_1\"\n        title=\"그래프_1\"\n        src=\"/static/5e11d2f228b8629cf9ac5e6e16f27e51/37523/5.png\"\n        srcset=\"/static/5e11d2f228b8629cf9ac5e6e16f27e51/e9ff0/5.png 180w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/f21e7/5.png 360w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/37523/5.png 720w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/302a4/5.png 1080w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/07a9c/5.png 1440w,\n/static/5e11d2f228b8629cf9ac5e6e16f27e51/76435/5.png 1742w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>그래프는 python의 matplotlib을 이용하였고, 배포 과정에서 1초 단위로 기록된 모든 메모리 사용률을 넣었습니다.</p>\n</blockquote>\n<p>위 그래프의 <strong>초록색 선</strong>은 배포 시작뒤 25초 정도가 경과한 시점인데(sleep 25 및 kill [기존 springboot]  호출 뒤), 기대했던 대로 이 시점부터 새로운 springboot가 실행되는 배포 준비 과정까지 전체적인 메모리 사용량이 낮아졌습니다.</p>\n<p>추가적으로 새로운 springboot가 실행된 이후의 메모리 사용량은 비슷한 걸 보면, 기존의 springboot 역시 kill 명령어의 호출과 동시에 graceful shutdown 없이 바로 종료되는 것도 확인할 수 있습니다 😄</p>\n<br/>\n<h3 id=\"2-테스트---graceful-shutdown이-적용될-때\" style=\"position:relative;\"><a href=\"#2-%ED%85%8C%EC%8A%A4%ED%8A%B8---graceful-shutdown%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%A0-%EB%95%8C\" aria-label=\"2 테스트   graceful shutdown이 적용될 때 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 테스트 - graceful shutdown이 적용될 때</h3>\n<p>이전에 테스트용으로 만들었던 Delay를 주는 API를 호출하여, graceful shutdown이 최대(=timeout)인 30초동안 진행되도록 한 뒤 이전과 마찬가지로 기존 방법과 새로운 방법을 각 3회 테스트하였습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABnElEQVQoz32Ti47iMAxF+///CAhNYSWgA83Ledl3ZPexMFptpNDEsW9ObDMAQK0VOWeUUmw9zzPGccTlcsHl+gdfXyOOxyPO57PZD4eDnal/yhkpJRARRASDGkMIYOZ9ttbMufWOGh1ajqitQ7gjUMJjTii1ovcOStEuO51Oi6Aale73kPU3zE98f0+IpSGlCPe6o7PY3gZ3E1ZK/Q76xBjjEi7yMXty8FQgwqB5gp+/0VtBD5PZl5hFt67Eg779N6H5VALFgNK3CAIaoa/r4B1Y/r5lF7zdbobLmo+cweQgrdg35GakiiFraGeVZPj5Bb1LbQpFqsGM4fF4WAEoenjnLMlIk6WBGu+pwJYGZkA6op+RmsCFiBydaRihtogSbiPkjlwKXKofed3WCyHQyeMZMjh7229VH9RJc7gELQQ+N2uT/wlyjpCagLrA7IS62Kr8URjhf7SSgGUVJA9Jz91vL4o1J9He1LpXkvdGfz+rbW0XcjudnukrTVANSvh6vewWndM04X6/2zPepwZt55dxxPV6hRZV/1kb1A+Wbatu3ZXNagAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"그래프_2\"\n        title=\"그래프_2\"\n        src=\"/static/f88f72d51d4a297e7e03dc30e04a9e92/37523/6.png\"\n        srcset=\"/static/f88f72d51d4a297e7e03dc30e04a9e92/e9ff0/6.png 180w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/f21e7/6.png 360w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/37523/6.png 720w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/302a4/6.png 1080w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/07a9c/6.png 1440w,\n/static/f88f72d51d4a297e7e03dc30e04a9e92/f69df/6.png 1762w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>빌드가 시작되기 전에 기존의 springboot를 종료해도 graceful shutdown이 진행되기에 <strong>빌드 과정에서의 메모리 점유율은 기존 방법과 동일</strong>하지만, <strong>초록색 선</strong>의 시점(=graceful shutdown이 완료된 시점)부터는 기존 방법보다 메모리 사용량이 낮아짐을 확인할 수 있었습니다.</p>\n<br/>\n<h2 id=\"결론-1\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0-1\" aria-label=\"결론 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<p>기존의 springboot를 종료하는 순서만 바꾸는 단순한 작업임에도, 메모리 사용량이 줄어든 수치적인 변화와 더불어 인스턴스가 멈추는 등 기존 방법에서 나타났던 문제도 발생하지 않음을 확인할 수 있었습니다.</p>\n<p>다음 글에서는 Deregistration Delay라는 개념을 이용하여 <code class=\"language-text\">POST /termination → sleep 25</code> 과정을 대체해 보겠습니다. 긴 글 읽느라 고생 많으셨습니다 😄</p>","excerpt":"배경 프로젝트 팀원인 테니가 기존의 무중단 배포에서 다운타임이 발생하는 문제를 해결하는 PR을 올렸습니다. 자세한 내용은 해당 PR에서 확인하실 수 있습니다. 문제도 잘 파악했고, 해결까지의 전체 과정을 문서화해서 공유해준 덕분에 전체 과정을 빠르게 이해할 수 있었는데요(테니 감사합니다 😄), 제가 PR에 남겼던 댓글 중 일부를 직접 테스트해본 결과를 바탕으로 기존 방법에서 조금 더 개선이 가능한 부분을 공유하고자 합니다. 기존 배포 과정 개선 방법을 작성하기 전에, 기존의 과정을 순서대로 살펴보며 전체 흐름을 다시 정리하겠습니다. 1. 인스턴스 내부에서 POST /termination 요청을 보내 ELB의 헬스체크에 실패하도록 지정 ELB의 헬스체크에 사용되는 코드를 살펴보겠습니다.  메서드는 필드에 있는 AtomicBoolean 값이 이면 ELB가  로 헬스체크 요청을 보낼 때 을 보내는 코드입니다. ELB에는 헬스체크 정상 응답 코드가 200으로 지정되어 있습니다.  메서드는…","frontmatter":{"date":"November 06, 2024","title":"무중단 배포 과정에서의 매모리 사용량 개선 - 기존 애플리케이션의 종료 시점 변경","categories":"level4 aws","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/improving_deployment/1/"}},"next":{"id":"3a9088fb-6964-5011-97d6-18839cb91de7","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>팀원의 코드를 리뷰하고 있었는데, 아래와 같은 코드가 있었습니다.</p>\n<blockquote>\n<p>실제 코드와 다르며 내용 파악을 위해 일부 수정하였습니다.</p>\n<p>내용은 중요하지 않긴 하지만.. 간단하게만 말씀드리면 ELB에서의 헬스체크를 의도적으로 실패하도록 하는 API 입니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/terminate\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> remoteHost <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"0:0:0:0:0:0:0:1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>remoteHost<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        isTerminated<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FORBIDDEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>이 코드에서의 핵심은 <strong>클라이언트의 IP(=remoteHost)가 로컬호스트인 경우에만 OK 응답</strong>을 주겠다는 건데, 여기서 의문이 들었던 것은 “<strong>Nginx 설정과 무관하게 getRemoteHost()가 항상 실제 클라이언트의 IP를 반환할 것을 보장하는지?</strong>” 였는데요, 의문이 들었던 내용부터 실제 테스트를 하며 확인한 결과를 하나하나 작성해 보겠습니다.</p>\n<br/>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABK0lEQVQoz2WRz0oDMRCH9yW9+ga+gu8gguhFFEE8CF6ECp7EgwgelKKIKLSHCi1qt62bTJLJfpLs9o868MtMAvnyy0xR1zVzkQTLfa5jzmbYY3y5Sx0EjTUxKjHGLG3rdKegjV/g1bPYAMuXO/rb6+AM4gLWWqxIls97QUQoErmqKlZDzYQoszk2r5WxlOWMTzvlb1R+ll0maDEuS3b29jPdmApNbq4PkPuzBh48QUPmdkdvrHU2OXy6WLz1OnrkvHvEt0xx4inKcsLxySlRtemNt9RfPerJOyoGKy5/iwjPH302rrbo9G5JLzsXGE4GPAxusN4g4ihUlQRdNi4mW6B+MaQU4hzRK751Ox9IqsVbfPC5r/+H0nZtoRaqGjHW4lzjWFbknM85BOUH/K0b96vhphoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인프라_구조\"\n        title=\"인프라_구조\"\n        src=\"/static/17bf5285cfa1dbc61cd59005efc0946d/37523/architecture.png\"\n        srcset=\"/static/17bf5285cfa1dbc61cd59005efc0946d/e9ff0/architecture.png 180w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/f21e7/architecture.png 360w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/37523/architecture.png 720w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/302a4/architecture.png 1080w,\n/static/17bf5285cfa1dbc61cd59005efc0946d/37048/architecture.png 1352w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>시작하기 전에, 이번 글에서 사용하는 인프라 구조입니다!</p>\n<br/>\n<h2 id=\"질문\" style=\"position:relative;\"><a href=\"#%EC%A7%88%EB%AC%B8\" aria-label=\"질문 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>질문</h2>\n<p>이전 문단에 나왔던 코드의 getRemoteHost() 부분에 아래와 같은 질문을 남겼었습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhElEQVQI12VOTQ/CIBTj//8/NzN4ymbCYR7G18ExoOahmCU2adrXQ/sEkYQxBuv6hLUOPgTknHEcR9PmvzczpYRaKxhdQ4zYNotSCsS+v6DnBcN4hVSEaZIgukFK1bxShHl54DKMuGsN5/xfIQ/2IcGB87Gt8wLz81n5fdmzXnAuO2eMNyZO58ERVEn+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"코드리뷰_질문\"\n        title=\"코드리뷰_질문\"\n        src=\"/static/f6e51f5433612ecbad74d64cf501da57/37523/question.png\"\n        srcset=\"/static/f6e51f5433612ecbad74d64cf501da57/e9ff0/question.png 180w,\n/static/f6e51f5433612ecbad74d64cf501da57/f21e7/question.png 360w,\n/static/f6e51f5433612ecbad74d64cf501da57/37523/question.png 720w,\n/static/f6e51f5433612ecbad74d64cf501da57/302a4/question.png 1080w,\n/static/f6e51f5433612ecbad74d64cf501da57/07a9c/question.png 1440w,\n/static/f6e51f5433612ecbad74d64cf501da57/d3b46/question.png 1690w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>찝찝했던 이유는 이전에 ELB를 사용하기 전 EC2로 직접 요청을 보냈을 때 클라이언트 정보를 읽어오지 못해 문제가 발생했던 경험이 있었기 때문인데요, 이번에 ELB를 도입하며 비슷한 문제가 발생할 수도 있겠다는 우려가 있었던 것 같습니다 ㅎㅎ</p>\n<blockquote>\n<p>당시 발생했던 문제는 getRemotePort()를 호출했을 때 실제 요청 포트(443)을 읽지 못해 Swagger-UI에서 CORS가 발생했던 것인데요, <a href=\"https://github.com/woowacourse-teams/2024-mouda/pull/506\">PR 링크</a>에서 확인하실 수 있습니다.</p>\n</blockquote>\n<br/>\n<p>시작하기 전에, 우선 <code class=\"language-text\">getRemoteHost()</code>에 어떤 값이 들어가는지부터 확인해야 할 것 같습니다. 아래 코드는 HttpServletRequets의 구현 클래스 중 하나인 Request 클래스의 메서드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Request</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">HttpServletRequest</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getRemoteHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connector<span class=\"token punctuation\">.</span><span class=\"token function\">getEnableLookups</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n    \n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>remoteHost<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드를 보면, getRemoteHost()도 <code class=\"language-text\">getRemoteAddr()</code> (=클라이언트의 IP)를 값으로 가지는데요, 이 메서드를 호출했을 때 실제 클라이언트의 IP를 기록하려면 아래의 설정이 필요합니다.</p>\n<br/>\n<ul>\n<li><strong>필수</strong>:  Nginx 설정파일에 <code class=\"language-text\">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> 를 추가하여 X-Forwarded-For 헤더를 springboot에 전달하도록 해야 합니다d.</li>\n</ul>\n<ol>\n<li>application.yml에 <code class=\"language-text\">server.forward-headers-strategy=native</code> 과 같은 Forward 헤더를 읽는 설정을 추가한다.</li>\n<li>설정을 추가하지 않았다면, getRemoteHost()가 아니라 <code class=\"language-text\">getHeader(”X-Forwarded-For”).split(”, “)[0]</code> 으로 값을 읽어와야 한다.</li>\n</ol>\n<p>위 과정 또는 비슷한 과정을 거치지 않았다면 인스턴스 외부에서의 요청에도 getRemoteHost()를 호출했을 때의 결과가 Localhost가 될 수 있습니다. 사실 ELB가 추가된 환경에서도 클라이언트의 IP를 정확하게 읽어올 것이라고 예상되긴 하는데요, 그럼에도 잘못 호출되는 경우 서버가 터질 우려가 있기에.. 적어도 한 번은 확인해볼 필요가 있다고 생각했습니다.</p>\n<blockquote>\n<p>제 테코톡(<a href=\"https://youtu.be/oUroldyG1_s?si=osh0ER_t6s8JWUNG&#x26;t=642\">링크</a>)에서 X-Forwarded-For 헤더와 클라이언트의 IP를 기록하는 방법을 다룹니다 ㅎㅎ 아래 글이 이해가 안 가신다면 영상을 참고해주세요!</p>\n</blockquote>\n<br/>\n<h2 id=\"확인\" style=\"position:relative;\"><a href=\"#%ED%99%95%EC%9D%B8\" aria-label=\"확인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>확인</h2>\n<p>이전 문단에서 다뤘듯이, 클라이언트의 IP를 가져오려면 <strong>springboot로 가는 요청에 클라이언트의 IP가 담긴 X-Forwarded-For 헤더가 포함</strong>되어야 하는데요,</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAcklEQVQY062L6wrDIAyFff9XHIxBnXUdvZikP4ziGUbWJ2jgI+eSuBACvH9jmjyW5YtaK1QVWRWqBaUMelZ6Z74i59Hr1Q/tHs8XEhHWbUciBouAmC1jlovuRU6kRHZz2D5N/386LswRd46L8YPW2m38AJQvOOMN2pM2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ELB에서의 X-Forwarded-For 헤더 설정\"\n        title=\"ELB에서의 X-Forwarded-For 헤더 설정\"\n        src=\"/static/095d410edbfd1eedcf80b101867cf738/37523/xforwardedfor.png\"\n        srcset=\"/static/095d410edbfd1eedcf80b101867cf738/e9ff0/xforwardedfor.png 180w,\n/static/095d410edbfd1eedcf80b101867cf738/f21e7/xforwardedfor.png 360w,\n/static/095d410edbfd1eedcf80b101867cf738/37523/xforwardedfor.png 720w,\n/static/095d410edbfd1eedcf80b101867cf738/302a4/xforwardedfor.png 1080w,\n/static/095d410edbfd1eedcf80b101867cf738/67a79/xforwardedfor.png 1408w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">AWS ELB 상세 페이지 → 작업 → Load Balancer 속성 편집</code>에 있는 위 설정으로 X-Forwarded-For 헤더 설정이 가능하며, 각 항목은 다음과 같습니다.</p>\n<ul>\n<li><strong>첨부</strong>: X-Forwarded-For 헤더에 클라이언트의 IP를 저장(추가) 하여 서버로 전달</li>\n<li><strong>보존</strong>: 기존의 X-Forwarded-For를 그대로 전달</li>\n<li><strong>제거</strong>: 기존의 X-Forwarded-For가 있으면 삭제</li>\n</ul>\n<p>따라서 클라이언트의 요청을 받는 ELB에서는 해당 설정이 ‘<code class=\"language-text\">첨부</code>’로 되어 있어야 실제 클라이언트의 IP가 기록되어 전달됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrequest<span class=\"token punctuation\">.</span><span class=\"token function\">getHeaderNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">asIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">forEachRemaining</span><span class=\"token punctuation\">(</span>headerName <span class=\"token operator\">-></span> headers<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>headerName<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span>headerName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>확인은 위 코드를 이용하여 실제 요청에 있는 모든 헤더를 출력한 뒤 EC2 내부의 Nginx 설정에 따라 X-Forwarded-For 헤더가 어떻게 달라지는지, 실제 헤더가 포함되고, 클라이언트의 IP가 잘 전달되는지 확인하는게 목표입니다!</p>\n<br/>\n<h3 id=\"1-nginx-설정에-x-forwarded-for-헤더-설정이-있는-경우\" style=\"position:relative;\"><a href=\"#1-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%9E%88%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"1 nginx 설정에 x forwarded for 헤더 설정이 있는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Nginx 설정에 X-Forwarded-For 헤더 설정이 있는 경우</h3>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://localhost:8080</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nginx 포워딩 설정에 proxy_set_header를 추가하고, springboot로 요청을 보낸 뒤 헤더를 출력하면 아래와 같이 x-forwarded-for 헤더에 실제 클라이언트의 IP(1.22~)와 ELB의 IP(172.3~)가 포함됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhklEQVQY03VQ4QqGIAzs/Z9RMSv1l1H6R0W7jxOM6KPBcdttO9gmfERrDdd19ZzMemDEWyembdtgrYUxBsuyYF1XOOeQc0YIoevkUgpSSl333mOeZxzHceujN9FAKQUpJYQQ3ZAmHDjPE1prxBj78FikIXf2ff83/Dq51nqfR2Y98HzFUyd+MIA2P5PhrS8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"X-Forwarded-For 설정을 추가했을 때의 결과\"\n        title=\"X-Forwarded-For 설정을 추가했을 때의 결과\"\n        src=\"/static/05dfe8a2533b7d32aeb30585dc955493/37523/result_1.png\"\n        srcset=\"/static/05dfe8a2533b7d32aeb30585dc955493/e9ff0/result_1.png 180w,\n/static/05dfe8a2533b7d32aeb30585dc955493/f21e7/result_1.png 360w,\n/static/05dfe8a2533b7d32aeb30585dc955493/37523/result_1.png 720w,\n/static/05dfe8a2533b7d32aeb30585dc955493/2e694/result_1.png 1048w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h3 id=\"2-nginx-설정에-x-forwarded-for-헤더-설정이-없는-경우\" style=\"position:relative;\"><a href=\"#2-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%97%86%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"2 nginx 설정에 x forwarded for 헤더 설정이 없는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Nginx 설정에 X-Forwarded-For 헤더 설정이 없는 경우</h3>\n<p>1번에서의 proxy_set_header 라인을 지우고 동일하게 테스트를 해보면, 예상대로 아래와 같이 ELB의 IP는 기록되지 않고 클라이언트의 IP 만 기록됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 694px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAiklEQVQY05WQSQrFIBBEvf/BshFF3HiJbOKUOMT6dIMhCFl84UFVaUvRYowBgs7U/2ZvRCkF13XhPE+8NZFzZv+VrfTeIfZ9h7UWWmtGKYVt2yCl5Nw5h9YaD5A2xiClhForZ1RiFuEP6TKEwBzH8eC958EY49OQ9PSfDe/7xmTdx8zpIbH6FdrhD4BJg3MbdgoSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"X-Forwarded-For 설정이 없을 때의 결과\"\n        title=\"X-Forwarded-For 설정이 없을 때의 결과\"\n        src=\"/static/ab360a7e937b32e31eed4af1103e32c2/31198/result_2.png\"\n        srcset=\"/static/ab360a7e937b32e31eed4af1103e32c2/e9ff0/result_2.png 180w,\n/static/ab360a7e937b32e31eed4af1103e32c2/f21e7/result_2.png 360w,\n/static/ab360a7e937b32e31eed4af1103e32c2/31198/result_2.png 694w\"\n        sizes=\"(max-width: 694px) 100vw, 694px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<ul>\n<li>ELB에서의 X-Forwarded-Header 설정을 <code class=\"language-text\">첨부</code></li>\n<li>springboot에 <code class=\"language-text\">server.forward-headers-strategy=native</code> 설정</li>\n</ul>\n<p>위와 같은 현재 프로젝트의 환경에서는, EC2의 Nginx에 <code class=\"language-text\">proxy_set_header X-Forwarded-For \"127.0.0.1\";</code> 와 같이 localhost를 명시적으로 지정하지 않는 한, 인스턴스 외부 요청에 대한 getRemoteHost() 값이 localhost가 될 수 없음을 확인하였습니다.</p>\n<br/>\n<h2 id=\"의의\" style=\"position:relative;\"><a href=\"#%EC%9D%98%EC%9D%98\" aria-label=\"의의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>의의</h2>\n<p>AWS와 같은 배포 및 인프라 작업은, 어느정도 결과가 예상되도 확실하게 테스트를 하는게 속이 편한 것 같습니다. 글에서 다룬 내용은 진작에 알던 내용이지만 확실하게 하지 않으면 엄청나게 큰 문제가 발생할 수 있는 것을 사전에 확인해보는,  ‘절벽에 있는 돌다리를 두들겨보고 건너는’ 작업이었다는 점에서 의미가 있었던 것 같습니다 ㅎㅎ</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B0%B0%EA%B2%BD\">배경</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A7%88%EB%AC%B8\">질문</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%99%95%EC%9D%B8\">확인</a></p>\n<ul>\n<li><a href=\"#1-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%9E%88%EB%8A%94-%EA%B2%BD%EC%9A%B0\">1. Nginx 설정에 X-Forwarded-For 헤더 설정이 있는 경우</a></li>\n<li><a href=\"#2-nginx-%EC%84%A4%EC%A0%95%EC%97%90-x-forwarded-for-%ED%97%A4%EB%8D%94-%EC%84%A4%EC%A0%95%EC%9D%B4-%EC%97%86%EB%8A%94-%EA%B2%BD%EC%9A%B0\">2. Nginx 설정에 X-Forwarded-For 헤더 설정이 없는 경우</a></li>\n<li><a href=\"#%EA%B2%B0%EB%A1%A0\">결론</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9D%98%EC%9D%98\">의의</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"November 05, 2024","title":"AWS ELB 와 Springboot 에서의 클라이언트 IP 확인","categories":"level4 aws","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/check_client_ip/"}},"prev":{"id":"fb8e534b-6253-5881-85b7-98290bffa9df","html":"<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>기존 방법은, <strong>의도적으로 헬스체크에 실패하도록 하는 API를 호출하여 ELB(로드 밸런서)의 트래픽 배분을 막는 방법</strong>이었습니다. 팀원인 테니가 상황에 맞게 훌륭하게 구현해줬고, 문제될 여지가 거의 없다고는 느껴지지만 아래의 불확실성은 있다는 생각이 들었습니다.</p>\n<ol>\n<li>해당 API의 호출 시점, 그리고 서버의 상황에 따라 <strong>실제 트래픽 중단까지 최대 10초에 가까운 시간 차이가 발생</strong>합니다.</li>\n<li>배포 작업이 애플리케이션의 영향을 받습니다. 현재는 API를 호출하여 healthcheck에 사용되는라 불리언 필드를 false로 바꿔 헬스체크에 실패하도록 하고 있는데, 이걸 다시 true로 바꾸는 기능은 없습니다. 즉 배포 과정에서의 사소한 실수로 불필요하게 해당 API가 호출된다면 Springboot를 다시 배포해야 합니다.</li>\n</ol>\n<p>두개의 원인을 보면 결국 <strong>API를 다른 무언가로 대체</strong>하는 것이 해결 방법인 것 같은데요, 물론 다른 해결 방법도 있겠지만 이번 글에서는 AWS CLI에서 사용하는 <strong>Deregister</strong>라는 방법을 이용해 보겠습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxUlEQVQY0zWQC4uDMBCE/f8/7g5aH0mMxjzUmPO0hdoWBKfsSheGWT4myW4yHwb8/F4glUYlawhZoygFKqGYCaWRFwJCalzyEkUpYTqHlGaMcYIPPdbbHVTHcSCb5wXGWDgfEPoBMSZ433NPj4V+RGA/ZV1AnBIe24Zte7LTRd/K5v8FujGs1lhWZx2atmOm6oa91i0z6zwzmp6cNKU/LOsNr9cb2TBGXPOKw1KdhylMIlZWkllnPX/Hl5/5M0cb0rT7vuMDCO4kgLL3AVkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/929388051d273fbbdb3566cf488c222d/37523/1.png\"\n        srcset=\"/static/929388051d273fbbdb3566cf488c222d/e9ff0/1.png 180w,\n/static/929388051d273fbbdb3566cf488c222d/f21e7/1.png 360w,\n/static/929388051d273fbbdb3566cf488c222d/37523/1.png 720w,\n/static/929388051d273fbbdb3566cf488c222d/302a4/1.png 1080w,\n/static/929388051d273fbbdb3566cf488c222d/07a9c/1.png 1440w,\n/static/929388051d273fbbdb3566cf488c222d/bd9eb/1.png 1442w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><a href=\"https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/APIReference/API_DeregisterTargets.html\">AWS 공식 문서</a>에서는 Deregister를 위와 같이 소개하고 있습니다. 이 글의 target에 EC2 인스턴스를 대입하면, “<strong>대상 그룹에 등록된 인스턴스를 등록 취소하여 로드 밸런서가 보내는 트래픽을 받지 않도록 한다</strong>” 라는 뜻이고, 이때 사용되는  Deregistration Delay는 이름 그대로 서버가 <strong>in-flight 요청</strong>(이미 들어와서 처리중인 요청)을 처리할 수 있도록 Deregister를 지연하는 값입니다.</p>\n<blockquote>\n<p>Deregistration Delay에 대한 개념은 <a href=\"https://karansingh.gitbook.io/aws-saa-c02/elb/connection-draining-deregistration-delay\">링크</a>를 참고해주세요!</p>\n</blockquote>\n<p>따라서, 이번 글에서는 <strong>aws-cli</strong>를 이용한 Deregister와 Deregisteration Delay를 직접 적용해볼 예정이고, 글의 흐름은 다음과 같습니다.</p>\n<ol>\n<li>Deregister 적용 및 확인</li>\n<li>확인 과정에서 판단한 문제</li>\n<li>이 문제의 원인 분석 및 해결 방법</li>\n</ol>\n<p>그리고 이후의 내용에서는 <strong>Deregister =</strong> <strong>등록 취소</strong> / <strong>Deregistration Delay =</strong> <strong>등록 취소 지연</strong>으로 통일하여 사용할 예정입니다 😄</p>\n<h3 id=\"주의\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EC%9D%98\" aria-label=\"주의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주의</h3>\n<ol>\n<li>이 방법을 이용하기 위해서는 <strong>ELB에 대한 IAM 권한 및 액세스 키가 필요</strong>합니다. 현재 프로젝트에서는 우아한테크코스에서 제공하는 AWS를 사용하고 있고, 현재는 해당 권한이 없어 프로젝트에 적용할 수 있는 방법이 아닙니다.</li>\n</ol>\n<blockquote>\n<p>리뷰를 할 때는 IAM 액세스 키를 사용할 수 없다는 걸 몰랐습니다..ㅠ 팀원 테니에게 죄송하다는 말씀 먼저 드립니다..</p>\n</blockquote>\n<ol start=\"2\">\n<li>본 글에서는 해당 과정을 실제 적용해보는 과정을 위주로 다룹니다. 따라서 AWS-CLI를 우분투에 설치하고 IAM을 등록하는 등의 과정은 생략합니다.</li>\n</ol>\n<br/>\n<h2 id=\"인스턴스-등록-취소하기\" style=\"position:relative;\"><a href=\"#%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C%ED%95%98%EA%B8%B0\" aria-label=\"인스턴스 등록 취소하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인스턴스 등록 취소하기</h2>\n<h3 id=\"등록-취소-지연-시간-설정\" style=\"position:relative;\"><a href=\"#%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C-%EC%A7%80%EC%97%B0-%EC%8B%9C%EA%B0%84-%EC%84%A4%EC%A0%95\" aria-label=\"등록 취소 지연 시간 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>등록 취소 지연 시간 설정</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAtUlEQVQoz6VQ0Q6CMAzk/78QRcYgIiYqcZGtGxucaQXjiz5gk0svvfXWNitLhX1RIM93YN73PWKMCCFsQqbrGlWloVSFpmlgjEFKabvhNE2Y51nARjwd41vwu19appSGqjQOpXrnrjuDvMdjGGCtg3UOjgjOkUzBtWGtO8JgrfCJDY/tCXdjpJlzGEd4H0CLAWfvvYDIi04Ld6KF12dE4G2z9tThcr0hxiQr/xtyw0+j9Z5b8QRiJyGstUaaqAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2\"\n        title=\"2\"\n        src=\"/static/05b64a5ae801a71f3e9ced630c62dd3d/37523/2.png\"\n        srcset=\"/static/05b64a5ae801a71f3e9ced630c62dd3d/e9ff0/2.png 180w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/f21e7/2.png 360w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/37523/2.png 720w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/302a4/2.png 1080w,\n/static/05b64a5ae801a71f3e9ced630c62dd3d/cf8e5/2.png 1402w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>등록 취소 지연값은 <code class=\"language-text\">EC2 → 대상 그룹 → 하단의 속성 탭 → 속성 편집</code>에서 설정할 수 있고, <code class=\"language-text\">기본값은 300초</code> 입니다.</p>\n<h3 id=\"aws-cli에서의-등록-취소-및-재등록-명령\" style=\"position:relative;\"><a href=\"#aws-cli%EC%97%90%EC%84%9C%EC%9D%98-%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C-%EB%B0%8F-%EC%9E%AC%EB%93%B1%EB%A1%9D-%EB%AA%85%EB%A0%B9\" aria-label=\"aws cli에서의 등록 취소 및 재등록 명령 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWS-CLI에서의 등록 취소 및 재등록 명령</h3>\n<p>다음으로, aws-cli에서 인스턴스를 등록 취소하기 위해 아래 명령어를 입력합니다. 재등록 하는 경우는 deregister-targets만 <code class=\"language-text\">register-targets</code> 로 바꿔주시면 됩니다 !</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">\\</span>\n--target-group-arn <span class=\"token punctuation\">[</span>대상 그룹의 arn<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--targets</span> <span class=\"token assign-left variable\">Id</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>트래픽을 중단할 EC2의 인스턴스 ID<span class=\"token punctuation\">]</span></code></pre></div>\n<p>여기서 대상 그룹의 arn은 사용하시는 대상 그룹 상세 페이지로 들어가면 ‘세부 정보’ 바로 아래 있는 arn으로 시작하는 값입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAR0lEQVQI153MMQ6AMAwEwfz/YZAvhIoQIL5Qu7Al65Ao6KEYbbeplIXTnCkCRgTN7OHub79Ia93Y9oNnF2Jc7AICg6r6a3oDlK+aaXA8yFsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3\"\n        title=\"3\"\n        src=\"/static/a04a037e70ad93430fcd01cf3cb848e0/37523/3.png\"\n        srcset=\"/static/a04a037e70ad93430fcd01cf3cb848e0/e9ff0/3.png 180w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/f21e7/3.png 360w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/37523/3.png 720w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/302a4/3.png 1080w,\n/static/a04a037e70ad93430fcd01cf3cb848e0/4352a/3.png 1364w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>ARN은 AWS 리소스의 고유 식별자입니다. 리소스를 명료하게 지정하는 경우 사용합니다.</p>\n</blockquote>\n<p>deregister 또는 register를 호출했을 때, aws 콘솔에 나오는 상태를 확인해 보겠습니다.</p>\n<table>\n<thead>\n<tr>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 676px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPUlEQVQoz5VS2W6DMBDk/z+rVR+bVKqSAEEp2EC4Ei4fEApTrVNSpVcUS+Nd2ePxej0WAASMYb3egDGOje1Aa03LmKYJ9wziW5SQ0GL5YqJtOxBCXAj3gIZ1GgYQxmlC3/cY3gcopSCkvAnddeg+QbmpsD+dkGY50ixD3TQo69rEW2jaFnGSIIwiBJyjqutzhaTsuC62ngep1IX8H4jTCoHX1QrPiyUeHp+QF8VZkCqk8qWShkS4JTjjfO6rPebJ4zjicCxRVjXKqjIgEglr3Zkfl1KZHimlTX9pX9G6UmafiqJ/MII0+YwjzQvskwwBD5EXByRphrWzBQ9j7PwAbz6D7XqG6+18sDDCPs1QHI5X1jGCdJhHMcIoxrGsrnw124EiveYv/82wxnFC0wojRLcJIX+Y+nv+m/9mH34Ar/EDvrlKxS8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4\"\n        title=\"4\"\n        src=\"/static/6c54a21335464d673632c715539c1b0e/9bb7a/4.png\"\n        srcset=\"/static/6c54a21335464d673632c715539c1b0e/e9ff0/4.png 180w,\n/static/6c54a21335464d673632c715539c1b0e/f21e7/4.png 360w,\n/static/6c54a21335464d673632c715539c1b0e/9bb7a/4.png 676w\"\n        sizes=\"(max-width: 676px) 100vw, 676px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABD0lEQVQoz5WR6W6DMBCE8/4vV0Vt/yQEAiaYKxzhsI0xU+0iqtI2lYo0Mtodf3v4AADLsiCMIggRIwiukDLFFv/PR/7D9nPxA5w9j4FCCDY45zj3mxzJuU/PDjhZCzvPmKYJ2hgordH1/Z8axpG9m3+DMnBUCt7Fh0xTPLoOTduifTyeqh8GxEmC17d3vByPKMr7vkMCRkKgKEsG0qXmCYyKkSfLc17T6eyhqus90Fq7tq4UV6dxaIyRT8UFv8tMBvM886ro7m5ka2ecPB9hFKOqG8g0wzUSyIuSY+KWIBQxZJrjXtUcjxO5xrKcwT9emapqvVY1xvDi6ez7AUppzlPXxkzQWmMYxjX35UEI+AEt32o6oeUC6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"5\"\n        title=\"5\"\n        src=\"/static/d162f6dad58d5039aa32e6b515b8f509/37523/5.png\"\n        srcset=\"/static/d162f6dad58d5039aa32e6b515b8f509/e9ff0/5.png 180w,\n/static/d162f6dad58d5039aa32e6b515b8f509/f21e7/5.png 360w,\n/static/d162f6dad58d5039aa32e6b515b8f509/37523/5.png 720w,\n/static/d162f6dad58d5039aa32e6b515b8f509/c8e86/5.png 758w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n</tr>\n</thead>\n</table>\n<ol>\n<li>deregister-targets를 호출 시, 왼쪽 사진처럼 드레이닝 상태가 되고, <strong>지정한 등록 취소 지연 시간이 지난 뒤 대상에서 사라집니다</strong>.</li>\n<li>그리고 등록 취소된 인스턴스를 register-targets로 재등록 요청시, 오른쪽 사진의 상태가 되고 <strong>최초의 헬스체크 통과시 다시 트래픽이 전달</strong>됩니다.</li>\n</ol>\n<p>이제 위 과정을 이용하여, 실제 등록 취소 과정을 테스트 해보겠습니다.</p>\n<br/>\n<h2 id=\"테스트\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트</h2>\n<h3 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h3>\n<table>\n<thead>\n<tr>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfklEQVQ4y5VUu26DQBDkC1Lk51LkP9JHqfMP6aJ06ZALP2SwLFkOEraR/GhT2paxwWDgbqLdC+S4BCKfNFpud29ud1iwAEBKySifhRCM0l9C9+tLP2+ZgWvWX/mWHsjzHN1uF8PhEL1ejzEej2HbNjqdDvr9Pu8Jg8EArusiTdMauWXedDgcsN1uGWEYIooi7HY7Bvn2+z1OpxOOxyOSJKlJRbD06kifa1ZRFBVqFRLRaDTCdDpFEATwfZ8ttTibzeA4DubzORaLBTzPY0noeTKZcPt0lgqqtXy5XFiPLMs4SPZ8PnNr1CIhjmPOo1bJUl65rypse7MUW61W2Gw2WC6XWK/XrbKwhrqgJszkpvlsncMyQC3TG02SVIupPH24zYsbCemQ0rOAELKCWVEr4a/P8MdbgWMNZI2fHtlCKIL3ALh/A+5egZeP7/kTuK5C1rBQhM+OxO2TxM2jxIOtfLlQev5bYZ1Y2TSX+AzBiDNZxZqmzWr/m5gaNhOVhF/UVNnB+jLdqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"6\"\n        title=\"6\"\n        src=\"/static/e54f55399153ea41927ed0e711e04350/37523/6.png\"\n        srcset=\"/static/e54f55399153ea41927ed0e711e04350/e9ff0/6.png 180w,\n/static/e54f55399153ea41927ed0e711e04350/f21e7/6.png 360w,\n/static/e54f55399153ea41927ed0e711e04350/37523/6.png 720w,\n/static/e54f55399153ea41927ed0e711e04350/f8067/6.png 726w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n<th><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 584px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABE0lEQVQoz61Ra0vEMBDs//81fpDDng9QKJ7idxHR0tajpaUFr02T5jWStak59QTRDcsms8kws4kAwFqLv4bniPxm0hOkltBGgysOoQWYZIQJJQhXRmOQjJJRHfAqdtDWLKSRmQnv2wecpKdYp+dYPcVIXjaI0zOsnuM517je3uCySHCRXeG2vEOy3eDo8Ri7qf8g9ApdfVeh9qwYWFpm3oUhjUL4niwvh/muNRaMMXDOKQUXlISNHOM4gg0DhBBf5rc3w2WW04SiKFBVFbquQ13XaJqGsLIsCc+yjHrhO1fJ8nc/9dufDSP63HSW8jwnZW3bLgodFip0eKjsIKHWGn3fE7Gz72fpZujS4b7/I+F/WX4Dd+4KX1IOpvoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"7\"\n        title=\"7\"\n        src=\"/static/084e2e8987ee4c762b73f7a5a0470cf6/e05eb/7.png\"\n        srcset=\"/static/084e2e8987ee4c762b73f7a5a0470cf6/e9ff0/7.png 180w,\n/static/084e2e8987ee4c762b73f7a5a0470cf6/f21e7/7.png 360w,\n/static/084e2e8987ee4c762b73f7a5a0470cf6/e05eb/7.png 584w\"\n        sizes=\"(max-width: 584px) 100vw, 584px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></th>\n</tr>\n</thead>\n</table>\n<blockquote>\n<p>사진의 페이지는 실제 배포가 되어있는 페이지입니다.</p>\n</blockquote>\n<p>왼쪽 사진의 페이지에서 입력한 시간(초) 만큼 <strong>Thread.sleep()</strong> 을 걸고, sleep이 끝나면 되면 오른쪽 사진의 페이지로 이동합니다.</p>\n<blockquote>\n</blockquote>\n<p>테스트는 다음 순서로 진행합니다.</p>\n<ol>\n<li><strong>등록 취소 지연 시간은 30초</strong>로 지정합니다.</li>\n<li>이 페이지에서 <strong>35초</strong>를 지정한 뒤 요청을 보냅니다.</li>\n<li>aws-cli에서 deregister-targets를 호출하여 등록 취소를 진행합니다.</li>\n</ol>\n<p>1번과 2번 작업 사이에 1초 정도가 소요되니, 여유있게 35초로 잡은 요청은 등록 취소 지연 시간을 초과하기 때문에 500번대 응답(502)이 올 것이라 기대할 수 있겠습니다.</p>\n<h3 id=\"결과\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EA%B3%BC\" aria-label=\"결과 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결과</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.222222222222221%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXklEQVQI10WNQRLAIAgD/f9DrSIgag96SgcO9pQws1nSWi9aE4gomDVStUPV0LvBbKIUwhgTIv0yfjvXiKPnXLD3QZpzgYgDvEL5hcOFD8FshLDWFozvPP2Zd89zDj7vPJeIur9hGAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"8\"\n        title=\"8\"\n        src=\"/static/571cc61191527d02704fc3623310ff50/37523/8.png\"\n        srcset=\"/static/571cc61191527d02704fc3623310ff50/e9ff0/8.png 180w,\n/static/571cc61191527d02704fc3623310ff50/f21e7/8.png 360w,\n/static/571cc61191527d02704fc3623310ff50/37523/8.png 720w,\n/static/571cc61191527d02704fc3623310ff50/cc155/8.png 886w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진처럼 19시 7분 <code class=\"language-text\">26초</code>에 deregister-targets을 호출했다면 30초 뒤인 <code class=\"language-text\">56초 이후</code>에 마무리되는 요청은 정상 응답이 나가지 않아야 하는데요, 실제 결과는 어떻게 되었을까요?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 632px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABFUlEQVQoz71PXU+DQBDk//8jH3ypoS2UkDZVkVRCoHB8lY/7EJ/KmF1DrcYn07jJ3sxNbvdmLNyopmlitIQu4JU+wvaAbb2HX20RtCGWuYOnU4CVcPHYPOOlDbnt3OH7rt5z38X3oB1U5+n8ufAhs+EWHtbChSs8BKcQq9zFWmywONqMjtjgtYvgVzv+nLs7YHFcojDVxaV188hEyCq1NhpSSSitML6PjObNMPZDD2MMBjnwG631ZW5exg7pmIW6rpGmKYQQ6LoOWZahaRrGOI5ZJ05YVV8x53l2+NPyX2Je1zeHSin0fc84jiOklByT7uSYYg7DwJy0Xx1eC0VRIM9zlGXJi4m3bcsRkyRhnbQoiv4v8gdDNAJzu0EhIAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"9\"\n        title=\"9\"\n        src=\"/static/ca56ea2cd482fe7d37eb3748875a7b6f/084e2/9.png\"\n        srcset=\"/static/ca56ea2cd482fe7d37eb3748875a7b6f/e9ff0/9.png 180w,\n/static/ca56ea2cd482fe7d37eb3748875a7b6f/f21e7/9.png 360w,\n/static/ca56ea2cd482fe7d37eb3748875a7b6f/084e2/9.png 632w\"\n        sizes=\"(max-width: 632px) 100vw, 632px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>25초에 요청을 받고 00초에 마무리 된 35초 지연 작업이 정상 응답을 반환하는 예상과 다른 결과가 나타났습니다..</p>\n<p>맨 위에서 작성한 공식 문서의 내용에 따르면 deregister-targets를 호출하여 인스턴스의 드레이닝이 진행되는 동안은 새로운 트래픽이 배분되지 않아야 하지만, 이 요청이 마무리가 되었다는 것은 deregister-targets 호출 이후에도 새로운 트래픽이 배분된 것이라고 생각할 수 있겠습니다.</p>\n<h3 id=\"원인-파악하기\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8-%ED%8C%8C%EC%95%85%ED%95%98%EA%B8%B0\" aria-label=\"원인 파악하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인 파악하기</h3>\n<p>이전에 예상했던 대로, deregister-targets 호출 이후에도 ELB가 트래픽을 배분하는지 확인해 보겠습니다. 로그를 조금 더 편하게 찍기 위해 위의 페이지와 동일한 기능을 하면서 요청 시간 / 완료 시간을 JSON으로 응답하는 API를 하나 추가하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">sendRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">sendRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token class-name\">WebClient</span> webClient <span class=\"token operator\">=</span> <span class=\"token class-name\">WebClient</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">baseUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"배포중인 도메인\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">LocalDateTime</span> requestTime <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\twebClient<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/shutdown-test-v2\"</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">bodyValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ShutdownRequest</span><span class=\"token punctuation\">(</span>requestTime<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">retrieve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">bodyToMono</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ShutdownResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>\n\t\t\tresult <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"request result: {}\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\terror <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"requestTime: {}, result: {}\"</span><span class=\"token punctuation\">,</span> requestTime<span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DATE_TIME_FORMATTER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t\terror<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>비동기 요청을 위해 WebClient를 사용하였습니다. WebClient 사용을 위해선 Spring Webflux 의존성 추가가 필요합니다 !</p>\n</blockquote>\n<p>테스트는 위 코드를 이용하여, 1초 단위로 요청을 계속 보내면서 deregister-targets 호출 이후 실제 요청이 들어가는지 확인해 보겠습니다. 테스트를 위해 <strong>등록 취소 지연 시간은</strong> 기존의 30초보다 짧은 <strong>10초</strong>로 지정하고, Thread.sleep()을 거는 <strong>딜레이도 동일한 10초</strong>로 지정하였습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABN0lEQVQoz21Ry5LDIAzL///i7mHbAOZhE0gaku5FHbvd2elMDxrACCFbU5UCIo/eBGsXLLWgSkZb2PZ9YbT63C+VsXXGWCNGT9heHOUqxr5i0kIkD+aEnAlEDsLRiCIJTQoWzhBOEMnYWsHoAaMFrPVZVwPKN8EujPn6gxBmOHdFCA5cokGJJsQJx9jwex84jx3HcRjOc7fa/dwNypmEM7yfEWMwp/N8MWE915fDWpK5Vq613Mmw1mKdvTnU3yM9XeUU4N3FkKJDCFeU6JHJg8IMCg6NHQZ/YfA3Kjnj6l2KHvutY9If1FGKwR6UTNaiDtnCKRmiI+CI29YwborFsG/NarqqmDnUlHVuOREoeAtGxTR1S17+Es72SOc0xmbrJ9gM1WFRQe/eUq7qNP0Ho21p3UT39SMep0xb+dLFCQ0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"10\"\n        title=\"10\"\n        src=\"/static/ae9fd88b4bd3766236deb19d03463490/37523/10.png\"\n        srcset=\"/static/ae9fd88b4bd3766236deb19d03463490/e9ff0/10.png 180w,\n/static/ae9fd88b4bd3766236deb19d03463490/f21e7/10.png 360w,\n/static/ae9fd88b4bd3766236deb19d03463490/37523/10.png 720w,\n/static/ae9fd88b4bd3766236deb19d03463490/302a4/10.png 1080w,\n/static/ae9fd88b4bd3766236deb19d03463490/07a9c/10.png 1440w,\n/static/ae9fd88b4bd3766236deb19d03463490/c0566/10.png 1544w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진은 실제 테스트 과정에서의 로그이고, 이 로그들을 조금 더 자세히 확인해 보겠습니다.</p>\n<ol>\n<li><strong>502 응답</strong></li>\n</ol>\n<p>우선 502 응답 부터 살펴보자면, 테스트에서 사용하는 API는 <strong>순수 Thread.sleep() 시간만 등록 취소 지연 시간과 동일한 10초</strong>이기에 실제 실행 시간은 10초를 초과합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAW0lEQVQI10WNSQ7AMAgD+/+PRglLIKRnV47U9oCQxgO+zBwihjkD7oGIBFlr/TARReaCqmEMhfuEqh8vZh7GvGqjd8HFI4aEa9U3fErplVlGxow+d9Xv730f/gD8bJgkch7JzgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"11\"\n        title=\"11\"\n        src=\"/static/4bdcd35acdbadfb1303e591e91a68e9c/37523/11.png\"\n        srcset=\"/static/4bdcd35acdbadfb1303e591e91a68e9c/e9ff0/11.png 180w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/f21e7/11.png 360w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/37523/11.png 720w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/302a4/11.png 1080w,\n/static/4bdcd35acdbadfb1303e591e91a68e9c/077b7/11.png 1166w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>따라서 nginx 로그를 살펴보면 이 요청에 대해서는 서버가 <code class=\"language-text\">499</code> 응답을 보낸 것으로 확인되고,</p>\n<blockquote>\n<p>499: 서버가 요청을 처리하고 <strong>응답을 보내기 전에 클라이언트가 서버에 대한 연결을 종료할 때 Nginx가 보내는</strong> 상태 코드. (출처: <a href=\"https://http-statuscode.com/ko/code/4XX/499-unofficial\">http-statuscode.com</a>)</p>\n</blockquote>\n<p>이는 서버가 응답을 보내기 전에 등록 취소 지연 시간이 지나 ELB와 서버간의 연결이 끊어졌기 때문이라고 할 수 있겠습니다. 실제로 등록 취소 지연을 기존과 동일한 10초로 했을 때, 테스트에 사용하는 딜레이만 9초로 낮춰도 502 응답은 나가지 않습니다 ㅎㅎ</p>\n<ol start=\"2\">\n<li><strong>503 응답</strong></li>\n</ol>\n<p>deregister-targets를 호출한 56분 58초부터 약 <strong>14초</strong> 뒤인 57분 12초부터의 요청은 모두 503 응답이 나갔는데요, 이때부터는 nginx 로그를 확인해도 해당 요청은 없는 바 이 시점부터 ELB의 트래픽 배분이 중지되었다고 판단할 수 있습니다.</p>\n<p>그러면 이 14초는 어떻게 산정된 값일까요?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAqUlEQVQI1y3OyU7DMAAA0fz/fyEhqFAQAZqoUFTb8b7W5TpIpod3m8NMvWa82XH2XwwWoyWpqDtJzJJUFcUZWvCUpolZEPJlNLnuXK+BWy9M1Xs+55llmVmPC9v6wet8QJiFH/3Cl3rivB8Q4Q29HonnCzptbOKBk3zke39Gunda8/SemXorOK2wVuGdJniDNYpSzf1OjIvSDNVbekq07sddHMRof29t+ANcmN5ypxZhEgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"12\"\n        title=\"12\"\n        src=\"/static/6924a674cfdfa9f04c1a77ed9762fe20/37523/12.png\"\n        srcset=\"/static/6924a674cfdfa9f04c1a77ed9762fe20/e9ff0/12.png 180w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/f21e7/12.png 360w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/37523/12.png 720w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/302a4/12.png 1080w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/07a9c/12.png 1440w,\n/static/6924a674cfdfa9f04c1a77ed9762fe20/7db30/12.png 1494w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>우선 위에 있는 헬스체크 로그를 보면 deregister-targets 호출 이후 3초, 8초 뒤에 헬스체크 요청이 왔는데, 이때의 응답은 모두 200이니 헬스체크는 연관이 없는 것 같습니다. 그래서 ‘<strong>deregister-targets 호출 이후에는 트래픽을 보내지 않는다고 하는데, 실제로 보내고 있다</strong>’ 라는 원론으로 돌아가서 생각해보니, 가장 유력하게 느껴지는 원인은 <strong>요청 이후 실제 ELB에 반영되는 시간</strong>인 것 같았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 modify-target-group <span class=\"token punctuation\">\\</span>\n--target-group-arn <span class=\"token punctuation\">[</span>대상 그룹의 arn<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n--health-check-interval-seconds <span class=\"token punctuation\">[</span>헬스체크 간격 시간<span class=\"token punctuation\">(</span>초<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>위의 코드는 AWS-CLI에서 헬스체크 간격을 수정하는 코드입니다. 이 코드를 호출해서 헬스체크 간격을 기존의 값인 5초에서 10초로 수정한 뒤 실제로 반영이 되는 시간을 확인 해 보겠습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAU0lEQVQI1zVNSQoAMQjr/59a3HXOGSL0ENRsHjOHiEHV4B7ILEQk7pXdRXR56gT95FUdEYXu2ds9t+cwTJAkqhozsyU0M/iePB91Tuoz307mmPkBHq+Yd3tiw0YAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"13\"\n        title=\"13\"\n        src=\"/static/9afb35a5aec6cccbc4b19b19d140bc7c/37523/13.png\"\n        srcset=\"/static/9afb35a5aec6cccbc4b19b19d140bc7c/e9ff0/13.png 180w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/f21e7/13.png 360w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/37523/13.png 720w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/302a4/13.png 1080w,\n/static/9afb35a5aec6cccbc4b19b19d140bc7c/393aa/13.png 1190w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArElEQVQI1z2Oy2rDMBQF8/8f1kJK2rjE7qJ1CUSWda8k6xV3OyUqdHVgOAxzuOeEF4vIgorF64rKQiqWLRu2vBDTjZQtVZWa9Z91Xiy5CrUFfvbKITthGs4Mw4npMvAxvjOObxi98G1fmJdjXyMjOs1EuXF1r3yaJ77MM9f1hMS5i7vwXhJRHd6vBO/YghCjUKqSyvpXUBylCC0E9pbI1fXKR/Xj01pk33MX/gJobt7IWdkK2wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"14\"\n        title=\"14\"\n        src=\"/static/99cd51298a76f6ab130b29da897ccef8/37523/14.png\"\n        srcset=\"/static/99cd51298a76f6ab130b29da897ccef8/e9ff0/14.png 180w,\n/static/99cd51298a76f6ab130b29da897ccef8/f21e7/14.png 360w,\n/static/99cd51298a76f6ab130b29da897ccef8/37523/14.png 720w,\n/static/99cd51298a76f6ab130b29da897ccef8/302a4/14.png 1080w,\n/static/99cd51298a76f6ab130b29da897ccef8/07a9c/14.png 1440w,\n/static/99cd51298a76f6ab130b29da897ccef8/a8c87/14.png 1538w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>헬스체크 간격 수정 명령어는 22분 16초에 호출했고, 위의 로그를 보면 31초까지는 5초 단위로 헬스체크 요청이 오고 이후부터 10초로 변경된 것을 확인할 수 있습니다. 초 단위까지만 측정하여 정확하지는 않지만 실제 변경까지는 대략 14~15초 정도 소요되고, 이 시간은 이전에 deregister-targets 호출 뒤 트래픽 중단까지 걸린 14초와 대략적으로 비슷한 시간임을 확인하였습니다.</p>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<p>aws-cli에서 제공하는 deregister 기능은 정상 작동하긴 하지만, 기대와 달리 실제 트래픽 중단까지는 약 14초가 소요되고, 헬스체크 간격 변경이 실제 반영될 때 까지 15초 정도가 소요되는 것을 보아 CLI에서의 요청 뒤 실제 ELB로의 반영까지는 대략 15초 전후의 시간이 걸린다고 예측할 수 있습니다.</p>\n<p>이제 마지막으로, 이걸 실제 배포 과정에 적용하는 과정과 CLI 요청 후 실제 ELB까지의 반영에 걸리는 시간 문제를 해결한 방법을 소개하겠습니다.</p>\n<br/>\n<h2 id=\"실제-배포에-적용하기\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%EC%A0%9C-%EB%B0%B0%ED%8F%AC%EC%97%90-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"실제 배포에 적용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실제 배포에 적용하기</h2>\n<h3 id=\"개요-1\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94-1\" aria-label=\"개요 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h3>\n<p>기존의 과정은 <strong>헬스체크 실패 API 호출 → 25초 sleep → 기존 스프링부트 종료 → 새로운 스프링부트 배포</strong> 순서로 진행됩니다. 스크립트 코드를 대략적으로 작성하면 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://localhost:8080/termination\n<span class=\"token function\">sleep</span> <span class=\"token number\">25</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인</code></pre></div>\n<p>수정할 과정은 deregister-targets 호출 → <strong>[실제 ELB까지 반영되어 트래픽이 전송되지 않을 때 까지 대기]</strong> → 기존 스프링부트 종료 → 새로운 스프링부트 배포 → register-targets 호출 순서로 진행됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws elbv2 deregister-targets <span class=\"token punctuation\">..</span>\n<span class=\"token punctuation\">[</span>실제 트래픽 중단까지 대기<span class=\"token punctuation\">]</span>\n\n<span class=\"token function\">kill</span> <span class=\"token punctuation\">[</span>기존 springboot<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">..</span> \nclone 및 gradle 빌드 등\n<span class=\"token punctuation\">..</span>\n\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token punctuation\">[</span>새로운 springboot<span class=\"token punctuation\">]</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET http://localhost:8080/health 반복 호출로 새로운 springboot가 정상적으로 실행되었는지 확인\n\naws elbv2 register-targets <span class=\"token punctuation\">..</span></code></pre></div>\n<p>그러면 새로운 과정에서 고려해볼 것은, 실제 트래픽 중단까지 대기하는 시간과 등록 취소 지연 시간이 되겠네요. 우선 등록 취소 지연 시간부터 살펴보겠습니다.</p>\n<h3 id=\"graceful-shutdown과-등록-취소-지연-설정\" style=\"position:relative;\"><a href=\"#graceful-shutdown%EA%B3%BC-%EB%93%B1%EB%A1%9D-%EC%B7%A8%EC%86%8C-%EC%A7%80%EC%97%B0-%EC%84%A4%EC%A0%95\" aria-label=\"graceful shutdown과 등록 취소 지연 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Graceful shutdown과 등록 취소 지연 설정</h3>\n<p>현재 Springboot의 graceful shutdown timeout은 기본값인 30초로 지정되어 있습니다.</p>\n<blockquote>\n<p>graceful shutdown: 지정한 timeout까지의 요청은 처리하고 애플리케이션을 종료하는 방법</p>\n</blockquote>\n<p>이전의 테스트 결과(502 응답이 나온 상황)로부터, 인스턴스가 마지막 요청을 받은 뒤 지정한 등록 취소 지연 시간이 지나면 애플리케이션이 요청을 처리해도 실제 응답까지 가지 않는다는 것을 확인하였습니다.</p>\n<p>즉, Graceful shutdown이 진행되는 동안 등록 취소 지연 시간이 지나면 이 응답은 사용자에게 가지 않을 것입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABLUlEQVQoz6WSSU/FMAyE+///GBcQXBAX0GN5eku3NEmbNmnjD1wo6xFLI9ujaGxrUvDPkF+5EBFyzmg2LlC2/gcq03NuHMeq41hbKuM5NY7doSW5HrxHNPfDqlHEGJmmiRAC4xQZp4R1Pc4PK5YZhiFS1xZjemLMpCgMY4Z9CQ8vyP0j8ryHJVPM80xrDMZ0pJQYxxHnHOdTiQuWNpXYpcFJi8st3VJjUkmXW6rdNfXdBeyekZcDkjOFigwhMAwBFdfeOb8O8MHhZ0vdl5y64wqtferoc499vMXeXYJu+LRHdEM9WUX07GVZEMkop+Ka18ggi6zQeuNoLBxrqBqkNaAbbqZsxqxvv/Ub92Xrez+dS7qrG6IKfbisKP58g18Cm+h3bHxO6XPIyr+5/Aohb29Nqs/GzwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"15\"\n        title=\"15\"\n        src=\"/static/87deef86bc83d72b64d067dbeb3e6765/37523/15.png\"\n        srcset=\"/static/87deef86bc83d72b64d067dbeb3e6765/e9ff0/15.png 180w,\n/static/87deef86bc83d72b64d067dbeb3e6765/f21e7/15.png 360w,\n/static/87deef86bc83d72b64d067dbeb3e6765/37523/15.png 720w,\n/static/87deef86bc83d72b64d067dbeb3e6765/302a4/15.png 1080w,\n/static/87deef86bc83d72b64d067dbeb3e6765/07a9c/15.png 1440w,\n/static/87deef86bc83d72b64d067dbeb3e6765/24def/15.png 1812w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>위 그림에서의 화살표 길이는 등록 취소 지연 시간 및 graceful shutdown timeout 시간이라고 생각해주세요!</p>\n</blockquote>\n<p>그림으로 살펴보면 대략 이런 느낌인데요, 만약 Graceful shutdown timeout이 등록 취소 지연 시간보다 길어진다면 실제 Springboot는 요청을 처리했지만 이 응답이 사용자에게 가지는 않습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABIklEQVQoz5WS2W7DIBBF8/+fV6lvWZylieMQ2wWD2U/rLUrTvnTQFQyCw3JnlXNm0X/j146cWT3nxnp07zH91E9y47xx4ZGLtsNaDymRYyTHNMKGWHnviTFiraVVPaJViEYiGsW91UjlOJc1p4tA1ArVOa51jykF7A7k4kg+fEAIE3AAfUqJlGo8JQSPlBKlFL3XBCw2GmzU+GzxuUfSEGsB64K83U/QBRhC4F43qK7DOYfWhmt1o6oEwly5mBP7ZkvRbCjqDRd9ZNuvMbczrPfkTUHeHX7ecHi2MWY0ZjhgAA+KIU1/HYE0a4lWkoabnUsoq/EvR+AASSmNWtx+zSc/89wgaI18e6c/nWdz53WvLv9ZGk9l9VxeybnH+FFy38AvRkJw2bwLu3IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"16\"\n        title=\"16\"\n        src=\"/static/70251bd296b51d4be42936593c8fdc16/37523/16.png\"\n        srcset=\"/static/70251bd296b51d4be42936593c8fdc16/e9ff0/16.png 180w,\n/static/70251bd296b51d4be42936593c8fdc16/f21e7/16.png 360w,\n/static/70251bd296b51d4be42936593c8fdc16/37523/16.png 720w,\n/static/70251bd296b51d4be42936593c8fdc16/302a4/16.png 1080w,\n/static/70251bd296b51d4be42936593c8fdc16/07a9c/16.png 1440w,\n/static/70251bd296b51d4be42936593c8fdc16/c6720/16.png 1922w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>따라서 Springboot의 종료는 위 그림처럼 등록 취소 지연 시간이 지나기 전에 마무리가 되어야 하며, 마지막 요청 수신과 기존의 springboot의 종료가 순서대로 진행되니 <strong>graceful shutdown timeout은 등록 취소 지연 시간보다 작거나 같게 설정</strong>해야 합니다.</p>\n<h3 id=\"실제-트래픽-중단까지-대기---시간-지정\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%EC%A0%9C-%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%A4%91%EB%8B%A8%EA%B9%8C%EC%A7%80-%EB%8C%80%EA%B8%B0---%EC%8B%9C%EA%B0%84-%EC%A7%80%EC%A0%95\" aria-label=\"실제 트래픽 중단까지 대기   시간 지정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실제 트래픽 중단까지 대기 - 시간 지정</h3>\n<p>이제 이전의 개요에 있던 <strong>실제 트래픽 중단까지 대기</strong>만 잘 하면 되겠네요. 제가 사용할 방법은, <strong>실제 데이터를 측정한 뒤 나온 통계량을 이용해서 적절한 대기 시간을 거는 방법</strong>입니다.</p>\n<blockquote>\n<p>사실 이 방법은 본문을 작성하며 진행한 수십 번의 테스트에서 시작되었습니다ㅎㅎ 매번 확인하다 보니 자연스레 ‘15초를 초과하지 않을 것이다’ 라는 가설 검증의 과정으로 진행 되더라구요</p>\n</blockquote>\n<p>우선 통계량을 구하기 위해 테스트를 진행하겠습니다. 테스트는 deregister-targets 명령어 호출 이후 0.1초 단위로 요청을 보내고 503 응답이 나올 때 까지의 시간을 기록하는 순서로 진행하며, 총 30회 수행합니다. 아래 그래프는 이 작업을 총 30회 시도했을 때의 분포입니다.</p>\n<blockquote>\n<p>30회는 보통 정규분포를 가정할 때 사용하는 최소 표본 수입니다.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACZklEQVQ4y42SS2sTURiG80PUKgheigv/gLgXV6ILXRVcxYq2Cm67U1RaKGJFBLGIlxqaTBQa4yW22MTYapVQxVwmY25Nk0lmkjmTyW3mlXMmM5kQKx745tzmPOf9vve4AKDVaoHneaRSKRQKBSSTSeRyOSQSCRZp4TcSyRQLQRCQzWYRj8fZ2OolSaIouOin3W5DFEXUajUoigJZlllPo0HqqBRzKG9loNaqaDQaIITY+zTq9To7YwOr1SqD/q3x2wru+KK4y0Xx6nMKOzVN0/pAemuz2WQLhmGw6HR1Nn/ykcfeiz7sv8Th5M0QWp0uW9d7/1mhqupgyrSOFpC2rm72LyICDk34cOSqH2dmltHuXWSBrDEVNQB0KnQCFyICDlz2YfSKH6en/wNIC0wnOynsAzkH0LBTHgIWi0XmlGXKP4Ezy44ammEptYG6rjN1ToVOU5wpn5r+wNYachlEKkNvEtuggRpShyzbewKh957DQiTNgIcnOZydXUG6RHD9eRi3PJ/w8O0mmh2zBEMuW6ZA76BWKUGRKzRxeKIZBjw44cPY3CoC3/LY5V5kz+jYVBCiYp4jTiA1RtPMjXhewvzrdTwLxfCd34ZvPWcrHJsLI7RZxOgkh6PXXuLEjXeQVLNUqupImapTiHnDbX8MI+Ne7L7gxfl7YXijAva4Pdg3vohzsytY2shixO1hio9PBVCSVcDQoSikD6TG0Bs6rSZ+ZkQ8frOB+9wqwj+y4LeqmA9+xaPAFwTXfiEv1vH0fQwP/GEsrSWhqA1Wf61XMpf1TIabYfdErkAWi2hrxLGvD58wDPwBAxw/lQEWshIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"17\"\n        title=\"17\"\n        src=\"/static/1e483b678913d034e0220a30fe56db54/37523/17.png\"\n        srcset=\"/static/1e483b678913d034e0220a30fe56db54/e9ff0/17.png 180w,\n/static/1e483b678913d034e0220a30fe56db54/f21e7/17.png 360w,\n/static/1e483b678913d034e0220a30fe56db54/37523/17.png 720w,\n/static/1e483b678913d034e0220a30fe56db54/302a4/17.png 1080w,\n/static/1e483b678913d034e0220a30fe56db54/0d0e4/17.png 1230w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>대부분의 결과가 13초 이내이고 최대값은 13.46초로 아무리 늦어도 13.5초 내에는 트래픽이 중단됩니다. 위 표본이 정규성이 있는지 조금더 확실하게 하기 위해 <a href=\"https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test\">Shapiro-Wilk 정규성 검증</a>을 진행해 보겠습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABZ0lEQVQoz0WRbW+bMBSF+f//ato0LWtarXljkASCMWAbY0q68NIoeiaTqvlwpHPPvb629QRn946tG2QlUabivb7QNyNaa1rnmMaJcRyZZt39ox4Zh0ev73sCoTJ26ZZUCVKdI2tFYRXtuZt9bips6yitJlUS4yx12yB0SWUN9s2R6YJMl7x1HUHXdbjGcT7/I5YnnuINz/GWTBU87TdznRSCdRrzY/dCnKdEecrysGV72pOUYp77Ha9RtSGYnz9N9EPPThz5Fa1Y/F2RVjmLT38sMlZpxPfdC5FICEXCz/APy/2WYyFYxGu+bZZUfqH/t9elv5BUOa9JRJgdkUaxPsXssgNSV4R5MvdyXXEsBa9pxEFmX3PP+5Cm7QhaZ9BKcToJyrIgFwJtLKMHMNwBDMPwgDIMs6ZPOHc/8TF93KE451BKYYzBWktd1/jMU5aFRAh/UTlnvu9zn3kVZTGfu16v3G63Wf8BOrkHuv8b11IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"18\"\n        title=\"18\"\n        src=\"/static/f99d8a3578e97d4daa558c51b825b016/37523/18.png\"\n        srcset=\"/static/f99d8a3578e97d4daa558c51b825b016/e9ff0/18.png 180w,\n/static/f99d8a3578e97d4daa558c51b825b016/f21e7/18.png 360w,\n/static/f99d8a3578e97d4daa558c51b825b016/37523/18.png 720w,\n/static/f99d8a3578e97d4daa558c51b825b016/302a4/18.png 1080w,\n/static/f99d8a3578e97d4daa558c51b825b016/d4e7f/18.png 1416w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>테스트를 했을 때 P-value는 0.068( > 0.05)로 이 데이터는 정규성을 가진다고 판단할 수 있고, 이 분포를 정규분포로 가정하여 확률을 계산해보면 트래픽 중단까지의 시간이 <strong>14초를 초과할 확률은 0.16%</strong>, <strong>15초를 초과할 확률은 0.000021%</strong> 가 나옵니다.</p>\n<p>따라서 AWS의 서비스 안정성을 고려하면 이상치가 나올 가능성이 매우 적다는 판단과 더불어, deregister-targets 호출 이후 아무리 길어도 15초 뒤에는 트래픽이 중단될 것이라고 생각하였기에, <code class=\"language-text\">sleep 15</code>를 호출하여 트래픽이 중단될 때 까지 기다리는 방식으로 해결했습니다.</p>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>글이 꽤나 길어졌네요..ㅎㅎ 그래서 일단 간단하게 요약해 보겠습니다.</p>\n<ol>\n<li>팀원이 구현한 API를 호출하여 헬스체크에 실패하도록 하는 방법은 좋은 방법이고, 현재는 IAM 권한 문제로 이 방법이 최선입니다.</li>\n<li>하지만 API를 사용하는데에서 오는, 배포와 애플리케이션의 의존에서의 불확실성이 존재하긴 합니다.</li>\n<li>AWS-CLI의 deregister-targets을 이용하여 ELB가 트래픽을 중단하도록 할 수 있습니다. 이 경우 등록 취소 지연(deregistration delay)를 springboot의 graceful-shutdown tiimeout보다 같거나 크게 설정해야 합니다.</li>\n<li>deregister-targets를 호출해도 실제 ELB에 반영되어 트래픽이 중지될 때 까지는 약 15초정도가 소요되며, 30회 측정 후 통계량을 구한 결과를 바탕으로 계산했을 때 15초를 초과할 확률은 매우 낮습니다. 따라서 deregister-targets 명령어 호출 이후 15초를 대기합니다.</li>\n</ol>\n<p>이전 글도 그렇고, 이번 글도 그렇고 코드 리뷰를 하며 남긴 “Deregistration delay를 도입할 수 있지 않을까?” 라는 댓글에서 시작했습니다. 저도 이런 개념이 있다 정도만 얼핏 봤지 실제로 적용해본 방법은 아니었는데요, 처음부터 하나씩 알아가다보니 많은 시간이 쓰이긴 했지만 그만큼 의미있고 보람찬 작업이었던 것 같습니다 ㅎㅎ</p>\n<p>복잡하고 긴 내용이지만 여기까지 읽어주셔서 감사합니다 😄</p>","frontmatter":{"date":"November 11, 2024","title":"무중단 배포 과정에서의 불확실성 개선[1] - AWS CLI를 이용한 등록 취소","categories":"level4 aws deregister","author":"이상진","emoji":"🖥"},"fields":{"slug":"/woowacourse/level4/improving_deployment/2/"}},"site":{"siteMetadata":{"siteUrl":"https://pricelees.github.io","comments":{"utterances":{"repo":"pricelees/pricelees.github.io"}}}}},"pageContext":{"slug":"/woowacourse/level4/improving_deployment/1/","nextSlug":"/woowacourse/level4/check_client_ip/","prevSlug":"/woowacourse/level4/improving_deployment/2/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}